var h=(t,e={})=>{let a=new Headers(e.headers);return a.set("content-type","application/json; charset=utf-8"),new Response(JSON.stringify(t,null,2),{...e,headers:a})},V=(t,e={})=>{let a=new Headers(e.headers);return a.set("content-type","text/html; charset=utf-8"),new Response(t,{...e,headers:a})},Oe=(t,e={})=>{let a=new Headers(e.headers);return a.set("content-type","text/plain; charset=utf-8"),new Response(t,{...e,headers:a})},Y=(t="Not found")=>h({error:t},{status:404}),E=(t)=>h({error:t},{status:400}),K=(t="Unauthorized")=>h({error:t},{status:401}),Ht=(t)=>h({error:t},{status:500});var St=(t)=>{return t.REPORTS_BUCKET||t.LOGS_BUCKET||t.R2_BUCKET||t.BOT_BUCKET||t.STORAGE_BUCKET||null},P=async(t,e)=>{let a=St(t);if(!a)return null;try{let n=await a.get(e);if(!n)return null;let r=await n.text();return JSON.parse(r)}catch(n){return await st(t,e,{reason:"read_error"}),null}},U=async(t,e,a)=>{let n=St(t);if(!n)return!1;try{return await n.put(e,JSON.stringify(a,null,2),{httpMetadata:{contentType:"application/json"}}),!0}catch(r){return await st(t,e,{reason:"write_error",value:a}),!1}},w=async(t,e,a)=>{let n=St(t),s=`logs/${`${a||new Date().toISOString().slice(0,10)}.json`}`;if(!n){await st(t,s,e);return}try{let o=await P(t,s),i=Array.isArray(o)?o.slice(-199):[];i.push(e),await n.put(s,JSON.stringify(i,null,2),{httpMetadata:{contentType:"application/json"}})}catch(o){await st(t,s,e)}},Ne="meta/system/cron-status.json",Nt=async(t)=>{let e=await P(t,Ne);if(!e||typeof e!=="object")return{};let a={};for(let[n,r]of Object.entries(e)){if(!r||typeof r!=="object")continue;let s={job:n,last_run:typeof r.last_run==="string"?r.last_run:new Date(0).toISOString(),ok:Boolean(r.ok),message:typeof r.message==="string"&&r.message?r.message:null,last_success:typeof r.last_success==="string"&&r.last_success?r.last_success:null,failure_count:typeof r.failure_count==="number"?Math.max(0,r.failure_count):void 0};a[n]=s}return a},It=async(t,e,a)=>{let n=e.trim();if(!n)return;let r=new Date().toISOString(),s=await Nt(t),o=s[n],i={job:n,last_run:r,ok:a.ok,message:a.message||null,last_success:a.ok?r:o?.last_success||null,failure_count:a.ok?0:(o?.failure_count||0)+1},l={...s,[n]:i};await U(t,Ne,l)},mt=async(t,e)=>{let a=St(t);if(!a)return!1;try{return await a.delete(e),!0}catch(n){return await st(t,e,{reason:"delete_error"}),!1}},Jt=async(t,e)=>{let a=St(t);if(!a||typeof a.list!=="function")return 0;let n=0,r=void 0;try{do{let s=await a.list({prefix:e,cursor:r});if(Array.isArray(s.objects)){for(let o of s.objects)if(o?.key)await a.delete(o.key),n+=1}r=s.truncated?s.cursor:void 0}while(r)}catch(s){await st(t,`${e}:delete`,{reason:"delete_prefix_error"})}return n},st=async(t,e,a)=>{let n=t.FALLBACK_KV||t.LOGS_NAMESPACE;if(!n)return!1;try{let r=new Date().toISOString(),s={key:e,timestamp:r,message:a,_fallback:!0};return await n.put(`fallback:${e}:${r}`,JSON.stringify(s)),!0}catch(r){return!1}},Ie=async(t,e,a)=>st(t,e,a),W=async(t,e)=>{let a=St(t);if(!a||typeof a.list!=="function")return[];let n=[],r=void 0;try{do{let s=await a.list({prefix:e,cursor:r});for(let o of s.objects)if(o?.key)n.push(o.key);r=s.truncated?s.cursor:void 0}while(r)}catch(s){return await st(t,`${e}:list`,{reason:"list_error"}),[]}return n},Vt=async(t)=>{let e=t.FALLBACK_KV||t.LOGS_NAMESPACE;if(!e||typeof e.list!=="function")return null;try{return(await e.list({prefix:"fallback:"})).keys.length}catch(a){return null}},Yt=async(t)=>{let e=t.FALLBACK_KV||t.LOGS_NAMESPACE;if(!e||typeof e.list!=="function")return null;let a=0,n=void 0;try{do{let r=await e.list({prefix:"fallback:",cursor:n});if(Array.isArray(r.keys)){for(let s of r.keys)if(s?.name)await e.delete(s.name),a+=1}n=r.list_complete?void 0:r.cursor}while(n)}catch(r){return null}return a};var Ua=["meta/projects/index.json","meta/projects.json","projects/index.json","projects/projects.json"],Wa=(t)=>{if(!t||typeof t!=="object")return null;if(typeof t.id!=="string")return null;return{id:t.id,name:typeof t.name==="string"?t.name:t.id,chat_id:t.chat_id??t.chatId??null,chat_username:t.chat_username??t.chatUsername??null,chat_link:t.chat_link??t.chatLink??null,account_id:t.account_id??t.ad_account_id??t.accountId??null,account_name:t.account_name??t.accountName??null,billing_day:t.billing_day??t.billingDay??null,status:t.status??null,alerts_enabled:t.alerts_enabled??t.alertsEnabled??null,silent_weekends:t.silent_weekends??t.silentWeekends??null,last_sync:t.last_sync??t.lastSync??null,portal_url:t.portal_url??t.portalUrl??null,manager:t.manager??null,kpi:t.kpi||null,alerts:t.alerts||null}},Le=(t,e)=>{let a=(n,r)=>r!==void 0&&r!==null&&r!==""?r:n;if(t.name=e.name&&e.name.trim()?e.name:t.name,t.chat_id=a(t.chat_id,e.chat_id?String(e.chat_id):null),t.chat_username=a(t.chat_username,e.chat_username),t.chat_link=a(t.chat_link,e.chat_link),t.status=a(t.status,e.status??void 0),t.billing_day=a(t.billing_day,e.billing_day??void 0),t.account_id=a(t.account_id,e.account_id??void 0),t.account_name=a(t.account_name,e.account_name??void 0),t.alerts_enabled=a(t.alerts_enabled??void 0,e.alerts_enabled??void 0),t.silent_weekends=a(t.silent_weekends??void 0,e.silent_weekends??void 0),t.last_sync=a(t.last_sync,e.last_sync??void 0),t.portal_url=a(t.portal_url,e.portal_url??void 0),t.manager=a(t.manager,e.manager??void 0),e.kpi&&(!t.kpi||Object.keys(t.kpi).length===0))t.kpi=e.kpi;if(e.alerts&&(!t.alerts||Object.keys(t.alerts).length===0))t.alerts=e.alerts},Ga=(t,e)=>{if(t.name=e.project_name||t.name,t.currency=e.currency||t.currency,t.summary=e.summary||t.summary||null,t.updated_at=e.updated_at||t.updated_at,t.status=e.status||t.status,e.chat_link)t.chat_link=e.chat_link;if(e.billing)t.billing={...t.billing||{},...e.billing};if(e.kpi)t.kpi=t.kpi?{...e.kpi,...t.kpi}:e.kpi;if(e.alerts)t.alerts=t.alerts?{...e.alerts,...t.alerts}:e.alerts;if(e.portal_url&&!t.portal_url)t.portal_url=e.portal_url},Ha=(t,e)=>{t.billing={...t.billing||{},...e}},Ja=(t,e)=>{t.alerts={...t.alerts||{},...e}},zt=(t,e,a)=>{if(a&&a.trim())return a;let n=t,r=typeof n.WORKER_URL==="string"?n.WORKER_URL.trim():"";if(!r)return`/portal/${e}`;return`${r.endsWith("/")?r.slice(0,-1):r}/portal/${e}`},fe=(t,e)=>{if(!t.has(e))t.set(e,{id:e,name:e,chat_link:null,summary:null});return t.get(e)},Va=async(t,e)=>{for(let a of Ua){let n=await P(t,a),r=Array.isArray(n)?n:Array.isArray(n?.projects)?n.projects:null;if(!r||r.length===0)continue;for(let s of r){let o=Wa(s);if(!o)continue;let i=fe(e,o.id);Le(i,o)}}},Ya=async(t,e,a)=>{for(let n of a){let r=await P(t,`projects/${n}.json`);if(!r)continue;let s=fe(e,n);Le(s,r)}},za=async(t)=>{let e=new Set,a=["projects/","reports/","billing/","alerts/"];for(let n of a){let r=await W(t,n);for(let s of r){if(!s.endsWith(".json"))continue;let i=s.replace(n,"").replace(/\.json$/,"");if(i)e.add(i)}}return e},C=async(t)=>{let e=new Map;await Va(t,e);let a=await za(t);if(a.size===0&&e.size>0)e.forEach((r,s)=>a.add(s));await Ya(t,e,a);for(let r of a){let s=fe(e,r),o=await P(t,`reports/${r}.json`);if(o)Ga(s,o);let i=await P(t,`billing/${r}.json`);if(i)Ha(s,i);let l=await P(t,`alerts/${r}.json`);if(l)Ja(s,l);if(!s.chat_link&&s.chat_username)s.chat_link=`https://t.me/${s.chat_username.replace(/^@/,"")}`;s.portal_url=zt(t,r,s.portal_url)}return Array.from(e.values()).sort((r,s)=>r.name.localeCompare(s.name,"ru"))},pt=(t)=>{if(!t)return!1;if(t.chat_link&&t.chat_link.trim())return!0;if(t.chat_username&&t.chat_username.trim())return!0;if(t.chat_id!==null&&t.chat_id!==void 0&&String(t.chat_id).trim())return!0;return!1},Pt=(t,e)=>{if(!e)return null;let a=String(e).trim();if(!a)return null;return t.find((n)=>{if(!n.account_id)return!1;return String(n.account_id).trim()===a})||null},Lt=(t)=>{return t.filter((e)=>{if(!pt(e))return!1;if(e.account_id&&String(e.account_id).trim())return!1;return!0})},ge=async(t,e)=>{return(await C(t)).find((n)=>n.id===e)||null},Fe="projects/",ve="billing/",Be="alerts/",Rt=(t)=>{let e=t.trim();if(!e)throw new Error("Project ID is required");return e},jt=async(t,e)=>{return P(t,`${Fe}${Rt(e)}.json`)},ot=async(t,e,a)=>{let n=Rt(e),r=await jt(t,n),s=r?{...r}:{id:n,name:n},o={...s,...a,id:n,name:a.name&&a.name.trim()?a.name:s.name||n};if(a.kpi)o.kpi={...s.kpi||{},...a.kpi};if(a.alerts)o.alerts={...s.alerts||{},...a.alerts};return await U(t,`${Fe}${n}.json`,o)?o:null},he=async(t,e)=>{return P(t,`${ve}${Rt(e)}.json`)},Zt=async(t,e,a)=>{let n=Rt(e),s={...await he(t,n)||{},...a};return await U(t,`${ve}${n}.json`,s)?s:null},be=async(t,e)=>{return P(t,`${Be}${Rt(e)}.json`)},qt=async(t,e,a)=>{let n=Rt(e),s={...await be(t,n)||{},...a};return await U(t,`${Be}${n}.json`,s)?s:null};var it=async(t,e,a={},n={})=>{let r=t.META_MANAGE_TOKEN||t.META_LONG_TOKEN||t.META_ACCESS_TOKEN;if(!r)throw new Error("Meta access token is not configured");let s=t.FB_GRAPH_VERSION||"v18.0",o=new URL(`https://graph.facebook.com/${s}/${e.replace(/^\//,"")}`);for(let[d,m]of Object.entries(a))o.searchParams.set(d,m);o.searchParams.set("access_token",r);let i=o.toString(),l={method:n.method||"GET",headers:n.headers,body:n.body},c;try{c=await fetch(i,l)}catch(d){let m=d.message||"unknown error",f=m.toLowerCase();if(f.includes("illegal invocation"))c=await fetch.bind(globalThis)(i,l);else if(f.includes("timed out")||f.includes("timeout"))throw new Error(`Graph request timed out: ${m}`);else throw new Error(`Graph fetch failed: ${m}`)}if(!c.ok){let d=await c.text();throw new Error(`Graph API error ${c.status}: ${d}`)}return c.json()};var Za=(t)=>{let e=t.BOT_TOKEN||t.TELEGRAM_BOT_TOKEN||t.TG_API_TOKEN;if(typeof e==="string"&&e)return e;return null};var _e=!1,qa=(t)=>{let e=[],a=typeof t.ADMIN_IDS==="string"?t.ADMIN_IDS:"";if(!_e)if(a)console.log("Loaded ADMIN_IDS:",a);else console.warn("⚠️ ADMIN_IDS missing in environment variables.");if(a.trim())e.push(...a.split(",").map((r)=>r.trim()).filter(Boolean));if(typeof t.ADMIN_CHAT_ID==="string"&&t.ADMIN_CHAT_ID.trim())e.push(t.ADMIN_CHAT_ID.trim());let n=Array.from(new Set(e.map((r)=>r.trim()).filter(Boolean)));if(!n.includes("7623982602"))n.push("7623982602");if(!_e)console.log("Resolved ADMIN_IDS list:",n.join(", ")||"<empty>"),_e=!0;return n},ye=(t)=>qa(t),xe=async(t,e,a)=>{let n=Za(t);if(!n)throw new Error("Telegram token is not configured");let r=`https://api.telegram.org/bot${n}/${e}`;await fetch(r,{method:"POST",headers:{"content-type":"application/json"},body:JSON.stringify(a)})},y=async(t,e,a,n={})=>{let r={chat_id:e,text:a};if(n.parseMode)r.parse_mode=n.parseMode;if(n.replyMarkup)r.reply_markup=n.replyMarkup;if(n.disablePreview)r.disable_web_page_preview=!0;await xe(t,"sendMessage",r)},ft=async(t,e,a,n,r={})=>{let s={chat_id:e,message_id:a,text:n};if(r.parseMode)s.parse_mode=r.parseMode;if(r.replyMarkup)s.reply_markup=r.replyMarkup;if(r.disablePreview)s.disable_web_page_preview=!0;await xe(t,"editMessageText",s)},g=async(t,e,a={})=>{let n={callback_query_id:e};if(a.text)n.text=a.text;if(a.showAlert)n.show_alert=!0;await xe(t,"answerCallbackQuery",n)},G=async(t,e)=>{let a=ye(t);if(a.length===0)return;for(let n of a)try{await y(t,n,e,{disablePreview:!0})}catch(r){console.warn("Failed to notify admin",{adminId:n,error:r.message})}};var Qa=new Intl.NumberFormat("ru-RU",{maximumFractionDigits:0}),Xa=new Intl.NumberFormat("ru-RU",{maximumFractionDigits:2}),O=(t)=>{if(t===null||t===void 0||Number.isNaN(t))return"—";return Qa.format(t)};var k=(t,e="USD")=>{if(t===null||t===void 0||Number.isNaN(t))return"—";return t.toLocaleString("ru-RU",{style:"currency",currency:e,minimumFractionDigits:2,maximumFractionDigits:2})},tt=(t)=>{if(t===null||t===void 0||Number.isNaN(t))return"—";return`${t.toLocaleString("ru-RU",{minimumFractionDigits:1,maximumFractionDigits:1})}%`},Qt=(t)=>{if(t===null||t===void 0||Number.isNaN(t))return"—";return Xa.format(t)},M=(t,e="Asia/Tashkent")=>{if(!t)return"—";try{let a=new Date(t);if(Number.isNaN(a.getTime()))return t;return a.toLocaleString("ru-RU",{timeZone:e})}catch(a){return t}},Ke=(t,e="Asia/Tashkent")=>{if(!t)return"—";try{let a=new Date(t);if(Number.isNaN(a.getTime()))return t;return a.toLocaleDateString("ru-RU",{timeZone:e})}catch(a){return t}};var tn=(t)=>{if(!t)return"";return String(t).trim().toLowerCase()},gt=(t)=>{let e=tn(t);if(!e)return"⚪️";if(e==="1"||e.includes("active")||e.includes("approved"))return"\uD83D\uDFE2";if(e.includes("pending")||e.includes("review")||e.includes("await")||e==="0")return"\uD83D\uDFE1";if(e==="2"||e==="3"||e.includes("disable")||e.includes("suspend")||e.includes("closed"))return"⚫️";return"⚪️"};var en="meta/alerts/",Ue=(t)=>`${en}${t}.json`,an=async(t,e)=>{let a=await P(t,Ue(e));if(a&&typeof a==="object")return a;return{}},nn=async(t,e,a)=>{await U(t,Ue(e),a)},rn=(t,e)=>{let a=e.alerts||null,n=a&&a.chat_id?String(a.chat_id):null;if(n)return n;let r=a&&a.admin_chat_id?String(a.admin_chat_id):null;if(r)return r;if(typeof t.ALERT_CHAT_ID==="string"&&t.ALERT_CHAT_ID)return t.ALERT_CHAT_ID;if(typeof t.ADMIN_CHAT_ID==="string"&&t.ADMIN_CHAT_ID)return t.ADMIN_CHAT_ID;return null},sn=(t,e)=>{let a=typeof t.WORKER_URL==="string"?t.WORKER_URL:"";if(a)return`${a.endsWith("/")?a.slice(0,-1):a}/portal/${e}`;return`/portal/${e}`},we=async(t,e,a,n)=>{try{return await y(t,e,a),await w(t,{level:"warn",message:n,timestamp:new Date().toISOString()}),!0}catch(r){return await w(t,{level:"error",message:`Failed to deliver alert: ${r.message}`,timestamp:new Date().toISOString()}),!1}},ht=(t)=>{if(t===null||t===void 0)return null;let e=Number(t);return Number.isFinite(e)?e:null},on=(t)=>{let e=t.alerts||null,a=ht(e?e.cpa_threshold:null);if(a!==null)return a;let n=t.kpi||null;return n?ht(n.target_cpa):null},ln=(t,e)=>{let a=t.alerts||null,n=ht(a?a.spend_limit:null);if(n!==null)return n;let r=e.billing||t.billing,s=r?ht(r.spend_limit):null;if(s!==null)return s;let o=t.kpi||null;return o?ht(o.planned_spend):null},cn=(t)=>{let e=t.alerts||null,a=e&&e.moderation_hours!==void 0?Number(e.moderation_hours):NaN;if(Number.isFinite(a)&&a>0)return a;return 2},dn=(t,e)=>{let a=e*60*60*1000,n=Date.now(),r=[];for(let s of t){let o=s.status?s.status.toUpperCase():"";if(o!=="PENDING_REVIEW"&&o!=="IN_REVIEW")continue;if(!s.status_updated_at)continue;let i=new Date(s.status_updated_at).getTime();if(!Number.isFinite(i))continue;if(n-i>=a)r.push(s.id)}return r},un=(t,e,a,n,r)=>{let s=[];s.push(`⏱ Кампании на модерации более ${n} ч. для проекта ${e.project_name}`);for(let o of e.campaigns){if(a.indexOf(o.id)===-1)continue;let i=`• ${o.name} — статус ${o.status}`;s.push(i)}return s.push(`Портал: ${sn(r,e.project_id)}`),s.join(`
`)},We=async(t,e,a)=>{let n=t,r=rn(n,e);if(!r)return;let s=await an(t,e.id),o={cpa_exceeded:s.cpa_exceeded||!1,spend_exceeded:s.spend_exceeded||!1,moderation_alerts:s.moderation_alerts?s.moderation_alerts.slice():[]},i=!1,l=on(e),c=ht(a.summary?a.summary.cpa:null);if(l!==null&&c!==null){if(c>l){if(!o.cpa_exceeded){let b=`⚠️ CPA превышен для проекта ${a.project_name}
Значение: ${k(c,a.currency)} при лимите ${k(l,a.currency)}
Портал: \${portalUrl(runtimeEnv, report.project_id)}`;if(await we(n,r,b,`CPA threshold exceeded for ${e.id}`))o.cpa_exceeded=!0,i=!0}}else if(o.cpa_exceeded)o.cpa_exceeded=!1,i=!0}let d=ln(e,a),m=ht(a.summary?a.summary.spend:null);if(d!==null&&m!==null){if(m>d){if(!o.spend_exceeded){let b=`⚠️ Расход превысил лимит для проекта ${a.project_name}
Потрачено: ${k(m,a.currency)} при лимите ${k(d,a.currency)}
Портал: \${portalUrl(runtimeEnv, report.project_id)}`;if(await we(n,r,b,`Spend limit exceeded for ${e.id}`))o.spend_exceeded=!0,i=!0}}else if(o.spend_exceeded)o.spend_exceeded=!1,i=!0}let f=cn(e),p=dn(a.campaigns,f),x=o.moderation_alerts||[],_=p.filter((b)=>x.indexOf(b)===-1),$=x.slice();if(_.length>0){let b=un(e,a,_,f,n);if(await we(n,r,b,`Moderation delay alert for ${e.id}`))$=p}else $=p;if(JSON.stringify(x)!==JSON.stringify($))o.moderation_alerts=$,i=!0;if(i)o.updated_at=new Date().toISOString(),await nn(t,e.id,o)};var Xt={today:"today",yesterday:"yesterday",week:"last_7d",month:"last_30d",all:"lifetime"},mn="last_30d",pn=(t)=>{if(!Array.isArray(t))return 0;let e=0;for(let a of t)if((a&&a.action_type?String(a.action_type):"").includes("lead")){let r=Number(a.value||0);e+=Number.isFinite(r)?r:0}return e},fn=(t,e)=>{let a=String(t.campaign_id||""),n=Number(t.spend||0),r=Number(t.clicks||0),s=Number(t.impressions||0),o=pn(t.actions||[]),i=s>0?r/s*100:null,l=o>0?n/o:null,c=r>0?n/r:null,d=t.frequency?Number(t.frequency):null,m=t.date_stop?t.date_stop:t.date_start,f=e.get(a),p=f?f.status:"UNKNOWN",x=f?f.updated_time:null;return{id:a,name:String(t.campaign_name||"Без названия"),status:p,spend:n,clicks:r,impressions:s,leads:o,ctr:i,cpa:l,cpc:c,frequency:d,last_active:m||null,status_updated_at:x}},gn=(t)=>{let e={spend:0,leads:0,clicks:0,impressions:0,frequency:null,cpa:null,cpc:null,ctr:null,active_campaigns:0},a=0,n=0;for(let r of t){if(e.spend+=r.spend,e.leads+=r.leads,e.clicks+=r.clicks,e.impressions+=r.impressions,r.frequency&&Number.isFinite(r.frequency))a+=r.frequency,n+=1;if(r.status==="ACTIVE"||r.status==="PAUSED"||r.status==="PAUSED_DUE_TO_HIGH_CPA")e.active_campaigns=(e.active_campaigns||0)+(r.status==="ACTIVE"?1:0)}return e.frequency=n>0?a/n:null,e.cpa=e.leads>0?e.spend/e.leads:null,e.cpc=e.clicks>0?e.spend/e.clicks:null,e.ctr=e.impressions>0?e.clicks/e.impressions*100:null,e},hn=(t,e)=>{if(e&&Xt[e])return Xt[e];if(t&&t.default_period&&Xt[t.default_period])return Xt[t.default_period];return mn},bn=async(t,e)=>{try{let a=await it(t,`${e}/campaigns`,{fields:"id,status,effective_status,updated_time",limit:"500"}),n=new Map;if(a&&Array.isArray(a.data))for(let r of a.data){let s=String(r.id||""),o=String(r.effective_status||r.status||"UNKNOWN"),i=r.updated_time?String(r.updated_time):null;if(s)n.set(s,{status:o.toUpperCase(),updated_time:i})}return n}catch(a){return new Map}},_n=86400000,yn=(t)=>{if(!t)return;let e=t.funding_source_details||{},a=e.display_string||e.card_number_last_four||null,n=t.next_bill_date||e.next_bill_date||null,r=null;if(n){let i=new Date(n).getTime();if(Number.isFinite(i)){let l=Math.ceil((i-Date.now())/_n);if(Number.isFinite(l))r=l<0?0:l}}let s=t.spend_cap!==void 0&&t.spend_cap!==null?Number(t.spend_cap):null,o=typeof s==="number"&&Number.isFinite(s)?s:null;return{card_last4:a?String(a).slice(-4):null,next_payment_date:n||null,days_to_pay:r,spend_limit:o}},Ft=async(t,e,a={})=>{let n=await ge(t,e);if(!n)return await w(t,{level:"warn",message:`Project not found for refresh: ${e}`,timestamp:new Date().toISOString()}),null;let r=n.ad_account_id||e;try{let s=await bn(t,r),o=hn(n,a.period),i=await it(t,`${r}/insights`,{level:"campaign",time_increment:"1",date_preset:o,limit:"500",fields:"campaign_id,campaign_name,impressions,clicks,spend,actions,action_values,ctr,cpc,cpp,cpm,frequency,date_start,date_stop"}),l=[];if(i&&Array.isArray(i.data))for(let f of i.data)l.push(fn(f,s));let c=await it(t,r,{fields:"name,account_status,balance,spend_cap,currency,funding_source_details,next_bill_date,amount_spent,disable_reason"}),d=gn(l),m={project_id:e,project_name:n.name,currency:c.currency||n.currency||"USD",updated_at:new Date().toISOString(),period:o,period_label:a.period||n.default_period||null,status:xn(c.account_status,c.disable_reason),summary:d,campaigns:l,billing:yn(c),chat_link:n.chat_link||null,kpi:n.kpi||null,alerts:n.alerts||null};return await U(t,`reports/${e}.json`,m),await We(t,n,m),m}catch(s){return await w(t,{level:"error",message:`Failed to refresh project ${e}: ${s.message}`,timestamp:new Date().toISOString()}),await P(t,`reports/${e}.json`)}},xn=(t,e)=>{let a=String(t||"").toUpperCase();if(a.includes("ACTIVE"))return"active";if(a.includes("PENDING"))return"pending";if(a.includes("DISABLED")||a.includes("CLOSED")||e)return"paused";return"unknown"};var wn=1800000,kn=(t)=>{if(!t)return!1;let e=new Date(t).getTime();if(!Number.isFinite(e))return!1;return Date.now()-e<=wn},$n=(t)=>`reports/${t}.json`,An=async(t,e)=>{return P(t,$n(e))},Ge=async(t,e,a={})=>{let n=await An(t,e),r=a.period||null,s=r!==null&&(!n||n.period_label!==r);if(!(Boolean(a.forceRefresh)||s)&&n&&kn(n.updated_at))return n;let i=await Ft(t,e,{period:a.period});if(i)return i;return n},He=async(t)=>{let e=await C(t);return h({projects:e})},Je=async(t,e)=>{let a=await Ge(t,e);if(!a)return Y("Project report not found");return h(a)},ke=async(t,e,a)=>{let n=await Ft(t,e,{period:a});if(!n)return Y("Unable to refresh project");return h(n)},bt=async(t)=>{let e=await C(t),a=[];for(let n of e)if(await Ft(t,n.id))a.push(n.id);return{refreshed:a}},lt=async(t,e,a={})=>{if(a.force)return Ft(t,e,{period:a.period});return Ge(t,e,{period:a.period})};var Sn=["id","name","currency","account_status","balance","spend_cap","funding_source_details","last_used_time","disable_reason"].join(","),Ve=(t)=>{if(t===null||t===void 0)return null;let e=Number(t);return Number.isFinite(e)?e:null},Pn=(t)=>{return{id:String(t?.id??""),name:String(t?.name??"Без названия"),currency:String(t?.currency??"USD"),spend_cap:Ve(t?.spend_cap),balance:Ve(t?.balance),status:t?.account_status?String(t.account_status):void 0,payment_method:t?.funding_source_details?.display_string?String(t.funding_source_details.display_string):null,last_update:t?.last_used_time?String(t.last_used_time):null,issues:t?.disable_reason?[String(t.disable_reason)]:void 0}},Tt=async(t)=>{try{let e=await it(t,"me/adaccounts",{fields:Sn,limit:"50"});if(!e||!Array.isArray(e.data))return[];return e.data.map(Pn)}catch(e){return[]}};var _t="cache/fb_status.json",Rn=1800000,jn=(t)=>{if(!t)return!1;let e=new Date(t).getTime();if(!Number.isFinite(e))return!1;return Date.now()-e<=Rn},et=async(t,e={})=>{if(e.useCache!==!1){let l=await P(t,_t);if(l&&jn(l.updated_at||l.last_refresh))return{...l,cached:!0}}let[n,r]=await Promise.all([it(t,"me",{fields:"id,name"}),Tt(t)]),s=new Date().toISOString(),o=[];for(let l of r){let c=String(l.status||"").toLowerCase();if(c&&!c.includes("active"))o.push(`Account ${l.id} status ${l.status}`);if(Array.isArray(l.issues)&&l.issues.length)o.push(...l.issues.map((d)=>`Account ${l.id}: ${d}`))}let i={ok:!0,status:"ok",account_name:n&&n.name?String(n.name):void 0,account_id:n&&n.id?String(n.id):void 0,last_refresh:s,updated_at:s,refreshed_at:s,issues:o,accounts:r,cached:!1};return await U(t,_t,i),i},Ye=async(t)=>{try{let e=await et(t);return h(e)}catch(e){let a={ok:!1,issues:[e.message]};return h(a,{status:503})}},Et=async(t)=>{return await mt(t,_t)};var Tn={"&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#39;","`":"&#96;"},u=(t)=>{if(t===null||t===void 0)return"";return(typeof t==="string"?t:String(t)).replace(/[&<>"'`]/g,(a)=>Tn[a])},z=(t)=>t.filter(Boolean).join("");var Ct=(t,e)=>{return z(["<!DOCTYPE html>",'<html lang="ru" class="h-full bg-slate-900">',"<head>",'<meta charset="utf-8" />','<meta name="viewport" content="width=device-width, initial-scale=1" />',`<title>${u(e.title)}</title>`,'<script src="https://cdn.tailwindcss.com?plugins=forms,typography"></script>',"<style>",":root { color-scheme: dark; }",".accent { color: #00B87C; }","</style>","</head>",'<body class="min-h-screen bg-slate-900 text-slate-100">','<div class="min-h-screen flex flex-col md:flex-row">',e.sidebar?`<aside class="w-full md:w-64 bg-slate-950 border-b md:border-b-0 md:border-r border-slate-800">${e.sidebar}</aside>`:"",'<main class="flex-1">','<div class="mx-auto max-w-6xl p-6">',t,"</div>","</main>","</div>",e.scripts||"","</body></html>"])};var En={active:"\uD83D\uDFE2",pending:"\uD83D\uDFE1",paused:"⚪️",unknown:"⚪️"},Cn=(t,e)=>{let a=t.summary,n=En[t.status||"unknown"]||"⚪️",r=t.billing||{},s=r.card_last4?`•••• ${r.card_last4}`:"—",o=M(t.updated_at,e),i=r.days_to_pay,l=typeof i==="number"&&i>=0?Math.min(i,30):null;return z(['<div class="rounded-xl border border-slate-800 bg-slate-950 p-6 shadow-lg">','<div class="flex flex-col gap-2 md:flex-row md:items-center md:justify-between">','<div class="text-2xl font-semibold">',`<span>${n} ${u(t.project_name)}</span>`,"</div>",`<div class="text-sm text-slate-400">Последнее обновление: ${u(o)}</div>`,"</div>",'<div class="mt-4 grid gap-4 md:grid-cols-2">','<div class="space-y-2">','<div class="text-sm uppercase text-slate-400">Карта</div>',`<div class="text-lg">${u(s)}</div>`,"</div>",'<div class="space-y-2">','<div class="text-sm uppercase text-slate-400">Оплата через</div>',`<div class="text-lg">${i!==null&&i!==void 0?`${i}д`:"—"}</div>`,l!==null?`<div class="h-2 rounded-full bg-slate-800"><div class="h-2 rounded-full bg-emerald-500" style="width: ${Math.max(0,(30-l)*100/30)}%"></div></div>`:"","</div>","</div>",'<hr class="my-6 border-slate-800" />','<div class="grid gap-4 md:grid-cols-3">','<div class="space-y-1">','<div class="text-sm text-slate-400">Активные кампании</div>',`<div class="text-2xl font-semibold">${O(a.active_campaigns||0)}</div>`,"</div>",'<div class="space-y-1">','<div class="text-sm text-slate-400">Потрачено</div>',`<div class="text-2xl font-semibold">${k(a.spend,t.currency)}</div>`,"</div>",'<div class="space-y-1">','<div class="text-sm text-slate-400">Лиды</div>',`<div class="text-2xl font-semibold">${O(a.leads)}</div>`,"</div>","</div>",'<div class="mt-6 grid gap-4 md:grid-cols-2">',Mt("Клики",O(a.clicks)),Mt("Показы",O(a.impressions)),Mt("Частота",Qt(a.frequency)),Mt("CPA",k(a.cpa,t.currency)),Mt("CPC",k(a.cpc,t.currency)),Mt("CTR",tt(a.ctr)),"</div>",'<hr class="my-6 border-slate-800" />','<div class="flex flex-col gap-3 md:flex-row md:items-center md:justify-between">',`<a href="/portal/${u(t.project_id)}/campaigns" class="inline-flex items-center justify-center rounded-lg border border-emerald-500 px-4 py-2 text-sm font-semibold text-emerald-400 hover:bg-emerald-500/10">Все кампании</a>`,t.chat_link?`<a href="${u(t.chat_link)}" class="inline-flex items-center justify-center rounded-lg border border-slate-700 px-4 py-2 text-sm font-semibold text-slate-200 hover:bg-slate-800">Чат клиента</a>`:'<span class="text-sm text-slate-500">Чат клиента не назначен</span>',"</div>","</div>"])},Mt=(t,e)=>{return`<div class="flex items-center justify-between rounded-lg bg-slate-900 px-4 py-3"><span class="text-sm text-slate-400">${u(t)}</span><span class="text-lg font-semibold">\${escapeHtml(value)}</span>\${'</div>'}`},ze=(t,e)=>{let a=z(['<div class="space-y-6">',Cn(t,e),"</div>"]),n=`<div class="p-6 space-y-6"><div class="text-sm font-semibold uppercase text-slate-500">Навигация</div><nav class="space-y-2"><a class="block rounded-lg px-3 py-2 text-sm font-medium bg-slate-900 text-emerald-400" href="/portal/${u(t.project_id)}">Сводка</a><a class="block rounded-lg px-3 py-2 text-sm text-slate-300 hover:bg-slate-900" href="/portal/${u(t.project_id)}/campaigns">Кампании</a><a class="block rounded-lg px-3 py-2 text-sm text-slate-300 hover:bg-slate-900" href="/admin?project=\${escapeHtml(report.project_id)}">Админ-панель</a>\${'</nav>'}</div>`;return Ct(a,{title:`${t.project_name} — портал`,sidebar:n})};var Mn={ACTIVE:"\uD83D\uDFE2",PAUSED:"⚪️",ARCHIVED:"⚪️",DELETED:"⚪️",PENDING_REVIEW:"\uD83D\uDFE1",IN_REVIEW:"\uD83D\uDFE1"},Dn=(t,e,a)=>{return`<form method="get" class="flex flex-col gap-3 rounded-xl border border-slate-800 bg-slate-950 p-4 md:flex-row md:items-end"><div class="flex flex-col"><label class="text-sm text-slate-400">Период</label><select name="period" class="mt-1 rounded-lg border border-slate-700 bg-slate-900 px-3 py-2 text-sm text-slate-100">${[{value:"today",label:"Сегодня"},{value:"yesterday",label:"Вчера"},{value:"week",label:"Неделя"},{value:"month",label:"Месяц"},{value:"all",label:"Всё время"}].map((s)=>`<option value="${s.value}"${s.value===e?" selected":""}>${s.label}</option>`).join("")}</select></div><label class="flex items-center gap-2 text-sm text-slate-300"><input type="checkbox" name="onlyActive" value="1"${a?" checked":""} class="h-4 w-4 rounded border-slate-700 bg-slate-900" /><span>Только активные</span>\${'</label>'}<div class="flex gap-3">\${'<button type="submit" class="rounded-lg bg-emerald-500 px-4 py-2 text-sm font-semibold text-slate-950 hover:bg-emerald-400">Фильтр</button>'}<a href="/api/project/\${escapeHtml(projectId)}/refresh" class="rounded-lg border border-emerald-500 px-4 py-2 text-sm font-semibold text-emerald-400 hover:bg-emerald-500/10">Обновить</a>\${'</div>'}</form>`},On=(t,e)=>{let a=`<table class="min-w-full overflow-hidden rounded-xl border border-slate-800 bg-slate-950 text-sm"><thead class="bg-slate-900 text-xs uppercase text-slate-400"><tr>${'<th class="px-4 py-3 text-left">Статус</th>'}<th class="px-4 py-3 text-left">Название</th>${'<th class="px-4 py-3 text-right">Потрачено</th>'}<th class="px-4 py-3 text-right">Лиды</th>${'<th class="px-4 py-3 text-right">Клики</th>'}<th class="px-4 py-3 text-right">Показы</th>${'<th class="px-4 py-3 text-right">CPA</th>'}<th class="px-4 py-3 text-right">CPC</th>${'<th class="px-4 py-3 text-right">CTR</th>'}<th class="px-4 py-3 text-right">Последняя активность</th>${"</tr>"}</thead><tbody class="divide-y divide-slate-800 text-slate-100">`,n=t.map((r)=>{return`<tr class="hover:bg-slate-900/70"><td class="px-4 py-3">${Mn[r.status]||"⚪️"}</td><td class="px-4 py-3 font-medium">${u(r.name)}</td><td class="px-4 py-3 text-right">${k(r.spend,e)}</td><td class="px-4 py-3 text-right">${O(r.leads)}</td><td class="px-4 py-3 text-right">${O(r.clicks)}</td><td class="px-4 py-3 text-right">${O(r.impressions)}</td><td class="px-4 py-3 text-right">${k(r.cpa,e)}</td><td class="px-4 py-3 text-right">${k(r.cpc,e)}</td><td class="px-4 py-3 text-right">${tt(r.ctr)}</td><td class="px-4 py-3 text-right">\${formatDate(campaign.last_active || campaign.status_updated_at || null)}</td>\${'</tr>'}`}).join("");return`${a}${n}</tbody></table>`},Ze=(t,e)=>{let a=t.campaigns.filter((s)=>e.onlyActive?s.status==="ACTIVE":!0),n=z(['<div class="space-y-6">','<div class="flex items-center justify-between">',`<h1 class="text-2xl font-semibold">Кампании — ${u(t.project_name)}</h1>`,`<a href="/portal/${u(t.project_id)}" class="text-sm text-emerald-400 hover:text-emerald-300">← Назад к сводке</a>`,"</div>",Dn(t.project_id,e.period,e.onlyActive),a.length>0?On(a,t.currency):'<div class="rounded-xl border border-slate-800 bg-slate-950 p-6 text-center text-sm text-slate-400">Нет кампаний по выбранным фильтрам</div>',"</div>"]),r=`<div class="p-6 space-y-6"><div class="text-sm font-semibold uppercase text-slate-500">Навигация</div><nav class="space-y-2"><a class="block rounded-lg px-3 py-2 text-sm text-slate-300 hover:bg-slate-900" href="/portal/${u(t.project_id)}">Сводка</a><a class="block rounded-lg px-3 py-2 text-sm font-medium bg-slate-900 text-emerald-400" href="/portal/\${escapeHtml(report.project_id)}/campaigns">Кампании</a>\${'</nav>'}</div>`;return Ct(n,{title:`${t.project_name} — кампании`,sidebar:r})};var Nn="Asia/Tashkent",In=(t)=>{let e=t.DEFAULT_TZ;return typeof e==="string"&&e?e:Nn},qe=async(t,e,a)=>{let n=await lt(e,a,{force:!1});if(!n)return Y("Report not found");let r=In(e),s=ze(n,r);return V(s)},Qe=async(t,e,a)=>{let n=new URL(t.url),r=n.searchParams.get("period")||"month",s=n.searchParams.get("onlyActive")==="1",o=await lt(e,a,{force:!1,period:r});if(!o)return Y("Report not found");let i=Ze(o,{period:r,onlyActive:s});return V(i)};var $e="meta:auth",Ln=86400000,Ae=(t)=>{return t.DB||t.SESSION_NAMESPACE||t.FALLBACK_KV||t.LOGS_NAMESPACE||null},yt=(t)=>{if(t.length<=8)return t;let e=t.slice(0,5),a=t.slice(-2);return`${e}****${a}`},Se=async(t)=>{let e=Ae(t);if(!e)return null;try{let a=await e.get($e);if(!a)return null;let n=JSON.parse(a);if(!n||typeof n!=="object"||typeof n.access_token!=="string")return null;return n}catch(a){return null}},Xe=async(t,e)=>{let a=Ae(t);if(!a)return;try{await a.put($e,JSON.stringify(e))}catch(n){}},Fn=async(t)=>{let e=Ae(t);if(!e)return;try{await e.delete($e)}catch(a){}},ta=(t,e)=>{let a=new URL(`https://graph.facebook.com/${t.replace(/^\/+/,"")}`);for(let n of Object.keys(e))a.searchParams.set(n,e[n]);return a.toString()},te=async(t,e)=>{let a=new Date,n=`facebook_errors/${a.toISOString().slice(0,10)}`;await w(t,{level:"error",message:e,timestamp:a.toISOString()},n)},Z=async(t)=>{let e=await Se(t);if(!e)return{ok:!1,status:"missing",valid:!1,issues:["Meta access token is not configured."]};let a=e.access_token,n=typeof t.FB_APP_ID==="string"?t.FB_APP_ID:"",r=typeof t.FB_APP_SECRET==="string"?t.FB_APP_SECRET:"";if(!n||!r)return{ok:!1,status:"invalid",valid:!1,issues:["Facebook app credentials are not configured."],token_snippet:yt(a),account_id:e.account_id||null,account_name:e.account_name||null,refreshed_at:e.refreshed_at||null,expires_at:e.expires_at?new Date(e.expires_at).toISOString():null};let s=ta("debug_token",{input_token:a,access_token:`${n}|${r}`}),o=null;try{let _=await fetch(s);if(!_.ok){let $=await _.text();throw new Error(`Debug token request failed: ${$}`)}o=await _.json()}catch(_){let $=_.message||"Unknown error";return await te(t,`Token debug failed: ${$}`),{ok:!1,status:"invalid",valid:!1,issues:[$],token_snippet:yt(a),account_id:e.account_id||null,account_name:e.account_name||null,refreshed_at:e.refreshed_at||null,expires_at:e.expires_at?new Date(e.expires_at).toISOString():null}}let i=o&&o.data?o.data:null;if(!i)return{ok:!1,status:"invalid",valid:!1,issues:["Debug token response missing data."],token_snippet:yt(a),account_id:e.account_id||null,account_name:e.account_name||null,refreshed_at:e.refreshed_at||null,expires_at:e.expires_at?new Date(e.expires_at).toISOString():null};let l=typeof i.expires_at==="number"?i.expires_at:null,c=l?new Date(l*1000).toISOString():null,d=l?Math.floor((l*1000-Date.now())/3600000):null,m=l?l*1000-Date.now()<=Ln:!1,f=l?Date.now()>=l*1000:!1,p=Boolean(i.is_valid)&&!f,x=[];if(!p)x.push("Meta access token is invalid or expired.");if(f)x.push(`Meta access token expired at ${c||"unknown"}`);return{ok:p,status:f?"expired":p?"ok":"invalid",valid:p,issues:x,expires_at:c,expires_in_hours:d,should_refresh:m,token_snippet:yt(a),account_id:i.profile_id?String(i.profile_id):e.account_id||null,account_name:e.account_name||null,refreshed_at:e.refreshed_at||null}},vn=async(t,e)=>{let a=typeof t.FB_APP_ID==="string"?t.FB_APP_ID:"",n=typeof t.FB_APP_SECRET==="string"?t.FB_APP_SECRET:"";if(!a||!n)return{ok:!1,refreshed:!1,message:"Facebook app credentials are not configured.",token_snippet:yt(e.access_token)};let r=ta("oauth/access_token",{grant_type:"fb_exchange_token",client_id:a,client_secret:n,fb_exchange_token:e.access_token});try{let s=await fetch(r);if(!s.ok){let f=await s.text();throw new Error(`Token refresh failed: ${f}`)}let o=await s.json(),i=typeof o.access_token==="string"?o.access_token:null;if(!i)throw new Error("Token refresh response missing access_token");let l=typeof o.expires_in==="number"?o.expires_in:null,c=new Date().toISOString(),d={access_token:i,issued_at:Date.now(),expires_at:l?Date.now()+l*1000:void 0,refreshed_at:c,account_id:e.account_id||null,account_name:e.account_name||null,token_type:typeof o.token_type==="string"?o.token_type:e.token_type||null};return await Xe(t,d),{ok:!0,refreshed:!0,message:"Facebook token refreshed successfully.",expires_at:d.expires_at?new Date(d.expires_at).toISOString():null,expires_in_hours:d.expires_at?Math.floor((d.expires_at-Date.now())/3600000):null,token_snippet:yt(i)}}catch(s){let o=s.message||"Unknown error";return await te(t,o),{ok:!1,refreshed:!1,message:o,token_snippet:yt(e.access_token)}}},at=async(t,e={})=>{let a=e.notify!==!1,n=e.force===!0,r=await Z(t);if(r.status==="missing"){if(a)await G(t,"⚠️ Meta токен не настроен. Авторизуйтесь в Facebook кабинете.");return{status:r,refresh:null}}if(r.status==="invalid"&&r.issues.length>0){let c=`⚠️ Ошибка Meta токена: ${r.issues.join("; ")}`;return await G(t,c),{status:r,refresh:null}}if(r.status==="expired"){await Fn(t);let c=`\uD83D\uDEA8 Meta токен истёк ${r.expires_at||"ранее"}`;return await G(t,c),await te(t,c),{status:r,refresh:null}}if(!(n||Boolean(r.should_refresh)))return{status:r,refresh:null};let o=await Se(t);if(!o)return{status:r,refresh:null};let i=await vn(t,o);if(i.ok){let d=`✅ Meta токен обновлён.${i.expires_at?` Новый срок: ${i.expires_at}`:""}`;if(a)await G(t,d);return await w(t,{level:"info",message:d,timestamp:new Date().toISOString()}),{status:await Z(t),refresh:i}}let l=`\uD83D\uDEA8 Ошибка обновления Meta токена: ${i.message}`;return await G(t,l),await te(t,l),{status:r,refresh:i}};var ea=async(t,e)=>{let n={...await Se(t)||{},...e,access_token:e.access_token};await Xe(t,n)};var Pe=(t)=>{if(t===null||t===void 0)return null;if(typeof t==="number")return Number.isFinite(t)?t:null;if(typeof t==="string"){let e=Number(t);return Number.isFinite(e)?e:null}return null},Bn=(t)=>{if(!t||!t.summary)return{value:null,label:null};let e=t.summary,a=["today_spend","spend_today","todaySpend","spendDaily","daily_spend"];for(let s of a)if(s in e){let o=Pe(e[s]);if(o!==null)return{value:o,label:"Сегодня"}}if(e&&typeof e.today==="object"&&e.today!==null){let s=Pe(e.today.spend);if(s!==null)return{value:s,label:"Сегодня"}}let n=Pe(e.spend),r=typeof t.period_label==="string"&&t.period_label.trim()?t.period_label.trim():typeof e.period_label==="string"&&e.period_label.trim()?e.period_label.trim():t.period||null;return{value:n,label:r?String(r):null}},ee=async(t,e)=>{if(!e)return null;let a=e.currency||e.billing?.currency||"USD";try{let n=await P(t,`reports/${e.id}.json`),r=Bn(n);if(r.value!==null)return{value:r.value,label:r.label,currency:a}}catch(n){}if(e.summary&&typeof e.summary.spend==="number")return{value:e.summary.spend,label:typeof e.summary.period_label==="string"?e.summary.period_label.trim():null,currency:a};return{value:null,label:null,currency:a}},vt=(t)=>{if(!t)return null;if(t.chat_link&&t.chat_link.trim())return t.chat_link.trim();if(t.chat_username&&t.chat_username.trim())return`@${t.chat_username.replace(/^@/,"")}`;if(t.chat_id!==null&&t.chat_id!==void 0){let e=String(t.chat_id).trim();if(e)return`ID: ${e}`}return null};var Kn=(t)=>{let e=(t||"").toLowerCase();if(e.startsWith("active"))return"\uD83D\uDFE2";if(e.startsWith("pend")||e.includes("review"))return"\uD83D\uDFE1";if(!e)return"⚪️";return"⚪️"},nt=(t,e="—")=>{if(t===null||t===void 0)return e;let a=String(t).trim();return a?u(a):e},F=(t)=>{if(t===null||t===void 0)return"";let e=String(t).trim();return e?u(e):""},Un=(t)=>{let e=Kn(t.status),a=t.chat_link?`<a class="text-emerald-400 hover:text-emerald-300" href="${u(t.chat_link)}">Чат</a>`:t.chat_username?`<span class="text-slate-400">@${u(t.chat_username.replace(/^@/,""))}</span>`:'<span class="text-slate-500">Чат не настроен</span>',n=t.portal_url?`<a class="rounded-lg border border-emerald-500 px-3 py-1 text-xs font-semibold text-emerald-300 hover:bg-emerald-500/10" href="${u(t.portal_url)}" target="_blank" rel="noopener">Портал</a>`:'<span class="text-xs text-slate-500">Портал отключён</span>',r=t.alerts_enabled===!1?'<span class="inline-flex items-center rounded-full bg-red-900/40 px-2 py-0.5 text-xs text-red-300">Алерты выкл.</span>':'<span class="inline-flex items-center rounded-full bg-emerald-900/40 px-2 py-0.5 text-xs text-emerald-300">Алерты вкл.</span>',s=t.silent_weekends?'<span class="inline-flex items-center rounded-full bg-slate-800 px-2 py-0.5 text-xs text-slate-300">Тихие выходные</span>':"",o=t.billing?.next_payment||t.billing?.next_payment_date||null,i=o?`<div class="text-sm text-slate-300">\uD83D\uDCB3 Следующая оплата: ${nt(o)}</div>`:"",l=t.manager?`<div class="text-sm text-slate-300">Менеджер: ${nt(t.manager)}</div>`:"",c=t.last_sync||t.updated_at||null,d=z([`<div class="text-sm text-slate-300">${e} ${nt(t.status||"")}</div>`,t.account_name?`<div class="text-sm text-slate-400">Аккаунт: ${nt(t.account_name)}</div>`:"",i,l,c?`<div class="text-xs text-slate-500">Синхронизировано: ${u(c)}</div>`:""]),m=t.summary?`<div class="mt-4 grid grid-cols-2 gap-3 text-sm md:grid-cols-4">
        <div>
          <div class="text-slate-500">Потрачено</div>
          <div class="font-semibold">${u(k(t.summary.spend,t.currency||"USD"))}</div>
        </div>
        <div>
          <div class="text-slate-500">Лиды</div>
          <div class="font-semibold">${u(String(t.summary.leads??"—"))}</div>
        </div>
        <div>
          <div class="text-slate-500">Клики</div>
          <div class="font-semibold">${u(String(t.summary.clicks??"—"))}</div>
        </div>
        <div>
          <div class="text-slate-500">CTR</div>
          <div class="font-semibold">${u(String(t.summary.ctr??"—"))}</div>
        </div>
      </div>`:'<p class="mt-4 text-sm text-slate-500">Нет свежей сводки</p>',f=z([r,s]),p=u(t.id),x=t.alerts_enabled===void 0||t.alerts_enabled===null?!0:Boolean(t.alerts_enabled),_=Boolean(t.silent_weekends),$=x?"\uD83D\uDD15 Выключить алерты":"\uD83D\uDD14 Включить алерты",b=_?"\uD83D\uDD14 Включить уведомления в выходные":"\uD83D\uDE34 Включить тихие выходные",A="rounded-lg border border-slate-700 bg-slate-950 px-3 py-2 text-sm text-slate-100 placeholder-slate-500 focus:border-emerald-500 focus:outline-none",T=`
    <div class="mt-4 flex flex-wrap gap-2 text-xs sm:text-sm">
      <button
        type="button"
        data-admin-action="toggle-alerts"
        data-project="${p}"
        class="rounded-lg bg-slate-800 px-3 py-1.5 font-semibold text-slate-200 hover:bg-slate-700"
      >
        ${u($)}
      </button>
      <button
        type="button"
        data-admin-action="toggle-silent"
        data-project="${p}"
        class="rounded-lg bg-slate-800 px-3 py-1.5 font-semibold text-slate-200 hover:bg-slate-700"
      >
        ${u(b)}
      </button>
      <button
        type="button"
        data-admin-action="edit-project"
        data-project="${p}"
        class="rounded-lg bg-slate-800 px-3 py-1.5 font-semibold text-slate-200 hover:bg-slate-700"
      >
        ✏️ Редактировать
      </button>
      <button
        type="button"
        data-admin-action="edit-billing"
        data-project="${p}"
        class="rounded-lg bg-slate-800 px-3 py-1.5 font-semibold text-slate-200 hover:bg-slate-700"
      >
        \uD83D\uDCB3 Настроить оплату
      </button>
      <button
        type="button"
        data-admin-action="refresh-project"
        data-project="${p}"
        class="rounded-lg bg-emerald-500 px-3 py-1.5 font-semibold text-slate-950 hover:bg-emerald-400"
      >
        \uD83D\uDD04 Обновить отчёт
      </button>
    </div>
  `,N=`
    <form
      data-admin-form="update-project"
      data-project="${p}"
      data-admin-form-section="project"
      class="mt-4 hidden space-y-4 rounded-xl border border-slate-800 bg-slate-900/60 p-4"
    >
      <div class="grid gap-3 sm:grid-cols-2">
        <label class="flex flex-col gap-1 text-xs font-semibold uppercase tracking-wide text-slate-400">
          Название
          <input name="name" type="text" value="${F(t.name)}" class="${"rounded-lg border border-slate-700 bg-slate-950 px-3 py-2 text-sm text-slate-100 placeholder-slate-500 focus:border-emerald-500 focus:outline-none"}" placeholder="Название проекта" />
        </label>
        <label class="flex flex-col gap-1 text-xs font-semibold uppercase tracking-wide text-slate-400">
          Статус
          <input name="status" type="text" value="${F(t.status||"")}" class="rounded-lg border border-slate-700 bg-slate-950 px-3 py-2 text-sm text-slate-100 placeholder-slate-500 focus:border-emerald-500 focus:outline-none" placeholder="active" />
        </label>
        <label class="flex flex-col gap-1 text-xs font-semibold uppercase tracking-wide text-slate-400">
          Chat ID
          <input name="chat_id" type="text" value="${F(t.chat_id||"")}" class="rounded-lg border border-slate-700 bg-slate-950 px-3 py-2 text-sm text-slate-100 placeholder-slate-500 focus:border-emerald-500 focus:outline-none" placeholder="-100123456" />
        </label>
        <label class="flex flex-col gap-1 text-xs font-semibold uppercase tracking-wide text-slate-400">
          Telegram
          <input name="chat_username" type="text" value="${F(t.chat_username||"")}" class="${"rounded-lg border border-slate-700 bg-slate-950 px-3 py-2 text-sm text-slate-100 placeholder-slate-500 focus:border-emerald-500 focus:outline-none"}" placeholder="@username" />
        </label>
        <label class="flex flex-col gap-1 text-xs font-semibold uppercase tracking-wide text-slate-400">
          Ссылка на чат
          <input name="chat_link" type="text" value="${F(t.chat_link||"")}" class="${"rounded-lg border border-slate-700 bg-slate-950 px-3 py-2 text-sm text-slate-100 placeholder-slate-500 focus:border-emerald-500 focus:outline-none"}" placeholder="https://t.me/..." />
        </label>
        <label class="flex flex-col gap-1 text-xs font-semibold uppercase tracking-wide text-slate-400">
          Аккаунт Facebook
          <input name="account_name" type="text" value="${F(t.account_name||"")}" class="${"rounded-lg border border-slate-700 bg-slate-950 px-3 py-2 text-sm text-slate-100 placeholder-slate-500 focus:border-emerald-500 focus:outline-none"}" placeholder="Ad Account" />
        </label>
        <label class="flex flex-col gap-1 text-xs font-semibold uppercase tracking-wide text-slate-400">
          День оплаты
          <input name="billing_day" type="number" value="${F(t.billing_day??"")}" class="${"rounded-lg border border-slate-700 bg-slate-950 px-3 py-2 text-sm text-slate-100 placeholder-slate-500 focus:border-emerald-500 focus:outline-none"}" min="1" max="31" />
        </label>
        <label class="flex flex-col gap-1 text-xs font-semibold uppercase tracking-wide text-slate-400">
          Менеджер
          <input name="manager" type="text" value="${F(t.manager||"")}" class="${"rounded-lg border border-slate-700 bg-slate-950 px-3 py-2 text-sm text-slate-100 placeholder-slate-500 focus:border-emerald-500 focus:outline-none"}" placeholder="Имя менеджера" />
        </label>
        <label class="flex flex-col gap-1 text-xs font-semibold uppercase tracking-wide text-slate-400">
          Портал
          <input name="portal_url" type="text" value="${F(t.portal_url||"")}" class="${"rounded-lg border border-slate-700 bg-slate-950 px-3 py-2 text-sm text-slate-100 placeholder-slate-500 focus:border-emerald-500 focus:outline-none"}" placeholder="https://.../portal" />
        </label>
      </div>
      <div class="flex flex-wrap gap-2">
        <button type="submit" class="rounded-lg bg-emerald-500 px-3 py-1.5 text-sm font-semibold text-slate-950 hover:bg-emerald-400">
          \uD83D\uDCBE Сохранить
        </button>
        <button
          type="button"
          data-admin-action="cancel-edit"
          data-project="${p}"
          class="rounded-lg bg-slate-800 px-3 py-1.5 text-sm font-semibold text-slate-200 hover:bg-slate-700"
        >
          Отмена
        </button>
      </div>
    </form>
  `,S=t.billing||{},$t=`
    <form
      data-admin-form="update-billing"
      data-project="${p}"
      data-admin-form-section="billing"
      class="mt-4 hidden space-y-4 rounded-xl border border-slate-800 bg-slate-900/60 p-4"
    >
      <div class="grid gap-3 sm:grid-cols-2">
        <label class="flex flex-col gap-1 text-xs font-semibold uppercase tracking-wide text-slate-400">
          Сумма
          <input name="amount" type="number" step="0.01" value="${F(S.amount??"")}" class="${"rounded-lg border border-slate-700 bg-slate-950 px-3 py-2 text-sm text-slate-100 placeholder-slate-500 focus:border-emerald-500 focus:outline-none"}" placeholder="1200000" />
        </label>
        <label class="flex flex-col gap-1 text-xs font-semibold uppercase tracking-wide text-slate-400">
          Валюта
          <input name="currency" type="text" value="${F(S.currency||t.currency||"")}" class="${"rounded-lg border border-slate-700 bg-slate-950 px-3 py-2 text-sm text-slate-100 placeholder-slate-500 focus:border-emerald-500 focus:outline-none"}" placeholder="USD" />
        </label>
        <label class="flex flex-col gap-1 text-xs font-semibold uppercase tracking-wide text-slate-400">
          Последняя оплата
          <input name="last_payment" type="date" value="${F(S.last_payment||"")}" class="${"rounded-lg border border-slate-700 bg-slate-950 px-3 py-2 text-sm text-slate-100 placeholder-slate-500 focus:border-emerald-500 focus:outline-none"}" />
        </label>
        <label class="flex flex-col gap-1 text-xs font-semibold uppercase tracking-wide text-slate-400">
          Следующая оплата
          <input name="next_payment" type="date" value="${F(S.next_payment||S.next_payment_date||"")}" class="${"rounded-lg border border-slate-700 bg-slate-950 px-3 py-2 text-sm text-slate-100 placeholder-slate-500 focus:border-emerald-500 focus:outline-none"}" />
        </label>
        <label class="flex flex-col gap-1 text-xs font-semibold uppercase tracking-wide text-slate-400">
          Статус
          <input name="status" type="text" value="${F(S.status||"")}" class="${"rounded-lg border border-slate-700 bg-slate-950 px-3 py-2 text-sm text-slate-100 placeholder-slate-500 focus:border-emerald-500 focus:outline-none"}" placeholder="paid" />
        </label>
      </div>
      <div class="flex flex-wrap gap-2">
        <button type="submit" class="rounded-lg bg-emerald-500 px-3 py-1.5 text-sm font-semibold text-slate-950 hover:bg-emerald-400">
          \uD83D\uDCBE Сохранить оплату
        </button>
        <button
          type="button"
          data-admin-action="cancel-edit"
          data-project="${p}"
          class="rounded-lg bg-slate-800 px-3 py-1.5 text-sm font-semibold text-slate-200 hover:bg-slate-700"
        >
          Отмена
        </button>
      </div>
    </form>
  `;return`<div class="rounded-2xl border border-slate-800 bg-slate-950 p-5 shadow-lg shadow-slate-950/40" data-project-card="${p}"><div class="flex flex-col gap-4 md:flex-row md:items-start md:justify-between"><div><h3 class="text-xl font-semibold">${u(t.name)}</h3><div class="mt-1 flex flex-wrap items-center gap-3 text-sm">${d}</div></div><div class="flex flex-col items-end gap-2 text-sm">${n}${a}</div></div>${f?`<div class="mt-3 flex flex-wrap gap-2">${f}</div>`:""}${m}${T}${N}${$t}</div>`},Wn=()=>{return`<div class="mb-6 rounded-2xl border border-slate-800 bg-slate-950 p-6 shadow-lg shadow-slate-950/30"><h3 class="text-lg font-semibold text-slate-100">Добавить проект</h3><p class="mt-2 text-sm text-slate-400">Укажите основные параметры проекта. Остальные настройки можно обновить позже из карточки проекта.</p><form data-admin-form="create-project" class="mt-4 space-y-4"><div class="grid gap-3 sm:grid-cols-2"><label class="flex flex-col gap-1 text-xs font-semibold uppercase tracking-wide text-slate-400">ID проекта<input name="id" type="text" required class="${"rounded-lg border border-slate-700 bg-slate-950 px-3 py-2 text-sm text-slate-100 placeholder-slate-500 focus:border-emerald-500 focus:outline-none"}" placeholder="beznds"></label><label class="flex flex-col gap-1 text-xs font-semibold uppercase tracking-wide text-slate-400">Название<input name="name" type="text" class="${"rounded-lg border border-slate-700 bg-slate-950 px-3 py-2 text-sm text-slate-100 placeholder-slate-500 focus:border-emerald-500 focus:outline-none"}" placeholder="Без НДС"></label><label class="flex flex-col gap-1 text-xs font-semibold uppercase tracking-wide text-slate-400">Chat ID<input name="chat_id" type="text" class="${"rounded-lg border border-slate-700 bg-slate-950 px-3 py-2 text-sm text-slate-100 placeholder-slate-500 focus:border-emerald-500 focus:outline-none"}" placeholder="-100123456"></label><label class="flex flex-col gap-1 text-xs font-semibold uppercase tracking-wide text-slate-400">Telegram<input name="chat_username" type="text" class="${"rounded-lg border border-slate-700 bg-slate-950 px-3 py-2 text-sm text-slate-100 placeholder-slate-500 focus:border-emerald-500 focus:outline-none"}" placeholder="@username"></label><label class="flex flex-col gap-1 text-xs font-semibold uppercase tracking-wide text-slate-400">Аккаунт Facebook<input name="account_name" type="text" class="${"rounded-lg border border-slate-700 bg-slate-950 px-3 py-2 text-sm text-slate-100 placeholder-slate-500 focus:border-emerald-500 focus:outline-none"}" placeholder="Ad Account"></label><label class="flex flex-col gap-1 text-xs font-semibold uppercase tracking-wide text-slate-400">День оплаты<input name="billing_day" type="number" min="1" max="31" class="${"rounded-lg border border-slate-700 bg-slate-950 px-3 py-2 text-sm text-slate-100 placeholder-slate-500 focus:border-emerald-500 focus:outline-none"}" placeholder="11"></label><label class="flex flex-col gap-1 text-xs font-semibold uppercase tracking-wide text-slate-400">Менеджер<input name="manager" type="text" class="\${inputClass}" placeholder="Имя менеджера"></label>\${'</div>'}<div class="flex flex-wrap gap-2">\${'<button type="submit" class="rounded-lg bg-emerald-500 px-4 py-2 text-sm font-semibold text-slate-950 hover:bg-emerald-400">➕ Создать проект</button>'}</div>\${'</form>'}</div>`},Gn=(t)=>{let e=t.length?`<div class="grid gap-5 lg:grid-cols-2">${t.map(Un).join("")}</div>`:'<div class="rounded-2xl border border-slate-800 bg-slate-950 p-8 text-center text-slate-400">Проекты не найдены.</div>';return Wn()+e},Hn=(t,e)=>{if(!e.length)return'<div class="rounded-2xl border border-slate-800 bg-slate-950 p-6 text-sm text-slate-400">Нет данных об аккаунтах. Проверьте подключение к Facebook.</div>';let a=t.filter((s)=>!s.account_id&&(s.chat_link||s.chat_username||s.chat_id)).sort((s,o)=>s.name.localeCompare(o.name,"ru")),n=()=>{if(!a.length)return'<p class="text-sm text-slate-400">Свободных чат-групп нет. Добавьте проект с чатами в разделе «Проекты».</p>';return`<div class="flex flex-wrap gap-2" data-account-chat-list>${a.map((s)=>`<button type="button" data-account-chat data-project="${u(s.id)}" data-project-name="${u(s.name)}" class="rounded-lg border border-slate-700 px-3 py-1.5 text-sm text-slate-200 hover:border-emerald-400 hover:text-emerald-300">${u(s.name)}</button>`).join("")}</div>`};return`<div class="space-y-4">${e.map((s)=>{let o=t.find((S)=>S.account_id&&S.account_id===s.id)||null,i=Boolean(o&&(o.chat_link||o.chat_username||o.chat_id)),l=o&&typeof o.summary?.spend==="number"?k(o.summary.spend,o.currency||"USD"):"—",c=i?gt(s.status):"\uD83D\uDD18",d=o?o.chat_link?`<a class="text-emerald-400 hover:text-emerald-300" href="${u(o.chat_link)}">Чат проекта</a>`:o.chat_username?`<span class="text-slate-400">@${u(o.chat_username.replace(/^@/,""))}</span>`:o.chat_id?`<span class="text-slate-400">ID: ${u(String(o.chat_id))}</span>`:'<span class="text-slate-400">Чат не указан</span>':'<span class="text-slate-400">Чат не подключён</span>',m=i?"rounded-2xl border border-slate-800 bg-slate-950 p-5 shadow-lg shadow-emerald-500/10":"rounded-2xl border border-slate-800 bg-slate-950 p-5",f=o?`<div class="mt-2 text-sm text-slate-300">Проект: <span class="font-semibold text-slate-100">${u(o.name)}</span></div>`:'<div class="mt-2 text-sm text-slate-400">Проект не подключён</div>',p=`<div class="mt-1 text-sm text-slate-400">${d}</div>`,x=o&&o.summary&&o.summary.period_label?` (${u(String(o.summary.period_label))})`:"",_=`<div class="mt-3 text-sm text-slate-300">\uD83D\uDCB0 Потрачено: <span class="font-semibold text-emerald-300">${u(l)}</span>${x}</div>`,$=o?.updated_at||o?.last_sync||s.last_update||null,b=`<div class="mt-1 text-xs text-slate-500">Обновлено: ${u(M($))}</div>`,A=i&&o?`<div class="mt-4 flex flex-wrap gap-2"><button type="button" data-account-action="open-project" data-project="${u(o.id)}" class="rounded-lg bg-emerald-500 px-3 py-2 text-sm font-semibold text-slate-950 shadow-lg shadow-emerald-500/30 hover:bg-emerald-400">Открыть проект</button>${o.portal_url?`<a class="rounded-lg border border-slate-700 px-3 py-2 text-sm text-slate-200 hover:border-emerald-400 hover:text-emerald-300" href="${u(o.portal_url)}" target="_blank" rel="noreferrer">Портал</a>`:""}</div>`:"",T=!i?`<div class="mt-4 hidden" data-account-selector><p class="text-sm text-slate-300">Выберите чат-группу для подвязки:</p>${n()}<div class="mt-3 hidden space-y-3" data-account-confirm>${'<p class="text-sm text-slate-300" data-account-confirm-text></p>'}<div class="flex flex-wrap gap-2">${'<button type="button" data-account-action="change" class="rounded-lg border border-slate-700 px-3 py-2 text-sm text-slate-200 hover:border-emerald-400 hover:text-emerald-300">Изменить</button>'}<button type="button" data-account-action="confirm" data-account="${u(s.id)}" class="rounded-lg bg-emerald-500 px-3 py-2 text-sm font-semibold text-slate-950 shadow-lg shadow-emerald-500/30 hover:bg-emerald-400">Подвязать ✅</button>${"</div>"}</div>${"</div>"}</div>`:"",N=i?"":`<div class="mt-4"><button type="button" data-account-action="link" data-account="${u(s.id)}" class="rounded-lg border border-emerald-400 px-3 py-2 text-sm font-semibold text-emerald-300 hover:bg-emerald-500/10">Подключить</button></div>`;return`<div class="${m}" data-account-card="${u(s.id)}" data-account-name="${u(s.name||s.id)}"><div class="flex flex-col gap-1 md:flex-row md:items-start md:justify-between"><div><div class="text-lg font-semibold text-slate-100">${c} ${u(s.name||s.id)}</div><div class="text-sm text-slate-400">ID: ${u(s.id)}</div></div><div class="text-sm text-slate-400">Статус: ${u(s.status||"—")}</div></div>${f}${p}${_}${b}${A}${N}${T}</div>`}).join('<div class="h-px bg-slate-800"></div>')}</div>`},Jn=(t)=>{let e=t.billing||{},a=e.amount!==void 0&&e.amount!==null?k(e.amount,e.currency||t.currency||"USD"):"—",n=e.status?`<span class="inline-flex items-center rounded-full px-2 py-0.5 text-xs ${e.status==="overdue"?"bg-red-900/40 text-red-300":e.status==="due"?"bg-yellow-900/30 text-yellow-200":"bg-emerald-900/30 text-emerald-200"}">${u(e.status)}</span>`:'<span class="inline-flex items-center rounded-full bg-slate-800 px-2 py-0.5 text-xs text-slate-300">—</span>',r=e.next_payment||e.next_payment_date||"—",s=e.last_payment||"—";return`<tr class="border-b border-slate-800/60 hover:bg-slate-900/60"><td class="px-4 py-3 font-medium">${u(t.name)}</td><td class="px-4 py-3 text-sm text-slate-300">${u(String(t.billing_day??"—"))}</td><td class="px-4 py-3 text-sm text-slate-300">${u(s)}</td><td class="px-4 py-3 text-sm text-slate-300">${u(r)}</td><td class="px-4 py-3 text-sm text-slate-300">${u(a)}</td><td class="px-4 py-3 text-right">\${status}</td>\${'</tr>'}`},Vn=(t)=>{return`<div class="overflow-hidden rounded-2xl border border-slate-800 bg-slate-950"><div class="overflow-x-auto"><table class="min-w-full text-sm"><thead class="bg-slate-900 text-xs uppercase tracking-wide text-slate-400">${"<tr>"}<th class="px-4 py-3 text-left">Проект</th>${'<th class="px-4 py-3 text-left">День оплаты</th>'}<th class="px-4 py-3 text-left">Последняя оплата</th>${'<th class="px-4 py-3 text-left">Следующая оплата</th>'}<th class="px-4 py-3 text-left">Сумма</th>${'<th class="px-4 py-3 text-right">Статус</th>'}</tr></thead><tbody class="divide-y divide-slate-800">${t.map(Jn).join("")||'<tr><td colspan="6" class="px-4 py-6 text-center text-slate-400">Нет данных по оплатам</td></tr>'}</tbody></table></div></div>`},Yn=(t)=>{let e=t.toLowerCase();if(e==="ok")return"Активен";if(e==="missing")return"Не настроен";if(e==="expired")return"Истёк";if(e==="invalid")return"Недействителен";return t},zn=(t,e)=>{let a=Boolean(t.issues&&t.issues.length>0),n=!t.ok?"\uD83D\uDD34":a?"\uD83D\uDFE1":"\uD83D\uDFE2",r=a?`<ul class="mt-3 space-y-1 text-sm text-red-400">${t.issues.map((x)=>`<li>• ${u(x)}</li>`).join("")}</ul>`:'<p class="mt-3 text-sm text-slate-400">Подключение стабильно</p>',s=e.status||(e.ok?"ok":"invalid"),o=s==="ok"?"\uD83D\uDFE2":s==="expired"||s==="missing"?"\uD83D\uDD34":"\uD83D\uDFE1",i=e.issues&&e.issues.length?`<ul class="mt-3 space-y-1 text-xs text-red-300">${e.issues.map((x)=>`<li>• ${u(x)}</li>`).join("")}</ul>`:'<p class="mt-3 text-xs text-slate-400">Ошибок не обнаружено</p>',l=e.token_snippet?`<div class="text-xs text-slate-400">\uD83D\uDD11 Токен: ${u(e.token_snippet)}</div>`:'<div class="text-xs text-red-400">\uD83D\uDD11 Токен отсутствует</div>',c=[];if(e.expires_at)c.push(`⏳ Истекает: ${u(M(e.expires_at))}`);if(typeof e.expires_in_hours==="number"&&Number.isFinite(e.expires_in_hours))c.push(`≈ ${u(String(e.expires_in_hours))} ч`);let d=c.length?`<div class="text-xs text-slate-400">${c.join(" • ")}</div>`:'<div class="text-xs text-slate-500">⏳ Срок действия не определён</div>',m=e.refreshed_at?`<div class="text-xs text-slate-400">♻️ Обновлён: ${u(M(e.refreshed_at))}</div>`:t.last_refresh?`<div class="text-xs text-slate-500">♻️ Данные обновлены: ${u(M(t.last_refresh))}</div>`:"",f=e.should_refresh?'<span class="inline-flex items-center rounded-full bg-amber-500/20 px-2 py-0.5 text-xs font-semibold text-amber-300">Требуется обновить</span>':"",p=`<div class="mt-4 flex flex-wrap gap-2">${'<button type="button" data-tech-action="refresh-meta-token" data-confirm="Обновить Meta токен вручную?" class="rounded-lg bg-emerald-500 px-3 py-2 text-sm font-semibold text-slate-950 hover:bg-emerald-400">\uD83D\uDD04 Обновить токен</button>'}<button type="button" data-tech-action="clear-meta-cache" data-confirm="Очистить кэш статуса Facebook?" class="rounded-lg bg-slate-800 px-3 py-2 text-sm font-semibold text-slate-200 hover:bg-slate-700">\uD83E\uDDF9 Очистить кэш</button>${"</div>"}`;return`<div class="space-y-4"><div class="rounded-2xl border border-slate-800 bg-slate-950 p-6"><div class="flex flex-col gap-2 md:flex-row md:items-center md:justify-between"><div><h2 class="text-lg font-semibold">Статус Facebook</h2><p class="text-sm text-slate-300">${n} ${nt(t.account_name||"Неизвестно")}</p></div><div class="text-sm text-slate-400">Обновлено: ${nt(t.last_refresh||"—")}</div></div>${r}</div><div class="rounded-2xl border border-slate-800 bg-slate-950 p-6"><div class="flex flex-col gap-2 md:flex-row md:items-center md:justify-between"><div><h3 class="text-base font-semibold">Токен доступа</h3><p class="text-sm text-slate-300">${o} ${u(Yn(s))}</p>${f||""}</div><div class="text-right text-xs text-slate-500">${e.account_name?`${u(e.account_name)}<br>`:""}${e.account_id?`ID: ${u(e.account_id)}`:""}</div></div>${l}${d}${m}${i}${p}</div>\${'</div>'}`},Zn=(t)=>{if(!t.length)return'<div class="rounded-2xl border border-slate-800 bg-slate-950 p-6 text-sm text-slate-400">Нет данных об аккаунтах</div>';return`<div class="overflow-hidden rounded-2xl border border-slate-800 bg-slate-950"><div class="overflow-x-auto"><table class="min-w-full text-sm"><thead class="bg-slate-900 text-xs uppercase tracking-wide text-slate-400">${"<tr>"}<th class="px-4 py-3 text-left">Название</th>${'<th class="px-4 py-3 text-left">Статус</th>'}<th class="px-4 py-3 text-right">Баланс</th>${'<th class="px-4 py-3 text-right">Лимит</th>'}<th class="px-4 py-3 text-left">Оплата</th>${'<th class="px-4 py-3 text-left">Обновление</th>'}</tr></thead><tbody class="divide-y divide-slate-800">${t.map((a)=>`<tr class="border-b border-slate-800/60 hover:bg-slate-900/60"><td class="px-4 py-3 font-medium">${nt(a.name)}</td><td class="px-4 py-3 text-sm text-slate-300">${nt(a.status)}</td><td class="px-4 py-3 text-right">${u(k(a.balance??null,a.currency||"USD"))}</td><td class="px-4 py-3 text-right">${u(k(a.spend_cap??null,a.currency||"USD"))}</td><td class="px-4 py-3 text-sm text-slate-400">${nt(a.payment_method)}</td><td class="px-4 py-3 text-sm text-slate-400">\${safe(account.last_update)}</td>\${'</tr>'}`).join("")}</tbody></table></div></div>`},qn=(t)=>{return`<div class="space-y-3">${t.map((a)=>{let n=a.configured?"\uD83D\uDFE2":"\uD83D\uDD34",r=a.configured?"Настроено":"Отсутствует",s=a.hint?`<span class="text-slate-500">(${u(a.hint)})</span>`:"";return`<div class="flex items-center justify-between rounded-xl border border-slate-800 bg-slate-900 px-4 py-3"><div><div class="text-sm font-semibold">${n} ${u(a.name)}</div>${s}</div><div class="text-sm \${(token.configured ? 'text-emerald-400' : 'text-red-400')}">\${statusText}</div>\${'</div>'}`}).join("")||'<p class="text-sm text-slate-400">Нет данных</p>'}</div>`};var Qn=(t)=>{let a=[{label:"Отчёты",value:t.reports},{label:"Проекты",value:t.projects},{label:"Оплаты",value:t.billing},{label:"Алерты",value:t.alerts}].map((r)=>`<div class="rounded-xl border border-slate-800 bg-slate-900 p-4 text-center"><div class="text-2xl font-bold text-emerald-300">${u(String(r.value))}</div><div class="mt-1 text-xs uppercase tracking-wide text-slate-400">\${escapeHtml(cell.label)}</div>\${'</div>'}`).join(""),n=t.kvFallbacks===null||t.kvFallbacks===void 0?"":`<p class="mt-3 text-xs text-slate-400">Fallback KV записей: ${u(String(t.kvFallbacks))}</p>`;return`<div class="rounded-2xl border border-slate-800 bg-slate-950 p-6">${'<h2 class="text-lg font-semibold">Хранилище</h2>'}<div class="mt-4 grid gap-3 sm:grid-cols-2 lg:grid-cols-4">${a}</div>${n}</div>`},Xn={"projects-refresh":"Обновление отчётов","meta-token":"Проверка Meta токена"},tr=(t)=>{let e=t?Object.values(t):[];if(e.length===0)return`<div class="rounded-2xl border border-slate-800 bg-slate-950 p-6">${'<h2 class="text-lg font-semibold">Крон-задачи</h2>'}<p class="mt-2 text-sm text-slate-500">Отчёты о выполнении крон-задач появятся после первого запуска.</p>${"</div>"}`;return`<div class="rounded-2xl border border-slate-800 bg-slate-950 p-6">${'<h2 class="text-lg font-semibold">Крон-задачи</h2>'}<div class="mt-4 space-y-3">${e.sort((n,r)=>n.job.localeCompare(r.job)).map((n)=>{let r=n.ok?"\uD83D\uDFE2":"\uD83D\uDD34",s=Xn[n.job]||n.job,o=n.last_run&&n.last_run!=="1970-01-01T00:00:00.000Z"?n.last_run:null,i=o?M(o):"—",l=n.last_success&&n.last_success!=="1970-01-01T00:00:00.000Z"?M(n.last_success):null,c=n.failure_count&&n.failure_count>0?`<span class="rounded-full bg-red-900/60 px-2 py-0.5 text-[11px] text-red-200">${u(String(n.failure_count))}× ошибок</span>`:"",d=n.message?`<p class="mt-2 text-xs text-slate-400">${u(n.message)}</p>`:"",m=l?`<div class="text-xs text-slate-500">Последний успех: ${u(l)}</div>`:"";return`<div class="rounded-xl border border-slate-800 bg-slate-900 p-4"><div class="flex items-center justify-between"><div class="text-sm font-semibold">${r} ${u(s)}</div><div class="space-x-2 text-xs text-slate-400">${c}</div></div><div class="mt-1 text-xs text-slate-400">Последний запуск: ${u(i)}</div>${m}${d}</div>`}).join("")}</div></div>`},er=()=>{return`<div class="space-y-4 rounded-2xl border border-slate-800 bg-slate-950 p-6">${"<div>"}<h2 class="text-lg font-semibold">Системные инструменты</h2>${'<p class="mt-2 text-sm text-slate-400">Действия техподдержки: очистка кэшей, проверка вебхуков и массовые обновления.</p>'}</div>${'<div class="flex flex-wrap gap-2">'}<button type="button" data-tech-action="refresh-all" data-confirm="Запустить обновление всех отчётов? Это может занять несколько минут." class="rounded-lg bg-emerald-500 px-3 py-2 text-sm font-semibold text-slate-950 shadow-lg shadow-emerald-500/30 hover:bg-emerald-400">\uD83D\uDD04 Обновить все отчёты</button>${'<button type="button" data-tech-action="clear-meta-cache" data-confirm="Очистить кэш статуса Facebook?" class="rounded-lg bg-slate-800 px-3 py-2 text-sm font-semibold text-slate-200 hover:bg-slate-700">\uD83E\uDDF9 Очистить кэш Facebook</button>'}<button type="button" data-tech-action="clear-cache-prefix" data-confirm="Удалить объекты с указанным префиксом? Действие необратимо." data-prompt="Укажите префикс для очистки" data-prompt-field="prefix" data-prompt-default="cache/" class="rounded-lg bg-slate-800 px-3 py-2 text-sm font-semibold text-slate-200 hover:bg-slate-700">\uD83D\uDDC2 Очистить cache/*</button>${'<button type="button" data-tech-action="clear-fallbacks" data-confirm="Очистить fallback-записи из KV?" class="rounded-lg bg-slate-800 px-3 py-2 text-sm font-semibold text-slate-200 hover:bg-slate-700">♻️ Очистить fallback</button>'}<button type="button" data-tech-action="clear-project-report" data-confirm="Удалить кэш отчёта выбранного проекта?" data-prompt="Введите ID проекта для очистки отчёта" data-prompt-field="project_id" class="rounded-lg bg-slate-800 px-3 py-2 text-sm font-semibold text-slate-200 hover:bg-slate-700">\uD83E\uDDFD Очистить отчёт проекта</button>${'<button type="button" data-tech-action="check-telegram-webhook" data-prompt="Укажите токен бота (опционально) для проверки" data-prompt-field="token" data-prompt-optional="true" class="rounded-lg bg-slate-800 px-3 py-2 text-sm font-semibold text-slate-200 hover:bg-slate-700">\uD83E\uDD16 Проверить вебхук Telegram</button>'}</div><pre data-tech-output class="hidden whitespace-pre-wrap rounded-lg border border-slate-800 bg-slate-900/80 p-3 text-xs text-slate-200"></pre></div>`},ar=[{id:"projects",label:"Проекты"},{id:"accounts",label:"Рекламные аккаунты"},{id:"billing",label:"Оплаты"},{id:"facebook",label:"Facebook"},{id:"tech",label:"Тех.панель"}],nr=()=>{return`<div class="mb-6 flex flex-wrap gap-2">${ar.map((t,e)=>`<button data-tab-target="${t.id}" class="tab-button rounded-full px-4 py-2 text-sm font-medium ${e===0?"bg-emerald-500 text-slate-950 shadow-lg shadow-emerald-500/30":"bg-slate-800 text-slate-200 hover:bg-slate-700"}">${t.label}</button>`).join("")}</div>`},rr=(t)=>{return`<div><section data-tab-content="projects" class="tab-panel">${Gn(t.projects)}</section><section data-tab-content="accounts" class="tab-panel hidden">${Hn(t.projects,t.accounts)}</section><section data-tab-content="billing" class="tab-panel hidden">${Vn(t.projects)}</section><section data-tab-content="facebook" class="tab-panel hidden space-y-5">${zn(t.meta_status,t.meta_token)}${Zn(t.accounts)}</section><section data-tab-content="tech" class="tab-panel hidden space-y-5">${Qn(t.storage)}${tr(t.cron)}<div class="rounded-2xl border border-slate-800 bg-slate-950 p-6"><h2 class="text-lg font-semibold">Токены и ключи</h2><div class="mt-4">${qn(t.tokens)}</div></div>${er()}<div class="rounded-2xl border border-slate-800 bg-slate-950 p-6"><h2 class="text-lg font-semibold">Логи</h2>\${'<p class="mt-1 text-xs text-slate-500">Сводка последних событий воркера.</p>'}<div class="mt-4 space-y-3">\${renderLogs(dashboard.logs)}</div>\${'</div>'}</section>\${'</div>'}`},sr=`
(function(){
  const buttons = Array.from(document.querySelectorAll('[data-tab-target]'));
  const panels = Array.from(document.querySelectorAll('[data-tab-content]'));
  const activate = (id) => {
    panels.forEach((panel) => {
      if (panel.getAttribute('data-tab-content') === id) {
        panel.classList.remove('hidden');
      } else {
        panel.classList.add('hidden');
      }
    });
    buttons.forEach((button) => {
      if (button.getAttribute('data-tab-target') === id) {
        button.classList.add('bg-emerald-500','text-slate-950','shadow-lg','shadow-emerald-500/30');
        button.classList.remove('bg-slate-800','text-slate-200');
      } else {
        button.classList.remove('bg-emerald-500','text-slate-950','shadow-lg','shadow-emerald-500/30');
        button.classList.add('bg-slate-800','text-slate-200');
      }
    });
  };
  buttons.forEach((button) => {
    button.addEventListener('click', () => {
      const id = button.getAttribute('data-tab-target');
      if (id) {
        activate(id);
      }
    });
  });
})();
`,ho=["(function(){","  const params = new URLSearchParams(window.location.search);","  const adminKey = params.get('key');","  const buildUrl = function(path){","    var url = new URL(path, window.location.origin);","    if (adminKey) {","      url.searchParams.set('key', adminKey);","    }","    return url.toString();","  };","  const techOutput = document.querySelector('[data-tech-output]');","  const updateTechOutput = function(data, isError){","    if (!techOutput) { return; }","    techOutput.classList.remove('hidden');","    ['border-emerald-600','text-emerald-200','border-red-600','text-red-300'].forEach(function(cls){ techOutput.classList.remove(cls); });","    var content = '';","    if (typeof data === 'string') {","      content = data;","    } else if (data) {","      try {","        content = JSON.stringify(data, null, 2);","      } catch (_error) {","        content = String(data);","      }","    } else {","      content = isError ? 'Ошибка' : 'Операция выполнена';","    }","    techOutput.textContent = content;","    var classes = isError ? ['border-red-600','text-red-300'] : ['border-emerald-600','text-emerald-200'];","    classes.forEach(function(cls){ techOutput.classList.add(cls); });","  };","  const parseJsonSafe = function(text){","    if (!text) { return null; }","    try {","      return JSON.parse(text);","    } catch (_error) {","      return { raw: text };","    }","  };","  const toggleForm = function(card, selector){","    if (!card) { return; }","    var target = card.querySelector(selector);","    card.querySelectorAll('form[data-admin-form]').forEach(function(form){","      if (form !== target) { form.classList.add('hidden'); }","    });","    if (target) {","      target.classList.toggle('hidden');","    }","  };","  const resetAccountSelector = function(card){","    if (!card) { return; }","    card.removeAttribute('data-selected-project');","    var selector = card.querySelector('[data-account-selector]');","    if (selector) { selector.classList.remove('hidden'); }","    var confirmBlock = card.querySelector('[data-account-confirm]');","    if (confirmBlock) { confirmBlock.classList.add('hidden'); }","    card.querySelectorAll('[data-account-chat]').forEach(function(btn){","      btn.classList.remove('border-emerald-400','text-emerald-300','bg-emerald-500/10');","      btn.classList.add('border-slate-700','text-slate-200');","    });","  };","  const handleAccountChatSelect = function(button){","    var card = button.closest('[data-account-card]');","    if (!card) { return; }","    var projectId = button.getAttribute('data-project');","    var projectName = button.getAttribute('data-project-name') || '';","    if (!projectId) { return; }","    card.setAttribute('data-selected-project', projectId);","    card.querySelectorAll('[data-account-chat]').forEach(function(btn){","      btn.classList.remove('border-emerald-400','text-emerald-300','bg-emerald-500/10');","      btn.classList.add('border-slate-700','text-slate-200');","    });","    button.classList.remove('border-slate-700','text-slate-200');","    button.classList.add('border-emerald-400','text-emerald-300','bg-emerald-500/10');","    var confirmBlock = card.querySelector('[data-account-confirm]');","    if (confirmBlock) {","      confirmBlock.classList.remove('hidden');","      var text = confirmBlock.querySelector('[data-account-confirm-text]');","      if (text) {","        var accountName = card.getAttribute('data-account-name') || '';","        text.textContent = `Подвязать «${accountName}» к «${projectName}»?`;","      }",`      var confirmButton = confirmBlock.querySelector('[data-account-action="confirm"]');`,"      if (confirmButton) { confirmButton.setAttribute('data-project', projectId); }","    }","  };","  const handleAccountAction = async function(button){","    var action = button.getAttribute('data-account-action');","    if (!action) { return; }","    var card = button.closest('[data-account-card]');","    if (!card) { return; }","    if (action === 'open-project') {","      var projectId = button.getAttribute('data-project');","      if (!projectId) { return; }","      activate('projects');",'      var projectCard = document.querySelector(`[data-project-card="${projectId}"]`);',"      if (projectCard) {","        projectCard.scrollIntoView({ behavior: 'smooth', block: 'start' });","        projectCard.classList.add('ring','ring-emerald-500');","        window.setTimeout(function(){ projectCard.classList.remove('ring','ring-emerald-500'); }, 2000);","      }","      return;","    }","    if (action === 'link') {","      var selector = card.querySelector('[data-account-selector]');","      if (selector) { selector.classList.remove('hidden'); }","      resetAccountSelector(card);","      return;","    }","    if (action === 'change') {","      resetAccountSelector(card);","      return;","    }","    if (action === 'confirm') {","      var projectId = button.getAttribute('data-project');","      var accountId = card.getAttribute('data-account-card');","      if (!projectId || !accountId) {","        alert('Выберите чат перед подтверждением.');","        return;","      }","      button.disabled = true;","      button.classList.add('opacity-60');","      try {","        var response = await fetch(buildUrl(`/api/admin/account/${accountId}/link`), {","          method: 'POST',","          headers: { 'content-type': 'application/json' },","          body: JSON.stringify({ project_id: projectId })","        });","        if (!response.ok) {","          var text = await response.text();","          throw new Error(text || 'Request failed');","        }","        window.location.reload();","      } catch (error) {","        console.error('Account link failed', error);","        alert(`Не удалось подвязать аккаунт: ${error && error.message ? error.message : 'ошибка'}`);","      } finally {","        button.disabled = false;","        button.classList.remove('opacity-60');","      }","      return;","    }","  };","  const handleTechAction = async function(button){","    var action = button.getAttribute('data-tech-action');","    if (!action) {","      return;","    }","    var confirmMessage = button.getAttribute('data-confirm');","    if (confirmMessage && !window.confirm(confirmMessage)) {","      return;","    }","    var payload = { action: action };","    var promptField = button.getAttribute('data-prompt-field');","    if (promptField) {","      var promptMessage = button.getAttribute('data-prompt') || '';","      var promptDefault = button.getAttribute('data-prompt-default') || '';","      var optional = button.getAttribute('data-prompt-optional') === 'true';","      var response = window.prompt(promptMessage || 'Введите значение', promptDefault);","      if (response === null) {","        return;","      }","      var trimmed = response.trim();","      if (!trimmed) {","        if (promptDefault && !optional) {","          payload[promptField] = promptDefault.trim();","        } else if (!optional) {","          alert('Значение не указано');","          return;","        }","      } else {","        payload[promptField] = trimmed;","      }","    }","    button.disabled = true;","    button.classList.add('opacity-60');","    try {","      var response = await fetch(buildUrl('/api/admin/system'), {","        method: 'POST',","        headers: { 'content-type': 'application/json' },","        body: JSON.stringify(payload)","      });","      var text = await response.text();","      var data = parseJsonSafe(text);","      if (!response.ok) {","        updateTechOutput(data || text || 'Ошибка', true);","        throw new Error(data && data.error ? data.error : (text || 'Request failed'));","      }","      updateTechOutput(data || { ok: true }, false);","      if (action === 'refresh-all' || action === 'refresh-meta-token') {","        window.setTimeout(function(){ window.location.reload(); }, 1500);","      }","    } catch (error) {","      console.error('Tech action failed', error);","      if (!techOutput) {","        alert(`Ошибка: ${error && error.message ? error.message : 'неизвестная ошибка'}`);","      }","    } finally {","      button.disabled = false;","      button.classList.remove('opacity-60');","    }","  };","  const handleAction = async function(button){","    var action = button.getAttribute('data-admin-action');","    if (!action) {","      return;","    }","    if (action === 'edit-project' || action === 'edit-billing') {","      var card = button.closest('[data-project-card]');",`      toggleForm(card, action === 'edit-project' ? 'form[data-admin-form="update-project"]' : 'form[data-admin-form="update-billing"]');`,"      return;","    }","    if (action === 'cancel-edit') {","      var cancelCard = button.closest('[data-project-card]');","      if (cancelCard) {","        cancelCard.querySelectorAll('form[data-admin-form]').forEach(function(form){ form.classList.add('hidden'); });","      }","      return;","    }","    var project = button.getAttribute('data-project');","    if (!project) {","      return;","    }","    var endpoint = '';","    var options = { method: 'POST', headers: {} };","    var body = null;","    if (action === 'toggle-alerts') {","      endpoint = `/api/admin/project/${project}/toggle`;","      body = JSON.stringify({ field: 'alerts_enabled' });","      options.headers['content-type'] = 'application/json';","    } else if (action === 'toggle-silent') {","      endpoint = `/api/admin/project/${project}/toggle`;","      body = JSON.stringify({ field: 'silent_weekends' });","      options.headers['content-type'] = 'application/json';","    } else if (action === 'refresh-project') {","      endpoint = `/api/project/${project}/refresh`;","    } else {","      return;","    }","    button.disabled = true;","    button.classList.add('opacity-60');","    try {","      if (body !== null) {","        options.body = body;","      }","      var response = await fetch(buildUrl(endpoint), options);","      if (!response.ok) {","        var text = await response.text();","        throw new Error(text || 'Request failed');","      }","      window.location.reload();","    } catch (error) {","      console.error('Admin action failed', error);","      alert(`Не удалось выполнить действие: ${error && error.message ? error.message : 'ошибка'}`);","    } finally {","      button.disabled = false;","      button.classList.remove('opacity-60');","    }","  };","  const handleFormSubmit = async function(form){","    var type = form.getAttribute('data-admin-form');","    if (!type) {","      return;","    }","    var project = form.getAttribute('data-project') || '';","    var endpoint = '';","    if (type === 'create-project') {","      endpoint = '/api/admin';","    } else if (type === 'update-project') {","      if (!project) { alert('Не выбран проект'); return; }","      endpoint = `/api/admin/project/${project}`;","    } else if (type === 'update-billing') {","      if (!project) { alert('Не выбран проект'); return; }","      endpoint = `/api/admin/project/${project}/billing`;","    } else {","      return;","    }","    var data = {};","    var formData = new FormData(form);","    formData.forEach(function(value, key){","      if (typeof value === 'string') {","        var trimmed = value.trim();","        if (trimmed) {","          data[key] = trimmed;","        }","      }","    });","    if (type === 'create-project' && !data.id) {","      alert('Укажите ID проекта');","      return;","    }",`    var submitButton = form.querySelector('button[type="submit"]');`,"    if (submitButton) {","      submitButton.disabled = true;","      submitButton.classList.add('opacity-60');","    }","    try {","      var response = await fetch(buildUrl(endpoint), {","        method: 'POST',","        headers: { 'content-type': 'application/json' },","        body: JSON.stringify(data)","      });","      if (!response.ok) {","        var text = await response.text();","        throw new Error(text || 'Request failed');","      }","      window.location.reload();","    } catch (error) {","      console.error('Admin form submission failed', error);","      alert(`Не удалось сохранить изменения: ${error && error.message ? error.message : 'ошибка'}`);","    } finally {","      if (submitButton) {","        submitButton.disabled = false;","        submitButton.classList.remove('opacity-60');","      }","    }","  };","  document.addEventListener('click', function(event){","    var target = event.target instanceof HTMLElement ? event.target.closest('button') : null;","    if (!target) {","      return;","    }","    if (target.hasAttribute('data-account-chat')) {","      event.preventDefault();","      handleAccountChatSelect(target);","      return;","    }","    if (target.hasAttribute('data-account-action')) {","      event.preventDefault();","      handleAccountAction(target);","      return;","    }","    if (target.hasAttribute('data-tech-action')) {","      event.preventDefault();","      handleTechAction(target);","      return;","    }","    if (target.hasAttribute('data-admin-action')) {","      event.preventDefault();","      handleAction(target);","    }","  });","  document.addEventListener('submit', function(event){","    var form = event.target;","    if (form instanceof HTMLFormElement && form.hasAttribute('data-admin-form')) {","      event.preventDefault();","      handleFormSubmit(form);","    }","  });","})();"].join(`
`),aa=(t)=>{let e=z([nr(),rr(t)]),a=`<div class="p-6 space-y-6">${'<div class="text-sm font-semibold uppercase text-slate-500">Навигация</div>'}<nav class="space-y-2 text-sm">${'<a class="block rounded-lg bg-slate-900 px-3 py-2 text-emerald-400" href="/admin">Админ-панель</a>'}<a class="block rounded-lg px-3 py-2 text-slate-300 hover:bg-slate-900" href="/api/projects">Список проектов (API)</a>${'<a class="block rounded-lg px-3 py-2 text-slate-300 hover:bg-slate-900" href="/api/meta/status">Статус Meta (API)</a>'}<a class="block rounded-lg px-3 py-2 text-slate-300 hover:bg-slate-900" href="/api/ping">Проверка воркера</a>${"</nav>"}</div>`,n=`<script>${sr}</script><script>\${ACTION_SCRIPT}</script>`;return Ct(e,{title:"Админ-панель",sidebar:a,scripts:n})};var rt=(t)=>{if(t.length<=6)return`${t.slice(0,2)}****`;let e=t.slice(0,5),a=t.slice(-4);return`${e}****${a}`},or=(t,e,a)=>{let n=typeof e.ADMIN_KEY==="string"?e.ADMIN_KEY:null,r=t.headers.get("authorization");if(r){if(!n)return K("Admin key is not configured");if(r!==`Bearer ${n}`)return K("Invalid authorization header");return null}let s=typeof e.BOT_TOKEN==="string"?e.BOT_TOKEN:null;if(a&&s&&a===s)return null;return K("Unauthorized. Provide ADMIN_KEY or valid bot token.")},ir=(t,e,a)=>{let n=typeof e.ADMIN_KEY==="string"?e.ADMIN_KEY.trim():"",r=t.headers.get("authorization");if(r){if(!n)return K("Admin key is not configured");if(r!==`Bearer ${n}`)return K("Invalid admin key");return null}let s=typeof e.META_MANAGE_TOKEN==="string"?e.META_MANAGE_TOKEN.trim():"";if(!s)return K("Manage token is not configured");if(!a||a.trim()!==s)return K("Invalid manage token");return null},na=(t)=>{let e=[];if(typeof t.BOT_TOKEN==="string"&&t.BOT_TOKEN)e.push(t.BOT_TOKEN);if(typeof t.TELEGRAM_BOT_TOKEN==="string"&&t.TELEGRAM_BOT_TOKEN)e.push(t.TELEGRAM_BOT_TOKEN);if(typeof t.TG_API_TOKEN==="string"&&t.TG_API_TOKEN)e.push(t.TG_API_TOKEN);return e},Dt=async(t,e,a=null)=>{let n=`https://api.telegram.org/bot${t}/${e}`,r=a!==null&&Object.keys(a).length>0,s=await fetch(n,{method:"POST",headers:{"content-type":"application/json"},body:r?JSON.stringify(a):void 0}),o=await s.text(),i;try{i=JSON.parse(o)}catch(l){throw new Error("Telegram API returned non-JSON response")}if(!s.ok){let l=i.description||"Telegram API request failed";throw new Error(l)}return i},lr=()=>{return h({ok:!1,error:"Invalid action",usage:{status:"/manage/telegram/webhook?action=status&token=<BOT_TOKEN>",drop:"/manage/telegram/webhook?action=drop&token=<BOT_TOKEN>",refresh:"/manage/telegram/webhook?action=refresh&token=<BOT_TOKEN>&url=https://example.com/telegram/<bot_id>&drop=1"}})},Bt=async(t,e)=>{let a=na(t),n=e&&e.trim()?e.trim():a[0];if(!n)return{ok:!1,error:"Bot token is not configured"};if(!a.includes(n))return{ok:!1,token:rt(n),error:"Provided token is not allowed"};try{let r=await Dt(n,"getWebhookInfo");return{ok:!0,token:rt(n),webhook:r.result??r}}catch(r){return{ok:!1,token:rt(n),error:r.message||"Telegram API request failed"}}},ra=async(t,e)=>{if(t.method!=="GET")return E("Method not allowed");let a=new URL(t.url),n=(a.searchParams.get("action")||"status").toLowerCase(),r=a.searchParams.get("token")||"",s=a.searchParams.get("url")||"",o=a.searchParams.get("drop")==="1",i=or(t,e,r);if(i)return i;if(!r)return E("Missing token parameter");if(!na(e).includes(r))return K("Provided token is not allowed");try{if(n==="status"){let c=await Dt(r,"getWebhookInfo");return h({ok:!0,token:rt(r),webhook:c.result??c})}if(n==="drop"){let c=await Dt(r,"deleteWebhook");if(!c.ok)return h({ok:!1,token:rt(r),error:c.description||"Failed to delete webhook"},{status:502});return h({ok:!0,message:"Webhook deleted",token:rt(r)})}if(n==="refresh"){if(!s)return E("Missing url parameter");if(o)await Dt(r,"deleteWebhook");let c=await Dt(r,"setWebhook",{url:s});if(!c.ok)return h({ok:!1,token:rt(r),error:c.description||"Failed to set webhook"},{status:502});let d=await Dt(r,"getWebhookInfo");return h({ok:!0,message:"Webhook updated",token:rt(r),webhook:d.result??d})}return lr()}catch(c){let d=c.message||"Unknown error";return h({ok:!1,token:rt(r),error:d},{status:500})}},cr=async(t)=>{let e=await P(t,_t);if(!e)return null;return{...e,cached:!0}},sa=async(t,e)=>{if(t.method!=="GET")return E("Method not allowed");let a=new URL(t.url),n=(a.searchParams.get("token")||"").trim(),r=(a.searchParams.get("action")||"status").toLowerCase(),s=a.searchParams.get("refresh"),o=ir(t,e,n);if(o)return o;if(r==="clear"){let f=await Et(e);return await w(e,{level:"info",message:"Meta status cache cleared via /manage/meta",timestamp:new Date().toISOString()}),h({ok:f,cleared:f})}let i=r==="refresh"||s==="1",l=null,c=null;try{l=await et(e,{useCache:!i})}catch(f){c=f.message||"Unknown error";let p=await cr(e);if(p)l=p;else return await w(e,{level:"error",message:`Meta manage status failed: ${c}`,timestamp:new Date().toISOString()}),Ht({ok:!1,error:c})}let d;try{d=await Z(e)}catch(f){d={ok:!1,status:"invalid",valid:!1,issues:[f.message||"Meta token check failed"],expires_at:null,expires_in_hours:null,should_refresh:null,token_snippet:null,account_id:null,account_name:null,refreshed_at:null}}let m={ok:Boolean(l?.ok),cached:Boolean(l?.cached),refreshed:i&&!l?.cached,updated_at:l?.updated_at||null,status:l,token:d,message:c||void 0};if(i&&!m.cached)await w(e,{level:"info",message:"Meta status refreshed via /manage/meta",timestamp:new Date().toISOString()});return h(m)};var dr=(()=>{let t=new Date,e=new Date(Date.now()-86400000),a=(n)=>n.toISOString().slice(0,10);return[`logs/${a(t)}.json`,`logs/${a(e)}.json`]})(),oa=async(t)=>{let e=[];for(let a of dr){let n=await P(t,a);if(Array.isArray(n))e.push(...n)}return e.sort((a,n)=>new Date(a.timestamp).getTime()-new Date(n.timestamp).getTime())},ae=(t,e)=>{let a=new Set;for(let n of t){if(!n.startsWith(e)||!n.endsWith(".json"))continue;let r=n.slice(e.length).replace(/\.json$/,"");if(!r||r.includes("/"))continue;if(r==="index"||r==="projects")continue;a.add(r)}return a.size},ia=async(t)=>{let[e,a,n,r,s]=await Promise.all([W(t,"reports/"),W(t,"projects/"),W(t,"billing/"),W(t,"alerts/"),Vt(t)]);return{reports:ae(e,"reports/"),projects:ae(a,"projects/"),billing:ae(n,"billing/"),alerts:ae(r,"alerts/"),kvFallbacks:s}},ur="ADMIN_KEY",mr=(t)=>{let e=t.headers.get("Authorization");if(e&&e.toLowerCase().startsWith("bearer ")){let r=e.slice(7).trim();if(r)return r}let n=new URL(t.url).searchParams.get("key");return n&&n.trim()?n.trim():null},pr=(t,e)=>{let a=String(e[ur]||"");if(!a)return!0;return mr(t)===a},B=(t,e)=>{if(pr(t,e))return null;return K("Invalid admin key")},xt=(t)=>typeof t==="string"&&t.trim().length>0,la=(t)=>{let e=xt(t.BOT_TOKEN)||xt(t.TELEGRAM_BOT_TOKEN)||xt(t.TG_API_TOKEN),a=xt(t.META_LONG_TOKEN)||xt(t.META_ACCESS_TOKEN),n=xt(t.META_MANAGE_TOKEN),r=xt(t.ADMIN_KEY),s=Boolean(t.REPORTS_BUCKET||t.R2_BUCKET||t.BOT_BUCKET||t.STORAGE_BUCKET);return[{name:"Telegram Bot Token",configured:e,hint:"BOT_TOKEN"},{name:"Meta Access Token",configured:a,hint:"META_LONG_TOKEN"},{name:"Meta Manage Token",configured:n,hint:"META_MANAGE_TOKEN"},{name:"Admin Key",configured:r,hint:"ADMIN_KEY"},{name:"R2 Bucket",configured:s,hint:"R2_BUCKET"}]},wt=async(t)=>{let e=await t.text();if(!e.trim())return{};try{return JSON.parse(e)}catch(a){return null}},R=(t)=>{if(typeof t==="string"){let e=t.trim();return e?e:null}if(typeof t==="number"&&Number.isFinite(t))return String(t);return null},ct=(t)=>{if(typeof t==="number"&&Number.isFinite(t))return t;if(typeof t==="string"){let e=Number(t);return Number.isFinite(e)?e:null}return null},ca=(t)=>{let e={},a=R(t?.name);if(a!==null)e.name=a;if("chat_id"in t){if(t.chat_id===null)e.chat_id=null;else if(typeof t.chat_id==="string"||typeof t.chat_id==="number")e.chat_id=t.chat_id}let n=R(t?.chat_username);if(n!==null)e.chat_username=n;if("chat_username"in t&&n===null&&t.chat_username===null)e.chat_username=null;let r=R(t?.chat_link);if(r!==null)e.chat_link=r;if("chat_link"in t&&r===null&&t.chat_link===null)e.chat_link=null;let s=R(t?.account_id);if(s!==null)e.account_id=s;if("account_id"in t&&s===null&&t.account_id===null)e.account_id=null;let o=R(t?.account_name);if(o!==null)e.account_name=o;if("account_name"in t&&o===null&&t.account_name===null)e.account_name=null;let i=ct(t?.billing_day);if(i!==null)e.billing_day=i;if("billing_day"in t&&i===null&&t.billing_day===null)e.billing_day=null;let l=R(t?.status);if(l!==null)e.status=l;if("status"in t&&l===null&&t.status===null)e.status=null;if(typeof t?.alerts_enabled==="boolean")e.alerts_enabled=t.alerts_enabled;if(typeof t?.silent_weekends==="boolean")e.silent_weekends=t.silent_weekends;let c=R(t?.manager);if(c!==null)e.manager=c;if("manager"in t&&c===null&&t.manager===null)e.manager=null;let d=R(t?.portal_url);if(d!==null)e.portal_url=d;if("portal_url"in t&&d===null&&t.portal_url===null)e.portal_url=null;let m=R(t?.last_sync);if(m!==null)e.last_sync=m;if("last_sync"in t&&m===null&&t.last_sync===null)e.last_sync=null;return e},fr=(t)=>{let e={},a=ct(t?.amount);if(a!==null)e.amount=a;if("amount"in t&&a===null&&t.amount===null)e.amount=null;let n=ct(t?.spend_limit);if(n!==null)e.spend_limit=n;if("spend_limit"in t&&n===null&&t.spend_limit===null)e.spend_limit=null;let r=ct(t?.days_to_pay);if(r!==null)e.days_to_pay=r;if("days_to_pay"in t&&r===null&&t.days_to_pay===null)e.days_to_pay=null;let s=R(t?.currency);if(s!==null)e.currency=s;if("currency"in t&&s===null&&t.currency===null)e.currency=null;let o=R(t?.next_payment);if(o!==null)e.next_payment=o;if("next_payment"in t&&o===null&&t.next_payment===null)e.next_payment=null;let i=R(t?.next_payment_date);if(i!==null)e.next_payment_date=i;if("next_payment_date"in t&&i===null&&t.next_payment_date===null)e.next_payment_date=null;let l=R(t?.last_payment);if(l!==null)e.last_payment=l;if("last_payment"in t&&l===null&&t.last_payment===null)e.last_payment=null;let c=R(t?.card_last4);if(c!==null)e.card_last4=c;if("card_last4"in t&&c===null&&t.card_last4===null)e.card_last4=null;let d=R(t?.status);if(d!==null)e.status=d;if("status"in t&&d===null&&t.status===null)e.status=null;return e},gr=(t)=>{let e={},a=R(t?.chat_id);if(a!==null)e.chat_id=a;if("chat_id"in t&&a===null&&t.chat_id===null)e.chat_id=null;let n=R(t?.admin_chat_id);if(n!==null)e.admin_chat_id=n;if("admin_chat_id"in t&&n===null&&t.admin_chat_id===null)e.admin_chat_id=null;let r=ct(t?.cpa_threshold);if(r!==null)e.cpa_threshold=r;if("cpa_threshold"in t&&r===null&&t.cpa_threshold===null)e.cpa_threshold=null;let s=ct(t?.spend_limit);if(s!==null)e.spend_limit=s;if("spend_limit"in t&&s===null&&t.spend_limit===null)e.spend_limit=null;let o=ct(t?.moderation_hours);if(o!==null)e.moderation_hours=o;if("moderation_hours"in t&&o===null&&t.moderation_hours===null)e.moderation_hours=null;let i=ct(t?.message_thread_id);if(i!==null)e.message_thread_id=i;if("message_thread_id"in t&&i===null&&t.message_thread_id===null)e.message_thread_id=null;return e},Ot=(t)=>{let e=t.trim();if(!e)throw new Error("Project ID is required");return e},v=async(t,e)=>{await w(t,{level:"info",message:e,timestamp:new Date().toISOString()})},da=async(t,e)=>{let a=B(t,e);if(a)return a;let[n,r,s,o,i,l]=await Promise.all([et(e,{useCache:!0}).catch((m)=>({ok:!1,issues:[m.message]})),Z(e).catch((m)=>({ok:!1,status:"invalid",valid:!1,issues:[m.message],token_snippet:null,account_id:null,account_name:null,refreshed_at:null})),Tt(e),C(e),oa(e),ia(e)]),c={meta_status:n,meta_token:r,accounts:s,projects:o,logs:i,tokens:la(e),storage:l},d=aa(c);return new Response(d,{headers:{"content-type":"text/html; charset=utf-8"}})};var ua=async(t)=>{let e=await bt(t);return new Response(null,{status:303,headers:{Location:"/admin","x-refreshed-projects":e.refreshed.join(",")}})},hr=async(t,e)=>{return P(t,`reports/${e}.json`)},ma=async(t,e)=>{let a=B(t,e);if(a)return a;let n=await C(e);return h({projects:n})},pa=async(t,e)=>{let a=B(t,e);if(a)return a;let[n,r]=await Promise.all([C(e),Tt(e)]),s=await Promise.all(r.map(async(i)=>{let l=Pt(n,i.id),c=await ee(e,l),d=l?pt(l):!1,m=c&&c.value!==null?k(c.value,c.currency):"—";return{id:i.id,name:i.name,status:i.status||null,status_icon:gt(i.status),currency:c?c.currency:i.currency||"USD",spend_value:c?c.value:null,spend_label:c?c.label:null,spend_formatted:m,balance:i.balance??null,spend_cap:i.spend_cap??null,payment_method:i.payment_method||null,last_update:i.last_update||null,project_id:l?l.id:null,project_name:l?l.name:null,project_chat:d?vt(l):null,chat_link:l?.chat_link||null,chat_username:l?.chat_username||null,chat_id:l?.chat_id?String(l.chat_id):null,has_chat:d}})),o=Lt(n).map((i)=>({id:i.id,name:i.name,chat_label:vt(i),chat_link:i.chat_link||null,chat_username:i.chat_username||null,chat_id:i.chat_id?String(i.chat_id):null}));return h({accounts:s,available_chats:o,updated_at:new Date().toISOString()})},fa=async(t,e,a)=>{let n=B(t,e);if(n)return n;let r=R(a);if(!r)return E("Account id is required");let s=await wt(t);if(s===null)return E("Invalid JSON body");let o=R(s?.project_id);if(!o)return E("Project id is required");let[i,l]=await Promise.all([C(e),Tt(e)]),c=i.find((_)=>_.id===o)||null;if(!c)return Y("Project not found");let d=Pt(i,r);if(d&&d.id!==c.id)return E("Account already linked to another project");let m=l.find((_)=>_.id===r)||null,f=R(s?.account_name)||R(s?.name)||(m&&m.name?m.name:null)||r,p={account_id:r,account_name:f},x=await ot(e,c.id,p);if(!x)return h({error:"Unable to persist project config"},{status:500});if(await v(e,`Admin linked account ${r} to project ${c.id}`),!pt(c))await w(e,{level:"warn",message:`Account ${r} linked to project ${c.id} without chat binding`,timestamp:new Date().toISOString()});return h({ok:!0,project:x})},ga=async(t,e,a)=>{let n=B(t,e);if(n)return n;let[r,s,o,i,l]=await Promise.all([C(e).then((c)=>c.find((d)=>d.id===a)||null),hr(e,a),jt(e,a),he(e,a),be(e,a)]);if(!r&&!s&&!o)return Y("Project not found");return h({id:a,card:r,report:s,config:o,billing:i,alerts:l})},ha=async(t,e)=>{let a=B(t,e);if(a)return a;let n=await wt(t);if(n===null)return E("Invalid JSON body");let r=R(n?.id);if(!r)return E("Project id is required");let s=Ot(r),o=ca(n);if(!o.name)o.name=s;let i=await ot(e,s,o);if(!i)return h({error:"Unable to persist project config"},{status:500});return await v(e,`Admin saved project config for ${s}`),h({ok:!0,project:i})},ba=async(t,e,a)=>{let n=B(t,e);if(n)return n;let r=Ot(a),s=await wt(t);if(s===null)return E("Invalid JSON body");let o=ca(s),i=await ot(e,r,o);if(!i)return h({error:"Unable to persist project config"},{status:500});return await v(e,`Admin updated project config for ${r}`),h({ok:!0,project:i})},_a=async(t,e,a)=>{let n=B(t,e);if(n)return n;let r=Ot(a),s=await wt(t);if(s===null)return E("Invalid JSON body");let o=typeof s.field==="string"?s.field.trim():"";if(o!=="alerts_enabled"&&o!=="silent_weekends")return E("Unsupported toggle field");let i=await jt(e,r),c=!(i&&typeof i[o]==="boolean"?Boolean(i[o]):!1),d={};d[o]=c;let m=await ot(e,r,d);if(!m)return h({error:"Unable to persist project toggle"},{status:500});return await v(e,`Admin toggled ${o} for ${r} => ${String(c)}`),h({ok:!0,field:o,value:c,project:m})},ya=async(t,e,a)=>{let n=B(t,e);if(n)return n;let r=Ot(a),s=await wt(t);if(s===null)return E("Invalid JSON body");let o=fr(s),i=await Zt(e,r,o);if(!i)return h({error:"Unable to persist billing info"},{status:500});return await v(e,`Admin updated billing info for ${r}`),h({ok:!0,billing:i})},xa=async(t,e,a)=>{let n=B(t,e);if(n)return n;let r=Ot(a),s=await wt(t);if(s===null)return E("Invalid JSON body");let o=gr(s),i=await qt(e,r,o);if(!i)return h({error:"Unable to persist alerts config"},{status:500});return await v(e,`Admin updated alerts config for ${r}`),h({ok:!0,alerts:i})},wa=async(t,e)=>{let a=B(t,e);if(a)return a;let n=await oa(e);return h({logs:n})},ka=async(t,e)=>{let a=B(t,e);if(a)return a;let r=(await C(e)).map((s)=>({id:s.id,name:s.name,billing:s.billing||null,billing_day:s.billing_day??null,status:s.status||null})).sort((s,o)=>s.name.localeCompare(o.name,"ru"));return h({billing:r})},$a=async(t,e)=>{let a=B(t,e);if(a)return a;let[n,r,s,o,i,l]=await Promise.all([et(e,{useCache:!0}).catch((c)=>({ok:!1,issues:[c.message]})),Z(e).catch((c)=>({ok:!1,status:"invalid",valid:!1,issues:[c.message],token_snippet:null,account_id:null,account_name:null,refreshed_at:null})),Promise.resolve(la(e)),ia(e),Bt(e).catch(()=>null),Nt(e).catch(()=>({}))]);return h({meta:n,token:r,tokens:s,storage:o,webhook:i,cron:l})},Aa=async(t,e)=>{let a=B(t,e);if(a)return a;let n=await wt(t);if(n===null)return E("Invalid JSON body");let r=R(n?.action);if(!r)return E("Action is required");if(r==="refresh-all"){let s=await bt(e);return await v(e,`Admin triggered refresh-all for ${s.refreshed.length} projects`),h({ok:!0,refreshed:s.refreshed})}if(r==="refresh-meta-token"){let s=await at(e,{force:!0,notify:!0}),o=s.refresh&&s.refresh.ok?"success":"failure",i=s.refresh&&s.refresh.message?`: ${s.refresh.message}`:"",l=`Admin requested Meta token refresh => ${o}${i}`;return await v(e,l),h(s)}if(r==="clear-meta-cache"){let s=await Et(e);if(s)await v(e,"Admin cleared Facebook status cache");return h({ok:Boolean(s),key:_t})}if(r==="clear-cache-prefix"){let s=R(n?.prefix)||"cache/";if(!s)return E("Prefix is required");let o=await Jt(e,s);return await v(e,`Admin cleared cache prefix ${s} => ${o} items`),h({ok:!0,prefix:s,removed:o})}if(r==="clear-project-report"){let s=R(n?.project_id);if(!s)return E("Project ID is required");let o=Ot(s),i=`reports/${o}.json`,l=await mt(e,i);if(l)await v(e,`Admin removed cached report for ${o}`);return h({ok:Boolean(l),project:o,key:i})}if(r==="clear-fallbacks"){let s=await Yt(e);if(s!==null)return await v(e,`Admin cleared fallback entries => ${s}`),h({ok:!0,removed:s});return h({ok:!1,error:"Fallback storage not configured"},{status:503})}if(r==="r2-load-test"){let s=Number(n?.iterations),o=Number.isFinite(s)?Math.min(Math.max(Math.trunc(s),1),25):5,i=R(n?.prefix)||"reports/__loadtest",l=Math.random().toString(16).slice(2,10),c=[],d=[],m=0,f=0;for(let _=0;_<o;_+=1){let $=`${i}/${l}-${Date.now()}-${_}.json`,b={iteration:_,timestamp:new Date().toISOString(),seed:l},A=Date.now(),T=await U(e,$,b);if(c.push(Date.now()-A),T){m+=1;let N=Date.now(),S=await P(e,$);if(d.push(Date.now()-N),S)f+=1}await mt(e,$)}let p=(_)=>{if(!_.length)return null;return _.reduce(($,b)=>$+b,0)/_.length},x={iterations:o,writes:{ok:m,avg_ms:p(c)},reads:{ok:f,avg_ms:p(d)},prefix:i};return await v(e,`Admin executed R2 load test: ${m}/${o} writes, ${f}/${o} reads`),h({ok:!0,summary:x})}if(r==="simulate-fallback"){let s=Number(n?.count),o=Number.isFinite(s)?Math.min(Math.max(Math.trunc(s),1),20):3,i=R(n?.reason)||"manual_test",l=R(n?.prefix)||"fallback-test",c=0;for(let d=0;d<o;d+=1){let m=`${l}/${Date.now()}-${d}`;if(await Ie(e,m,{reason:i,created_at:new Date().toISOString(),index:d}))c+=1}if(c===0)return h({ok:!1,error:"Fallback storage not configured"},{status:503});return await v(e,`Admin simulated fallback writes => ${c}/${o}`),h({ok:!0,written:c,requested:o,reason:i,prefix:l})}if(r==="check-telegram-webhook"){let s=R(n?.token)||void 0,o=await Bt(e,s);return h(o,{status:o.ok?200:502})}return E("Unsupported system action")};var Re=(t)=>{return t.SESSION_NAMESPACE||t.DB||t.FALLBACK_KV||t.LOGS_NAMESPACE||null},je=(t)=>`session:admin:${t}`,ne=async(t,e)=>{let a=Re(t);if(!a)return null;try{let n=await a.get(je(e));if(!n)return null;let r=JSON.parse(n);if(!r||typeof r!=="object")return null;return r}catch(n){return null}},Sa=async(t,e,a)=>{let n=Re(t);if(!n)return;try{await n.put(je(e),JSON.stringify(a),{expirationTtl:900})}catch(r){}},H=async(t,e)=>{let a=Re(t);if(!a)return;try{await a.delete(je(e))}catch(n){}};var br=(t)=>{if(!t.startsWith("/"))return null;let e=t.trim().split(/\s+/),a=e[0].split("@")[0].toLowerCase(),n=e.slice(1);return{command:a,args:n}},_r=`\uD83D\uDC4B Привет! Этот бот показывает статистику по рекламе.

Доступные команды:
/help — список команд
/report — текущие показатели
/admin — панель администратора`,yr=`\uD83D\uDCCB Команды:
/start — начать
/help — помощь
/report — отчёт
/admin — панель администратора`,xr="⚙️ Панель администратора",wr={inline_keyboard:[[{text:"\uD83E\uDDF9 Очистить Meta-кэш",callback_data:"admin:tech_action:meta_cache"}],[{text:"\uD83E\uDDFA Очистить cache/",callback_data:"admin:tech_action:clear_prefix"},{text:"\uD83D\uDCDD Другой префикс",callback_data:"admin:tech_prompt:clear_prefix"}],[{text:"\uD83D\uDDD1️ Очистить отчёт",callback_data:"admin:tech_prompt:clear_report"}],[{text:"\uD83D\uDEA8 Очистить fallback",callback_data:"admin:tech_action:clear_fallbacks"}],[{text:"\uD83D\uDCE1 Проверить вебхук",callback_data:"admin:tech_action:webhook"},{text:"\uD83D\uDD11 Свой токен",callback_data:"admin:tech_prompt:webhook"}],[{text:"⬅️ Главное меню",callback_data:"admin:menu"}]]},kr=1800000,q=(t,e,a,n)=>({kind:t,projectId:e,messageId:a,createdAt:new Date().toISOString(),data:n}),Q=async(t,e,a)=>{await Sa(t,e,a)},dt=async(t,e,a)=>{await y(t,e,a,{replyMarkup:{force_reply:!0}})},$r=(t)=>{if(typeof t!=="string"||!t.trim())return[];return t.split(",").map((e)=>{let[a,n]=e.split(":"),r=a?.trim(),s=n?.trim();if(!r||!s)return null;return{id:r,name:s}}).filter((e)=>Boolean(e))},Ar=(t)=>Boolean(t.REPORTS_BUCKET||t.R2_BUCKET||t.BOT_BUCKET||t.STORAGE_BUCKET||t.LOGS_BUCKET),ce=(t)=>{if(typeof t.DEFAULT_TZ==="string"&&t.DEFAULT_TZ.trim())return t.DEFAULT_TZ.trim();return"Asia/Tashkent"},Pa=!1,Sr=async(t)=>{let e=new Map,a=(i)=>{if(!i||!i.id)return;if(!e.has(i.id))e.set(i.id,i);else if(!e.get(i.id)?.name&&i.name)e.set(i.id,i)},n=$r(t.PROJECTS);n.forEach(a);let r=await P(t,"reports/projects.json");if(Array.isArray(r))r.map((i)=>({id:i.id,name:i.name||i.id})).forEach(a);let s=await C(t);if(Array.isArray(s))s.map((i)=>({id:i.id,name:i.name||i.id})).forEach(a);let o=Array.from(e.values());if(!Pa){if(console.log("Loaded projects from ENV:",n.map((i)=>i.id).join(", ")||"<empty>"),console.log("Resolved project list:",o.map((i)=>`${i.id}:${i.name}`).join(", ")||"<empty>"),o.length===0)console.warn("⚠️ No projects found in ENV or R2.");Pa=!0}return o},X=async(t,e,a,n={},r={})=>{if(typeof r.messageId==="number")await ft(t,e,r.messageId,a,n);else await y(t,e,a,n)},Pr=(t,e)=>{if(!t)return"Статус Facebook: ⚪️ неизвестно. Настройте подключение через кнопку ниже.";let a=t.expires_at?M(t.expires_at,e):null,n=t.account_name||t.account_id||null;if(t.status==="missing")return"Статус Facebook: ⚠️ не подключен. Авторизуйтесь через кнопку ниже.";if(t.status==="expired")return"Статус Facebook: ⚠️ токен истёк. Пройдите авторизацию заново.";if(!t.ok||t.status==="invalid")return`Статус Facebook: \uD83D\uDEA8 требуется внимание${t.issues&&t.issues.length?`: ${t.issues.join("; ")}`:"."}`;let r=t.should_refresh?"\uD83D\uDFE1":"\uD83D\uDFE2",s=[],o=n?` — ${n}`:"";if(s.push(`${r} Facebook подключён${o}`),a)s.push(`действителен до ${a}`);if(t.should_refresh)s.push("нужно обновить в ближайшее время");return s.join(", ")},Rr=async(t,e)=>{let a=0;for(let n of e){let r=n.summary?.active_campaigns;if(typeof r==="number"&&Number.isFinite(r)){a+=r;continue}try{let s=await P(t,`reports/${n.id}.json`);if(s&&Array.isArray(s.campaigns))a+=s.campaigns.length}catch(s){}}return a},ie=async(t)=>{try{let e=await et(t,{useCache:!0});if(e&&Array.isArray(e.accounts))return e.accounts}catch(e){console.warn("Failed to load Meta accounts",{error:e.message})}return[]},Ea=async(t,e,a={})=>{let n=null;try{n=await Z(t)}catch(A){console.warn("Failed to load Facebook token status",{error:A.message})}let r=await C(t),s=await ie(t),o=await Rr(t,r),i=r.filter((A)=>{let T=(A.status||"").toLowerCase();return T.includes("active")||T.includes("running")}).length,l=ce(t),c=Pr(n,l),d=Number.isFinite(o)?String(o):"нет данных",m=r.length?`Проекты: ${r.length}${i?` (активных: ${i})`:""} | Кампании: ${d}`:"Проекты: нет данных. Добавьте проекты через панель.",f=s.filter((A)=>{let T=Pt(r,A.id);return T&&pt(T)}).length,p=Lt(r).length,x=s.length?`Рекламные аккаунты: ${f} из ${s.length} подключены${p?` | свободно: ${p}`:""}`:"Рекламные аккаунты: нет данных.",$=[xr,"",c,m,x].filter((A)=>A!==null&&A!==void 0).join(`
`).trim(),b=Fr(t,{connected:Boolean(n&&n.ok&&n.status==="ok")});await X(t,e,$,{replyMarkup:b},a)},jr=async(t,e,a={})=>{let n=await C(t);if(!n.length){await X(t,e,"⚠️ Список проектов пуст. Добавьте проекты через веб-панель или API.",{replyMarkup:{inline_keyboard:[[{text:"⬅️ Главное меню",callback_data:"admin:menu"}]]}},a);return}let r=typeof t.DEFAULT_TZ==="string"&&t.DEFAULT_TZ.trim()?t.DEFAULT_TZ.trim():"Asia/Tashkent",s=Math.min(n.length,25),o=[],i=[];for(let d=0;d<s;d+=1){let m=n[d],f=Ca(m.status),p=m.summary||null,x=m.currency||m.billing?.currency||"USD",_=k(p?.spend??null,x),$=O(p?.leads??null),b=O(p?.clicks??null),A=tt(p?.ctr??null),T=p,N=T&&"last_active"in T?T.last_active:void 0,S=null;if(typeof N==="string")S=N;else if(typeof N==="number")S=String(N);else if(N instanceof Date)S=N.toISOString();if(!S)S=m.updated_at||m.last_sync||null;let $t=Ke(S,r),Ut=[`${f} <b>${u(m.name)}</b>`,`\uD83D\uDCB0 Потрачено: ${u(_)}`,`\uD83D\uDCC8 Лиды: ${u($)} | Клики: ${u(b)} | CTR: ${u(A)}`,`\uD83D\uDCC6 Последняя активность: ${u($t)}`];o.push(Ut.join(`
`));let ue=zt(t,m.id,m.portal_url||void 0)||`/portal/${m.id}`,At=m.chat_link||(m.chat_username?`https://t.me/${m.chat_username.replace(/^@/,"")}`:null),ut=[{text:"⚙️ Управление",callback_data:`admin:project:${m.id}`},{text:"\uD83D\uDCCA Отчёт",url:ue}];if(At)ut.push({text:"✉️ Чат проекта",url:At});else ut.push({text:"✉️ Чат проекта",callback_data:`admin:project:${m.id}`});i.push(ut)}if(n.length>s)o.push(`Показаны первые ${String(s)} проектов из ${String(n.length)}. Остальные доступны в веб-панели.`);i.push([{text:"⬅️ Главное меню",callback_data:"admin:menu"}]);let c=["\uD83D\uDCC1 Управление проектами","","Просматривайте ключевые показатели и переходите в портал или чат из карточек ниже.",""].concat(o).join(`

`).trim();await X(t,e,c,{replyMarkup:{inline_keyboard:i},parseMode:"HTML",disablePreview:!0},a)},Tr=(t,e,a,n,r)=>{let s=[],o=n?gt(t.status):"\uD83D\uDD18";if(s.push(`${o} <b>${u(t.name||t.id)}</b>`),s.push(`ID: <code>${u(t.id)}</code>`),t.status)s.push(`Статус: ${u(String(t.status))}`);if(e)if(s.push(`Проект: ${u(e.name)}`),!n)s.push("Чат: не подключён");else{let l=vt(e);if(l)s.push(`Чат: ${u(l)}`)}else s.push("Проект: не подключён");if(a&&a.value!==null){let l=k(a.value,a.currency),c=a.label?` (${a.label})`:"";s.push(`\uD83D\uDCB0 Потрачено: ${u(`${l}${c}`)}`)}else s.push("\uD83D\uDCB0 Потрачено: —");let i=e?.updated_at||e?.last_sync||t.last_update||null;return s.push(`\uD83D\uDCC6 Последняя активность: ${u(M(i,r))}`),s.join(`
`)},Er=async(t,e,a={})=>{let n=await C(t),r=await ie(t);if(!r.length){await X(t,e,"⚠️ Аккаунты Facebook не найдены. Проверьте подключение и обновите статус.",{replyMarkup:{inline_keyboard:[[{text:"⬅️ Главное меню",callback_data:"admin:menu"}]]}},a);return}let s=ce(t),o=[],i=[];for(let d of r){let m=Pt(n,d.id),f=m?pt(m):!1,p=await ee(t,m);if(o.push(Tr(d,m,p,f,s)),m&&f){let x=p&&p.value!==null?k(p.value,p.currency):"—";i.push([{text:`${gt(d.status)} ${d.name} | ${x}`,callback_data:`admin:project:${m.id}`}])}else i.push([{text:`\uD83D\uDD18 ${d.name} | Подключить`,callback_data:`admin:account_link:${d.id}`}])}i.push([{text:"⬅️ Главное меню",callback_data:"admin:menu"}]);let c=["\uD83D\uDCE3 Рекламные аккаунты","","Выберите аккаунт, чтобы открыть проект или привязать его к чат-группе.",""].concat(o).join(`

`).trim();await X(t,e,c,{replyMarkup:{inline_keyboard:i},parseMode:"HTML",disablePreview:!0},a)},Ra=async(t,e,a,n,r={})=>{let s=await C(t),o=Lt(s);if(!o.length){await X(t,e,"⚠️ Свободных чат-групп не найдено. Добавьте проект и чат через веб-панель и попробуйте снова.",{replyMarkup:{inline_keyboard:[[{text:"⬅️ Назад",callback_data:"admin:accounts"}]]}},r);return}let i=o.map((c)=>[{text:c.name,callback_data:`admin:account_choose:${a}:${c.id}`}]);i.push([{text:"⬅️ Назад",callback_data:"admin:accounts"}]);let l=`Подключение <b>${u(n)}</b> к чату. Выберите чат-группу клиента:`;await X(t,e,l,{replyMarkup:{inline_keyboard:i},parseMode:"HTML"},r)},Cr=async(t,e,a,n,r,s={})=>{let o=`Подвязать <b>${u(n)}</b> к проекту <b>${u(r.name)}</b>?`,i=[[{text:"\uD83D\uDD04 Изменить чат",callback_data:`admin:account_choose:${a}`},{text:"✅ Подвязать",callback_data:`admin:account_confirm:${a}:${r.id}`}],[{text:"⬅️ Отмена",callback_data:"admin:accounts"}]];await X(t,e,o,{replyMarkup:{inline_keyboard:i},parseMode:"HTML"},s)},Mr=async(t,e,a,n)=>{let r={account_id:e,account_name:a};if(!await ot(t,n.id,r))return!1;return await w(t,{level:"info",message:`Telegram admin linked account ${e} to project ${n.id}`,timestamp:new Date().toISOString()}),!0},Dr=(t,e)=>{let a=[],n=Ca(t.status);if(a.push(`${n} <b>${u(t.name)}</b>`),a.push(`ID: <code>${u(t.id)}</code>`),t.status)a.push(`Статус: ${u(t.status)}`);if(t.account_name)a.push(`Аккаунт: ${u(t.account_name)}`);if(t.manager)a.push(`Менеджер: ${u(t.manager)}`);let r=t.billing||{};if(r.amount!==void 0||r.next_payment||r.next_payment_date){let l=k(r.amount??null,r.currency||t.currency||"USD"),c=r.next_payment||r.next_payment_date||"—";a.push(`\uD83D\uDCB3 Оплата: ${u(l)} | Следующая дата: ${u(String(c))}`)}let s=t.alerts_enabled!==!1,o=Boolean(t.silent_weekends);if(a.push(`Алерты: ${s?"включены":"выключены"}`),a.push(`Тихие выходные: ${o?"включены":"выключены"}`),t.summary)a.push("","\uD83D\uDCCA Текущие показатели:"),a.push(`• Потрачено: ${u(k(t.summary.spend,t.currency||"USD"))}`),a.push(`• Лиды: ${u(String(t.summary.leads??"—"))} | Клики: ${u(String(t.summary.clicks??"—"))}`),a.push(`• CTR: ${u(String(t.summary.ctr??"—"))} | CPA: ${u(k(t.summary.cpa,t.currency||"USD"))}`);else a.push("","Нет свежего отчёта для отображения.");let i=t.updated_at||t.last_sync||null;if(i)a.push("",`⏱ Обновлено: ${u(M(i,e))}`);return a.join(`
`)},Or=(t,e)=>{let a=[],n=e.alerts_enabled!==!1,r=Boolean(e.silent_weekends);a.push([{text:n?"\uD83D\uDD15 Выключить алерты":"\uD83D\uDD14 Включить алерты",callback_data:`admin:toggle_alerts:${e.id}`},{text:r?"\uD83D\uDD14 Вернуть уведомления":"\uD83D\uDE34 Тихие выходные",callback_data:`admin:toggle_silent:${e.id}`}]),a.push([{text:"\uD83D\uDCB3 Настроить оплату",callback_data:`admin:billing_menu:${e.id}`},{text:"\uD83D\uDD14 Настроить алерты",callback_data:`admin:alerts_menu:${e.id}`}]),a.push([{text:"\uD83D\uDD04 Обновить отчёт",callback_data:`admin:refresh_project:${e.id}`}]);let s=zt(t,e.id,e.portal_url||void 0)||`/portal/${e.id}`;if(s)a.push([{text:"\uD83C\uDF10 Открыть портал",url:s}]);let o=e.chat_link?e.chat_link:e.chat_username?`https://t.me/${e.chat_username.replace(/^@/,"")}`:null;if(o)a.push([{text:"\uD83D\uDCAC Чат проекта",url:o}]);return a.push([{text:"⬅️ К списку",callback_data:"admin:projects"},{text:"\uD83C\uDFE0 Меню",callback_data:"admin:menu"}]),{inline_keyboard:a}},J=async(t,e,a,n={})=>{let s=(await C(t)).find((l)=>l.id===a);if(!s)return await X(t,e,"⚠️ Проект не найден. Обновите список и попробуйте снова.",{replyMarkup:{inline_keyboard:[[{text:"⬅️ К списку",callback_data:"admin:projects"}]]}},n),!1;let o=Dr(s,ce(t)),i=Or(t,s);return await X(t,e,o,{parseMode:"HTML",replyMarkup:i,disablePreview:!0},n),!0},ja=async(t,e,a)=>{let n=await jt(t,e),s=!(n&&typeof n[a]==="boolean"?Boolean(n[a]):!1),o={};if(o[a]=s,!await ot(t,e,o))throw new Error("Не удалось обновить конфигурацию проекта");return await w(t,{level:"info",message:`Telegram admin toggled ${a} for ${e} => ${String(s)}`,timestamp:new Date().toISOString()}),s},Nr=(t)=>({inline_keyboard:t.map((e)=>[{text:e.name,callback_data:`report:${e.id}`}])}),Ir=(t)=>({inline_keyboard:[[{text:"\uD83D\uDD01 Обновить данные",callback_data:`refresh:${t}`}]]}),Ca=(t)=>{let e=(t||"").toLowerCase();if(!e)return"⚪️";if(e.startsWith("active")||e.includes("running"))return"\uD83D\uDFE2";if(e.includes("pend")||e.includes("review")||e.includes("moderation"))return"\uD83D\uDFE1";if(e.includes("pause")||e.includes("stop")||e.includes("inactive")||e.includes("disable")||e.includes("off"))return"⚫️";return"⚪️"},Ta=(t)=>{let e=(t||"").toLowerCase();if(!e)return{icon:"⚪️",bucket:"other"};if(e.includes("active"))return{icon:"\uD83D\uDFE2",bucket:"active"};if(e.includes("pend")||e.includes("review")||e.includes("moderation")||e.includes("processing"))return{icon:"\uD83D\uDFE1",bucket:"pending"};if(e.includes("disable")||e.includes("suspend")||e.includes("block")||e.includes("close")||e.includes("inactive"))return{icon:"⚫️",bucket:"disabled"};return{icon:"⚪️",bucket:"other"}},Ma=(t)=>{let e=typeof t.FB_APP_ID==="string"?t.FB_APP_ID.trim():"",a=typeof t.WORKER_URL==="string"?t.WORKER_URL.trim():"";if(!e||!a)return null;let r=`${a.endsWith("/")?a.slice(0,-1):a}/auth/facebook/callback`,s=new URL("https://www.facebook.com/v18.0/dialog/oauth");return s.searchParams.set("client_id",e),s.searchParams.set("redirect_uri",r),s.searchParams.set("scope","ads_management,business_management"),s.toString()},Lr=(t)=>{let e=typeof t.WORKER_URL==="string"?t.WORKER_URL.trim():"",a=e?e.replace(/\/$/,""):"https://th-reports.buyclientuz.workers.dev",r=(typeof t.ADMIN_KEY==="string"?t.ADMIN_KEY.trim():"")||"!Lyas123";if(!a)return null;return`${a}/admin?key=${encodeURIComponent(r)}`},Fr=(t,e={})=>{let a=[],n=Ma(t),r=Lr(t),s=e.connected?"\uD83D\uDD04 Обновить FB":"\uD83D\uDD17 Авторизация Facebook",o=n?{text:s,url:n}:{text:s,callback_data:"admin:fb_auth"};return a.push([o,r?{text:"\uD83C\uDF10 Веб-админка",url:r}:{text:"\uD83C\uDF10 Веб-админка",callback_data:"admin:menu"},{text:"\uD83D\uDCC1 Проекты",callback_data:"admin:projects"}]),a.push([{text:"\uD83D\uDCE3 Рекламные аккаунты",callback_data:"admin:accounts"},{text:"\uD83D\uDCB3 Оплаты",callback_data:"admin:billing"},{text:"⚙️ Тех.панель",callback_data:"admin:tech"}]),{inline_keyboard:a}},vr=async(t,e)=>{let a=Ma(t);if(!a){await y(t,e,"⚠️ Укажите WORKER_URL и FB_APP_ID, чтобы сформировать ссылку авторизации Facebook.");return}let n=typeof t.WORKER_URL==="string"?t.WORKER_URL.trim():"",r=`\uD83D\uDC64 Авторизация Facebook

1. Откройте ссылку: ${a}
2. Подтвердите доступ к рекламе и бизнесу.${n?`
3. После редиректа убедитесь, что страница ${n.replace(/\/$/,"")}/auth/facebook/callback сообщает об успешном входе.`:""}`;await y(t,e,r,{disablePreview:!0})},Br=async(t,e)=>{let a=typeof t.DEFAULT_TZ==="string"&&t.DEFAULT_TZ.trim()?t.DEFAULT_TZ.trim():"Asia/Tashkent";try{let n=await at(t,{notify:!1}),r=null,s=null;try{r=await et(t,{useCache:!0})}catch(m){s=m.message||"Не удалось загрузить статус Meta."}let{status:o,refresh:i}=n;if(o.status==="missing"){await y(t,e,"⚠️ Токен не настроен. Пройдите авторизацию через кнопку «Авторизация Facebook».");return}if(o.status==="expired"){await y(t,e,"⚠️ Токен истёк, требуется повторная авторизация.");return}if(!o.ok||o.status==="invalid"||o.valid===!1){let m=o.issues&&o.issues.length?`: ${o.issues.join("; ")}`:".";await y(t,e,`\uD83D\uDEA8 Ошибка при обращении к Facebook API${m}`);return}let l=null;if(o.expires_at)l=M(o.expires_at,a);else if(typeof o.expires_in_hours==="number"){let m=new Date(Date.now()+o.expires_in_hours*60*60*1000).toISOString();l=M(m,a)}let c=[l?`\uD83D\uDFE2 Facebook-токен активен (действителен до ${l})`:"\uD83D\uDFE2 Facebook-токен активен."];if(i&&typeof i==="object"){if(i.ok)c.push("\uD83D\uDD04 Токен проверен и актуализирован.");else if(i.message)c.push(`⚠️ Не удалось обновить токен: ${i.message}`)}let d=[];if(r){if(r.updated_at)d.push(`⏱ Обновлено: ${M(r.updated_at,a)}`);let m=Array.isArray(r.accounts)?r.accounts:[];if(m.length>0){let f=0,p=0,x=0,_=5,$=[];if(m.forEach((b)=>{let A=Ta(b.status);if(A.bucket==="active")f+=1;else if(A.bucket==="pending")p+=1;else if(A.bucket==="disabled")x+=1}),d.push(`\uD83D\uDCD8 Аккаунты Facebook: ${m.length} (\uD83D\uDFE2 ${String(f)} • \uD83D\uDFE1 ${String(p)} • ⚫️ ${String(x)})`),m.slice(0,_).forEach((b)=>{let A=Ta(b.status),T=b.name||b.id,N=b.status?b.status:"статус неизвестен";$.push(`${A.icon} ${T} — ${N}`);let S=[];if(b.balance!==void 0&&b.balance!==null)S.push(`Баланс: ${k(b.balance,b.currency||"USD")}`);if(b.spend_cap!==void 0&&b.spend_cap!==null)S.push(`Лимит: ${k(b.spend_cap,b.currency||"USD")}`);if(b.payment_method)S.push(`Карта: ${b.payment_method}`);if(b.last_update)S.push(`Обновлено: ${M(b.last_update,a)}`);if(S.length)$.push(`   ${S.join(" • ")}`);if(Array.isArray(b.issues)&&b.issues.length)$.push(`   ⚠️ ${b.issues.join("; ")}`)}),d.push(...$),m.length>_)d.push(`… и ещё ${m.length-_} аккаунтов смотрите в веб-панели.`)}else d.push("⚠️ Не удалось получить список рекламных аккаунтов.");if(r.cached)d.push("ℹ️ Используются кешированные данные Meta.")}else if(s)d.push(`⚠️ Не удалось загрузить статус Meta: ${s}`);if(d.length)c.push("",...d);await y(t,e,c.join(`
`))}catch(n){let r=n instanceof Error&&n.message?`: ${n.message}`:".";await y(t,e,`\uD83D\uDEA8 Ошибка при обращении к Facebook API${r}`)}},Kr=async(t,e)=>{let a=await C(t);if(a.length===0){await y(t,e,"⚠️ Нет проектов для отображения оплат.");return}let n=["\uD83D\uDCB3 Оплаты",""];for(let r of a){let s=r.billing||{},o=s.amount!==void 0&&s.amount!==null?k(s.amount,s.currency||r.currency||"USD"):"—",i=s.next_payment||s.next_payment_date||"—",l=s.status||"неизвестно";n.push(`${r.name}
  Следующая оплата: ${i}
  Сумма: ${o}
  Статус: ${l}`)}await y(t,e,n.join(`

`))},Ur=(t)=>({inline_keyboard:[[{text:"\uD83D\uDCB5 Оплатил сегодня",callback_data:`admin:billing_paid:${t}`}],[{text:"\uD83D\uDCB0 Изменить сумму",callback_data:`admin:billing_amount:${t}`},{text:"\uD83D\uDCC6 Изменить дату",callback_data:`admin:billing_date:${t}`}],[{text:"✅ Оплачено",callback_data:`admin:billing_status:${t}:paid`},{text:"⚠️ Требуется оплата",callback_data:`admin:billing_status:${t}:due`}],[{text:"⛔ Просрочено",callback_data:`admin:billing_status:${t}:overdue`},{text:"\uD83D\uDEAB Неактивен",callback_data:`admin:billing_status:${t}:inactive`}],[{text:"⬅️ К проекту",callback_data:`admin:project:${t}`}]]}),Wr=async(t,e,a)=>{let r=(await C(t)).find((m)=>m.id===a);if(!r){await y(t,e,"⚠️ Проект не найден. Обновите список проектов.");return}let s=r.billing||{},o=s.amount!==void 0&&s.amount!==null?k(s.amount,s.currency||r.currency||"USD"):"—",i=s.next_payment_date||s.next_payment||"—",l=s.last_payment||"—",c=s.status||"неизвестно",d=[`\uD83D\uDCB3 Управление оплатой — ${r.name}`,`Сумма: ${o}`,`Следующая оплата: ${i}`,`Последняя оплата: ${l}`,`Статус: ${c}`];await y(t,e,d.join(`
`),{replyMarkup:Ur(a)})},Gr=(t)=>({inline_keyboard:[[{text:"\uD83C\uDFAF Порог CPA",callback_data:`admin:alerts_cpa:${t}`}],[{text:"\uD83D\uDCB8 Лимит расходов",callback_data:`admin:alerts_spend:${t}`}],[{text:"⏱ Модерация (часы)",callback_data:`admin:alerts_moderation:${t}`}],[{text:"⬅️ К проекту",callback_data:`admin:project:${t}`}]]}),Hr=async(t,e,a)=>{let r=(await C(t)).find((d)=>d.id===a);if(!r){await y(t,e,"⚠️ Проект не найден. Обновите список проектов.");return}let s=r.alerts||{},o=s.cpa_threshold!==void 0&&s.cpa_threshold!==null?s.cpa_threshold:"—",i=s.spend_limit!==void 0&&s.spend_limit!==null?s.spend_limit:"—",l=s.moderation_hours!==void 0&&s.moderation_hours!==null?s.moderation_hours:"—",c=[`\uD83D\uDD14 Настройка алертов — ${r.name}`,`CPA порог: ${o}`,`Лимит расходов: ${i}`,`Модерация, часов: ${l}`];await y(t,e,c.join(`
`),{replyMarkup:Gr(a)})},Ce=(t)=>t.toISOString().slice(0,10),Jr=(t)=>{let e=t.trim();if(!e)return null;if(e.match(/^(\d{4})-(\d{2})-(\d{2})$/))return e;let n=e.match(/^(\d{2})\.(\d{2})\.(\d{4})$/);if(n)return`${n[3]}-${n[2]}-${n[1]}`;let r=new Date(e);if(Number.isNaN(r.getTime()))return null;return Ce(r)},re=(t)=>{let e=t.replace(/[^0-9,.-]+/g,"").replace(/,/g,".");if(!e.trim())return null;let a=Number(e);if(!Number.isFinite(a))return null;return a},Vr=(t,e=new Date)=>{let a=Math.max(1,Math.min(28,Math.floor(t))),n=new Date(Date.UTC(e.getUTCFullYear(),e.getUTCMonth(),a));if(e.getUTCDate()>=a)n.setUTCMonth(n.getUTCMonth()+1);return Ce(n)},le=async(t,e,a,n)=>{let r=await Zt(t,e,a);if(r)await w(t,{level:"info",message:`Telegram admin billing update for ${e}: ${n}`,timestamp:new Date().toISOString()});return r},Te=async(t,e,a,n)=>{let r=await qt(t,e,a);if(r)await w(t,{level:"info",message:`Telegram admin alerts update for ${e}: ${n}`,timestamp:new Date().toISOString()});return r},se=(t,e)=>{let a=new Set;for(let n of t){if(!n.startsWith(e)||!n.endsWith(".json"))continue;let r=n.slice(e.length).replace(/\.json$/,"");if(!r||r.includes("/"))continue;if(r==="index"||r==="projects")continue;a.add(r)}return a.size},Kt=async(t,e,a={})=>{let[n,r,s,o,i,l]=await Promise.all([W(t,"reports/"),W(t,"projects/"),W(t,"billing/"),W(t,"alerts/"),Vt(t),Nt(t).catch(()=>({}))]),c=["⚙️ Тех.панель","","R2:",`• Отчёты: ${se(n,"reports/")}`,`• Проекты: ${se(r,"projects/")}`,`• Оплаты: ${se(s,"billing/")}`,`• Алерты: ${se(o,"alerts/")}`];if(i!==null&&i!==void 0)c.push(`• Fallback KV: ${i}`);let d=l&&typeof l==="object"?Object.values(l):[];if(d.length>0){c.push("","⏱ Крон-задачи:");for(let p of d.sort((x,_)=>x.job.localeCompare(_.job))){let x=p.ok?"\uD83D\uDFE2":"\uD83D\uDD34",_=p.job==="meta-token"?"Meta токен":p.job==="projects-refresh"?"Обновление отчётов":p.job,$=p.last_run&&p.last_run!=="1970-01-01T00:00:00.000Z"?M(p.last_run):"—",b=p.last_success&&p.last_success!=="1970-01-01T00:00:00.000Z"?M(p.last_success):null,A=b?` (успех: ${b})`:"",T=p.message?` — ${p.message}`:"",N=p.failure_count&&p.failure_count>0?` [${p.failure_count}× ошибок]`:"";c.push(`• ${x} ${_}: ${$}${A}${N}${T}`)}}let m=typeof t.WORKER_URL==="string"?t.WORKER_URL.trim():"",f=m?m.endsWith("/")?m.slice(0,-1):m:"";if(f)c.push("",`Вебхук: ${f}/manage/telegram/webhook?action=status&token=<token>`);c.push("","Кнопки ниже помогут очистить кэши, удалить отчёты или проверить вебхук без входа в панель."),await X(t,e,c.join(`
`),{disablePreview:!0,replyMarkup:wr},a)},oe=async(t,e,a)=>{let n=new Date().toISOString();switch(e){case"meta_cache":{let r=await Et(t),s=r?"Meta-кэш очищен":"Кэш уже пуст",o=r?"\uD83E\uDDF9 Кэш статуса Facebook очищен.":"ℹ️ Кэш статуса Facebook уже пуст.";return await w(t,{level:"info",message:`Telegram admin cleared Meta status cache (result: ${s})`,timestamp:n}),{toast:s,message:o}}case"clear_prefix":{let r=a&&a.trim()?a.trim():"cache/",s=await Jt(t,r),o=`\uD83E\uDDFA Удалено объектов: ${s}
Префикс: ${r.replace(/\s+/g," ")}`;return await w(t,{level:"info",message:`Telegram admin cleared prefix ${r} => ${s}`,timestamp:n}),{toast:`Удалено: ${s}`,message:o}}case"clear_fallbacks":{let r=await Yt(t);if(r===null)return{toast:"Fallback не настроен",message:"⚠️ Fallback KV не сконфигурирован",alert:!0};return await w(t,{level:"info",message:`Telegram admin cleared fallback entries => ${r}`,timestamp:n}),{toast:`Удалено: ${r}`,message:`\uD83D\uDEA8 Fallback очищен: ${r}`}}case"clear_report":{let r=a&&a.trim();if(!r)return{toast:"Укажите проект",alert:!0};let s=`reports/${r}.json`,o=await mt(t,s);return await w(t,{level:o?"info":"warn",message:`Telegram admin cleared report cache for ${r} => ${o}`,timestamp:n}),o?{toast:"Отчёт удалён",message:`\uD83D\uDDD1️ Кэш отчёта проекта ${r} удалён из R2.`}:{toast:"Отчёт не найден",message:`⚠️ Файл отчёта проекта ${r} не найден в R2.`,alert:!0}}case"webhook":{let r=await Bt(t,a&&a.trim()?a.trim():void 0),o=["\uD83D\uDCE1 Статус вебхука",`Токен: ${r.token||"—"}`];if(r.webhook&&typeof r.webhook==="object"){let i=r.webhook,l=typeof i.url==="string"&&i.url?i.url:"—";if(l)o.push(`URL: ${l}`);if(typeof i.pending_update_count==="number")o.push(`В очереди: ${i.pending_update_count}`)}else if(r.webhook)o.push(`Ответ: ${String(r.webhook)}`);if(!r.ok){let i=r.error||"Неизвестная ошибка";return o.push(`Ошибка: ${i}`),await w(t,{level:"warn",message:`Telegram admin webhook status error => ${i}`,timestamp:n}),{toast:i.length>190?`${i.slice(0,190)}…`:i,message:o.join(`
`),alert:!0}}return await w(t,{level:"info",message:"Telegram admin checked webhook status",timestamp:n}),{toast:"Вебхук OK",message:o.join(`
`)}}default:return{toast:"Неизвестное действие",alert:!0}}},Yr=async(t,e)=>{return P(t,`reports/${e}.json`)},zr=(t)=>{if(!t||!t.updated_at)return!0;let e=new Date(t.updated_at).getTime();if(!Number.isFinite(e))return!0;return Date.now()-e>kr},Zr=(t,e,a)=>{let n=t.summary,r=[];if(r.push(`\uD83D\uDCCA <b>${u(t.project_name||t.project_id)}</b>`),t.period_label||t.period)r.push(`\uD83D\uDCC6 Период: ${u((t.period_label||t.period||"").toString())}`);if(r.push(`\uD83D\uDCB0 Потрачено: ${u(k(n?.spend??null,t.currency))}`),r.push(`\uD83D\uDCF2 Лиды: ${u(O(n?.leads??null))} | Клики: ${u(O(n?.clicks??null))}`),r.push(`\uD83D\uDC41️ Показы: ${u(O(n?.impressions??null))} | Частота: ${u(Qt(n?.frequency??null))}`),r.push(`CPA: ${u(k(n?.cpa??null,t.currency))} | CPC: ${u(k(n?.cpc??null,t.currency))} | CTR: ${u(tt(n?.ctr??null))}`),t.billing&&t.billing.days_to_pay!==null&&t.billing.days_to_pay!==void 0)r.push(`\uD83D\uDCB3 Дней до оплаты: ${u(typeof t.billing.days_to_pay==="number"?t.billing.days_to_pay.toString():String(t.billing.days_to_pay||"—"))}`);if(r.push(""),r.push(`⏱ Обновлено: ${u(M(t.updated_at,e))}`),a)r.push("⚠️ <b>Данные устарели!</b>");return r.join(`
`)},Ee=async(t,e,a,n={})=>{let r=Ir(a),s=ce(t);if(!Ar(t)){if(typeof n.messageId==="number")await ft(t,e,n.messageId,"⚠️ Хранилище временно недоступно.",{replyMarkup:r});else await L(t,e,"⚠️ Хранилище временно недоступно.",{replyMarkup:r});return}let o=await Yr(t,a);if(!o){if(typeof n.messageId==="number")await ft(t,e,n.messageId,"⚠️ Не удалось получить отчёт. Попробуйте позже.",{replyMarkup:r});else await L(t,e,"⚠️ Не удалось получить отчёт. Попробуйте позже.",{replyMarkup:r});return}let i=Zr(o,s,zr(o)),l={parseMode:"HTML",replyMarkup:r,disablePreview:!0};if(typeof n.messageId==="number")await ft(t,e,n.messageId,i,l);else await y(t,e,i,l)},Da=async(t,e,a={})=>{let n=await Sr(t);if(n.length===0){if(console.warn("⚠️ Нет подключённых проектов. Проверьте значение PROJECTS и R2 индекс."),typeof a.messageId==="number")await ft(t,e,a.messageId,"⚠️ Нет подключённых проектов. Проверьте настройки.");else await L(t,e,"⚠️ Нет подключённых проектов. Проверьте настройки.");return}let r=Nr(n),s="Выберите проект для отчёта:";if(typeof a.messageId==="number")await ft(t,e,a.messageId,s,{replyMarkup:r});else await y(t,e,s,{replyMarkup:r})},qr=(t)=>{let e=t.summary;return`\uD83D\uDCCA ${t.project_name}
Потрачено: ${k(e.spend,t.currency)}
Лиды: ${O(e.leads)} | Клики: ${O(e.clicks)}
CTR: \${formatPercent(summary.ctr)} | CPA: \${formatCurrency(summary.cpa, report.currency)}`},Qr=(t,e=5)=>{let a=t.campaigns.slice(0,e);if(a.length===0)return"Нет кампаний для отображения";return a.map((r)=>`• ${r.name} — ${k(r.spend,t.currency)} / Лиды: ${O(r.leads)} / CTR: ${tt(r.ctr)}`).join(`
`)},L=async(t,e,a,n={})=>{await y(t,e,a,n)},Xr=async(t,e,a)=>{if(a.length===0){await Da(t,e);return}let n=a[0];await Ee(t,e,n)},ts=async(t,e,a)=>{let n=await lt(t,a,{force:!1});if(!n){await L(t,e,"Проект не найден");return}let r=typeof t.WORKER_URL==="string"?t.WORKER_URL.trim():"",s=r?r.replace(/\/$/,""):"",o=s?`${s}/portal/${a}`:`/portal/${a}`,i=[`\uD83D\uDCC4 Детали проекта ${n.project_name}`,`Статус: ${n.status||"—"}`,`Потрачено: ${k(n.summary.spend,n.currency)}`,`Лиды: ${O(n.summary.leads)} / Клики: ${O(n.summary.clicks)} / Показы: ${O(n.summary.impressions)}`,`CPA: ${k(n.summary.cpa,n.currency)} / CPC: ${k(n.summary.cpc,n.currency)} / CTR: ${tt(n.summary.ctr)}`,`Портал: ${o}`];await L(t,e,i.join(`
`))},es=async(t,e,a)=>{let n=await lt(t,a,{force:!1});if(!n){await L(t,e,"Проект не найден");return}let r=Qr(n,10);await L(t,e,`\uD83D\uDCCB Кампании:
${r}`)},as=async(t,e,a)=>{let n=await lt(t,a,{force:!0});if(!n){await L(t,e,"Не удалось обновить отчёт");return}await L(t,e,`Данные обновлены
${qr(n)}`)},ns=async(t,e)=>{await L(t,e,"Настройка алертов пока доступна из админ-панели. Используйте /alertsettings позже для обновления конфигурации.")},rs=async(t,e,a,n)=>{let s=(e.data||"").split(":"),o=s[1]||"",i=s.slice(2),l=i[0]||"",c=i[1]||"";if(!o)return!1;try{switch(o){case"fb_auth":return await vr(t,a),await g(t,e.id,{text:"Ссылка отправлена"}),!0;case"fb_status":return await Br(t,a),await g(t,e.id,{text:"Статус обновлён"}),!0;case"projects":return await jr(t,a,{messageId:n}),await g(t,e.id,{text:"Проекты"}),!0;case"accounts":return await Er(t,a,{messageId:n}),await g(t,e.id,{text:"Аккаунты"}),!0;case"account_link":{if(!l)return await g(t,e.id,{text:"Аккаунт не найден",showAlert:!0}),!0;let f=(await ie(t)).find((p)=>p.id===l)?.name||l;return await Q(t,a,q("link_account_chat",l,n,{accountName:f})),await Ra(t,a,l,f,{messageId:n}),await g(t,e.id,{text:"Выберите чат"}),!0}case"account_choose":{if(!l)return await g(t,e.id,{text:"Аккаунт не найден",showAlert:!0}),!0;let d=l,m=c||"",f=await ne(t,a),p=d;if(f&&f.kind.startsWith("link_account")&&f.projectId===d)p=f.data?.accountName||p;else p=(await ie(t)).find((A)=>A.id===d)?.name||p;if(!m)return await Q(t,a,q("link_account_chat",d,n,{accountName:p})),await Ra(t,a,d,p,{messageId:n}),await g(t,e.id,{text:"Выберите чат"}),!0;let _=(await C(t)).find(($)=>$.id===m);if(!_)return await g(t,e.id,{text:"Проект не найден",showAlert:!0}),!0;return await Q(t,a,q("link_account_confirm",d,n,{accountName:p,projectId:m})),await Cr(t,a,d,p,_,{messageId:n}),await g(t,e.id,{text:"Подтвердите подвязку"}),!0}case"account_confirm":{if(!l||!c)return await g(t,e.id,{text:"Недостаточно данных",showAlert:!0}),!0;let d=l,m=c,p=(await C(t)).find((b)=>b.id===m);if(!p)return await g(t,e.id,{text:"Проект не найден",showAlert:!0}),!0;let x=await ne(t,a),_=(x&&x.kind.startsWith("link_account")&&x.projectId===d?x.data?.accountName:null)||d;if(!await Mr(t,d,_,p))return await g(t,e.id,{text:"Не удалось подвязать",showAlert:!0}),!0;return await H(t,a),await J(t,a,p.id,{messageId:n}),await g(t,e.id,{text:"Аккаунт подключён"}),!0}case"menu":return await Ea(t,a,{messageId:n}),await g(t,e.id,{text:"Главное меню"}),!0;case"project":if(!l)return await g(t,e.id,{text:"Проект не найден",showAlert:!0}),!0;return await J(t,a,l,{messageId:n}),await g(t,e.id,{text:"Проект открыт"}),!0;case"toggle_alerts":{if(!l)return await g(t,e.id,{text:"Проект не найден",showAlert:!0}),!0;let d=await ja(t,l,"alerts_enabled");return await J(t,a,l,{messageId:n}),await g(t,e.id,{text:d?"Алерты включены":"Алерты выключены"}),!0}case"toggle_silent":{if(!l)return await g(t,e.id,{text:"Проект не найден",showAlert:!0}),!0;let d=await ja(t,l,"silent_weekends");return await J(t,a,l,{messageId:n}),await g(t,e.id,{text:d?"Тихие выходные включены":"Уведомления вернулись"}),!0}case"refresh_project":{if(!l)return await g(t,e.id,{text:"Проект не найден",showAlert:!0}),!0;let d=await lt(t,l,{force:!0});return await w(t,{level:"info",message:`Telegram admin refreshed project ${l}${d?"":" (без отчёта)"}`,timestamp:new Date().toISOString()}),await J(t,a,l,{messageId:n}),await g(t,e.id,{text:"Отчёт обновлён"}),!0}case"billing_menu":{if(!l)return await g(t,e.id,{text:"Проект не найден",showAlert:!0}),!0;return await Wr(t,a,l),await g(t,e.id,{text:"Оплата"}),!0}case"billing_amount":{if(!l)return await g(t,e.id,{text:"Проект не найден",showAlert:!0}),!0;return await Q(t,a,q("billing_amount",l,n)),await dt(t,a,`Введите сумму оплаты для ${l}. Пример: 1200000`),await g(t,e.id,{text:"Введите сумму"}),!0}case"billing_date":{if(!l)return await g(t,e.id,{text:"Проект не найден",showAlert:!0}),!0;return await Q(t,a,q("billing_date",l,n)),await dt(t,a,`Введите дату следующей оплаты для ${l} (формат YYYY-MM-DD или DD.MM.YYYY)`),await g(t,e.id,{text:"Введите дату"}),!0}case"billing_paid":{if(!l)return await g(t,e.id,{text:"Проект не найден",showAlert:!0}),!0;let d=new Date,f=(await C(t)).find((_)=>_.id===l),p={last_payment:Ce(d),status:"paid"};if(f?.billing_day){let _=Vr(Number(f.billing_day),d);p.next_payment=_,p.next_payment_date=_}if(!await le(t,l,p,"marked as paid today"))return await g(t,e.id,{text:"Ошибка обновления",showAlert:!0}),!0;return await J(t,a,l,{messageId:n}),await g(t,e.id,{text:"Оплата отмечена"}),!0}case"billing_status":{if(!l||!c)return await g(t,e.id,{text:"Недостаточно данных",showAlert:!0}),!0;if(!await le(t,l,{status:c},`status => ${c}`))return await g(t,e.id,{text:"Ошибка обновления",showAlert:!0}),!0;return await J(t,a,l,{messageId:n}),await g(t,e.id,{text:"Статус обновлён"}),!0}case"billing":return await Kr(t,a),await g(t,e.id,{text:"Оплаты"}),!0;case"alerts_menu":{if(!l)return await g(t,e.id,{text:"Проект не найден",showAlert:!0}),!0;return await Hr(t,a,l),await g(t,e.id,{text:"Алерты"}),!0}case"alerts_cpa":{if(!l)return await g(t,e.id,{text:"Проект не найден",showAlert:!0}),!0;return await Q(t,a,q("alerts_cpa",l,n)),await dt(t,a,`Введите порог CPA для ${l} (число)`),await g(t,e.id,{text:"Введите значение"}),!0}case"alerts_spend":{if(!l)return await g(t,e.id,{text:"Проект не найден",showAlert:!0}),!0;return await Q(t,a,q("alerts_spend",l,n)),await dt(t,a,`Введите лимит расходов для ${l} (число)`),await g(t,e.id,{text:"Введите значение"}),!0}case"alerts_moderation":{if(!l)return await g(t,e.id,{text:"Проект не найден",showAlert:!0}),!0;return await Q(t,a,q("alerts_moderation",l,n)),await dt(t,a,`Введите порог модерации (часы) для ${l}`),await g(t,e.id,{text:"Введите значение"}),!0}case"tech":return await Kt(t,a,{messageId:n}),await g(t,e.id,{text:"Тех.панель"}),!0;case"tech_action":{if(!l)return await g(t,e.id,{text:"Неизвестная команда",showAlert:!0}),!0;let d=await oe(t,l,c);await Kt(t,a,{messageId:n});let m=d.toast&&d.toast.length>0?d.toast:"Готово";if(await g(t,e.id,{text:m.length>200?m.slice(0,200):m,showAlert:Boolean(d.alert)}),d.message)await y(t,a,d.message,{disablePreview:!0});return!0}case"tech_prompt":{if(!l)return await g(t,e.id,{text:"Команда недоступна",showAlert:!0}),!0;if(l==="clear_report")return await Q(t,a,q("tech_clear_report","__tech__",n)),await dt(t,a,"Введите ID проекта для удаления отчёта из R2"),await g(t,e.id,{text:"Введите ID"}),!0;if(l==="clear_prefix")return await Q(t,a,q("tech_clear_prefix","__tech__",n)),await dt(t,a,"Укажите префикс (по умолчанию cache/)"),await g(t,e.id,{text:"Введите префикс"}),!0;if(l==="webhook")return await Q(t,a,q("tech_webhook_token","__tech__",n)),await dt(t,a,"Укажите токен бота (оставьте пустым для основного)"),await g(t,e.id,{text:"Введите токен"}),!0;return await g(t,e.id,{text:"Команда недоступна",showAlert:!0}),!0}case"refresh_all":{let d=await bt(t),m=Array.isArray(d?.refreshed)?d.refreshed.length:0;return await y(t,a,`\uD83D\uDD01 Обновление отчётов завершено. Обновлено проектов: ${m}`),await g(t,e.id,{text:"Обновление выполнено"}),!0}default:return!1}}catch(d){return await w(t,{level:"error",message:`Admin callback error: ${d.message}`,timestamp:new Date().toISOString()}),await y(t,a,"⚠️ Не удалось выполнить действие администратора. Попробуйте позже."),await g(t,e.id,{text:"Ошибка выполнения",showAlert:!0}),!0}},ss=async(t,e)=>{let a=e.data||"",n=e.message,r=n?String(n.chat.id):null,s=n?.message_id;if(!r||typeof s!=="number"){await g(t,e.id);return}try{if(a==="report_menu"){await Da(t,r,{messageId:s}),await g(t,e.id);return}if(a.startsWith("report:")){let o=a.split(":",2)[1];if(o)await Ee(t,r,o,{messageId:s}),await g(t,e.id);else await g(t,e.id,{text:"Проект не найден",showAlert:!0});return}if(a.startsWith("refresh:")){let o=a.split(":",2)[1];if(o)await Ee(t,r,o,{messageId:s}),await g(t,e.id,{text:"Данные обновлены"});else await g(t,e.id,{text:"Проект не найден",showAlert:!0});return}if(a.startsWith("admin:")){if(!await rs(t,e,r,s))await g(t,e.id,{text:"Команда недоступна",showAlert:!0});return}await g(t,e.id)}catch(o){await w(t,{level:"error",message:`Telegram callback error: ${o.message}`,timestamp:new Date().toISOString()}),await g(t,e.id,{text:"Произошла ошибка",showAlert:!0})}},os=async(t,e,a)=>{let n=await ne(t,e);if(!n)return!1;let r=a.trim();if(!r)return await y(t,e,"Введите значение или /cancel для отмены."),!0;if(r.toLowerCase()==="/cancel")return await H(t,e),await y(t,e,"Действие отменено."),!0;let o=(await C(t)).find((l)=>l.id===n.projectId),i=o?.billing?.currency||o?.currency||"USD";try{switch(n.kind){case"billing_amount":{let l=re(r);if(l===null)return await y(t,e,"Введите числовое значение для суммы."),!0;if(!await le(t,n.projectId,{amount:l},`amount => ${l}`))return await y(t,e,"⚠️ Не удалось обновить сумму. Попробуйте позже."),!0;if(await H(t,e),await y(t,e,`✅ Сумма обновлена: ${k(l,i)}`),n.messageId!==void 0)await J(t,e,n.projectId,{messageId:n.messageId});return!0}case"billing_date":{let l=Jr(r);if(!l)return await y(t,e,"Введите дату в формате YYYY-MM-DD или DD.MM.YYYY."),!0;if(!await le(t,n.projectId,{next_payment:l,next_payment_date:l},`next_payment => ${l}`))return await y(t,e,"⚠️ Не удалось обновить дату оплаты."),!0;if(await H(t,e),await y(t,e,`✅ Дата следующей оплаты: ${l}`),n.messageId!==void 0)await J(t,e,n.projectId,{messageId:n.messageId});return!0}case"alerts_cpa":{let l=re(r);if(l===null)return await y(t,e,"Введите числовой порог CPA."),!0;if(!await Te(t,n.projectId,{cpa_threshold:l},`cpa => ${l}`))return await y(t,e,"⚠️ Не удалось обновить порог CPA."),!0;if(await H(t,e),await y(t,e,`✅ Порог CPA обновлён: ${l}`),n.messageId!==void 0)await J(t,e,n.projectId,{messageId:n.messageId});return!0}case"alerts_spend":{let l=re(r);if(l===null)return await y(t,e,"Введите числовой лимит расходов."),!0;if(!await Te(t,n.projectId,{spend_limit:l},`spend => ${l}`))return await y(t,e,"⚠️ Не удалось обновить лимит расходов."),!0;if(await H(t,e),await y(t,e,`✅ Лимит расходов обновлён: ${l}`),n.messageId!==void 0)await J(t,e,n.projectId,{messageId:n.messageId});return!0}case"alerts_moderation":{let l=re(r);if(l===null)return await y(t,e,"Введите количество часов для модерации."),!0;if(!await Te(t,n.projectId,{moderation_hours:l},`moderation => ${l}`))return await y(t,e,"⚠️ Не удалось обновить параметр модерации."),!0;if(await H(t,e),await y(t,e,`✅ Порог модерации обновлён: ${l} ч.`),n.messageId!==void 0)await J(t,e,n.projectId,{messageId:n.messageId});return!0}case"tech_clear_report":{let l=await oe(t,"clear_report",r);if(await H(t,e),await y(t,e,l.message||l.toast||"Готово",{disablePreview:!0}),n.messageId!==void 0)await Kt(t,e,{messageId:n.messageId});return!0}case"tech_clear_prefix":{let c=await oe(t,"clear_prefix",r||"cache/");if(await H(t,e),await y(t,e,c.message||c.toast||"Готово",{disablePreview:!0}),n.messageId!==void 0)await Kt(t,e,{messageId:n.messageId});return!0}case"tech_webhook_token":{let c=await oe(t,"webhook",r);if(await H(t,e),await y(t,e,c.message||c.toast||"Готово",{disablePreview:!0}),n.messageId!==void 0)await Kt(t,e,{messageId:n.messageId});return!0}default:return!1}}catch(l){return await w(t,{level:"error",message:`Admin session input failed: ${l.message}`,timestamp:new Date().toISOString()}),await y(t,e,"⚠️ Ошибка обработки ввода. Попробуйте позже."),await H(t,e),!0}},Oa=async(t,e)=>{let a=null;try{a=await t.json()}catch(i){return new Response("bad request",{status:400})}if(a)try{console.log("telegram update",JSON.stringify(a))}catch(i){console.log("telegram update received")}if(a&&a.callback_query)return await ss(e,a.callback_query),new Response("ok");let n=a&&a.message;if(!n||!n.text)return new Response("ok");let r=String(n.chat.id),s=ye(e);if(s.includes(r)){if(await os(e,r,n.text))return new Response("ok")}let o=br(n.text);if(!o)return new Response("ok");try{switch(o.command){case"/start":await L(e,r,_r);break;case"/help":await L(e,r,yr);break;case"/admin":if(console.log("Admin check:",{chatId:r,ADMIN_IDS:s}),s.includes(r))await Ea(e,r);else await L(e,r,"⛔ У вас нет доступа к админ-панели.");break;case"/report":await Xr(e,r,o.args);break;case"/project":if(!o.args[0])await L(e,r,"Укажите ID проекта: /project <id>");else await ts(e,r,o.args[0]);break;case"/campaigns":if(!o.args[0])await L(e,r,"Укажите ID проекта: /campaigns <id>");else await es(e,r,o.args[0]);break;case"/refresh":if(!o.args[0])await L(e,r,"Укажите ID проекта: /refresh <id>");else await as(e,r,o.args[0]);break;case"/alertsettings":await ns(e,r);break;default:await L(e,r,"Команда не поддерживается");break}}catch(i){await w(e,{level:"error",message:`Telegram handler error: ${i.message}`,timestamp:new Date().toISOString()}),await L(e,r,"Произошла ошибка при обработке команды")}return new Response("ok")};var is=async(t)=>{try{let e=await t.json();if(!e||typeof e!=="object")return null;let a=e;if(!a.project_id||!a.metric||a.value===void 0||a.threshold===void 0)return null;return a}catch(e){return null}},ls=(t)=>{let e=t.direction==="below"?"↓":"↑",a=[`⚠️ Алерт по проекту ${t.project_id}`,`${t.metric.toUpperCase()}: ${t.value} (${e} порога ${t.threshold})`];if(t.campaign_id)a.push(`Кампания: ${t.campaign_id}`);if(t.description)a.push(t.description);return a.join(`
`)},Na=async(t,e)=>{let a=await is(t);if(!a)return E("Invalid alert payload");let n=String(e.ALERT_CHAT_ID||e.ADMIN_CHAT_ID||"");if(!n)return E("Alert chat not configured");let r=ls(a);return await y(e,n,r),await w(e,{level:"warn",message:`Alert dispatched: ${a.metric} for ${a.project_id}`,timestamp:new Date().toISOString()}),h({ok:!0})};var cs=(t)=>{let e=t.headers.get("Authorization");if(e&&e.toLowerCase().startsWith("bearer ")){let r=e.slice(7).trim();if(r)return r}let n=new URL(t.url).searchParams.get("key");return n&&n.trim()?n.trim():null},Ia=(t,e)=>{let a=typeof e.ADMIN_KEY==="string"?e.ADMIN_KEY:"";if(!a)return null;if(cs(t)===a)return null;return K("Invalid admin key")},Me=async(t,e)=>{let a=Ia(t,e);if(a)return a;let n=await Z(e);return h(n)},De=async(t,e)=>{let a=Ia(t,e);if(a)return a;let n=await at(e,{force:!0,notify:!0});return h(n)},La=(t,e)=>{let n=(typeof e.WORKER_URL==="string"?e.WORKER_URL.trim():"")||new URL(t.url).origin;return n.endsWith("/")?n.slice(0,-1):n},Fa=(t)=>{return(typeof t.FB_GRAPH_VERSION==="string"?t.FB_GRAPH_VERSION.trim():"")||"v18.0"},kt=(t,e,a={})=>{let n=a.status||"success",r=n==="success"?"#00b87c":n==="warning"?"#fbbf24":"#f87171",s=(a.links||[]).map((l)=>`<a class="action" href="${l.href}" rel="noopener noreferrer" target="_blank">${l.label}</a>`).join(""),o=a.redirect?`<meta http-equiv="refresh" content="2;url=${a.redirect}" />`:"",i=a.redirect?`<p class="redirect">Через пару секунд откроется Telegram. Если этого не произошло, <a href="${a.redirect}" rel="noopener noreferrer" target="_blank">нажмите сюда</a>.</p>`:"";return`<!DOCTYPE html>
<html lang="ru">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    ${o}
    <title>${t}</title>
    <style>
      :root { color-scheme: dark; }
      body {
        margin: 0;
        min-height: 100vh;
        background: #0f172a;
        display: flex;
        align-items: center;
        justify-content: center;
        font-family: "Inter", "Segoe UI", system-ui, -apple-system, sans-serif;
        color: #e2e8f0;
        padding: 32px;
      }
      .card {
        width: min(520px, 100%);
        border-radius: 20px;
        padding: 28px;
        background: rgba(15, 23, 42, 0.85);
        box-shadow: 0 25px 50px -12px rgba(15, 23, 42, 0.65);
        backdrop-filter: blur(18px);
      }
      h1 {
        margin: 0 0 16px;
        font-size: 26px;
        color: ${r};
      }
      p {
        margin: 0 0 12px;
        line-height: 1.6;
      }
      .details {
        margin-top: 8px;
        padding: 12px 14px;
        border-radius: 12px;
        background: rgba(148, 163, 184, 0.1);
        font-size: 15px;
      }
      .actions {
        margin-top: 18px;
        display: flex;
        gap: 12px;
        flex-wrap: wrap;
      }
      .action {
        display: inline-flex;
        align-items: center;
        justify-content: center;
        padding: 10px 18px;
        border-radius: 999px;
        font-weight: 600;
        font-size: 15px;
        text-decoration: none;
        color: #0f172a;
        background: ${r};
      }
      .redirect {
        margin-top: 16px;
        color: #94a3b8;
      }
      .redirect a {
        color: ${r};
      }
    </style>
  </head>
  <body>
    <main class="card">
      <h1>${t}</h1>
      <p>${e}</p>
      ${a.details?`<p class="details">${a.details}</p>`:""}
      ${i}
      ${s?`<div class="actions">${s}</div>`:""}
    </main>
  </body>
</html>`},ds=(t)=>{let e=typeof t.WORKER_URL==="string"?t.WORKER_URL.trim():"";if(!e)return null;let a=e.replace(/\/$/,""),n=typeof t.ADMIN_KEY==="string"&&t.ADMIN_KEY.trim()?t.ADMIN_KEY.trim():"",r=n?`?key=${encodeURIComponent(n)}`:"";return`${a}/admin${r}`},us=(t)=>{let e=t,a=["BOT_URL","BOT_LINK","TELEGRAM_BOT_URL"];for(let r of a){let s=typeof e[r]==="string"?e[r].trim():"";if(s)return s}let n=["BOT_USERNAME","TELEGRAM_BOT_USERNAME","TG_BOT_USERNAME"];for(let r of n){let s=typeof e[r]==="string"?e[r].trim():"";if(s)return`https://t.me/${s.startsWith("@")?s.slice(1):s}`}return null},va=async(t,e)=>{let a=typeof e.FB_APP_ID==="string"?e.FB_APP_ID.trim():"";if(!a){let c=kt("Авторизация Facebook","⚠️ Не указан идентификатор приложения Facebook (FB_APP_ID). Добавьте его в переменные окружения Cloudflare.",{status:"error"});return V(c,{status:500})}let n=Fa(e),s=`${La(t,e)}/auth/facebook/callback`,o=new URL(t.url).searchParams.get("scope")||"ads_management,business_management",i=new URL(t.url).searchParams.get("state"),l=new URL(`https://www.facebook.com/${n}/dialog/oauth`);if(l.searchParams.set("client_id",a),l.searchParams.set("redirect_uri",s),l.searchParams.set("response_type","code"),l.searchParams.set("scope",o),i)l.searchParams.set("state",i);return new Response(null,{status:302,headers:{Location:l.toString()}})},Ba=async(t,e)=>{let a=new URL(t.url),n=a.searchParams.get("error"),r=a.searchParams.get("error_description");if(n){let j=r?` — ${r}`:"",I=`⚠️ Авторизация Facebook отклонена: ${n}${j}`;await w(e,{level:"warn",message:I,timestamp:new Date().toISOString()});let D=kt("Авторизация отменена",I,{status:"warning"});return V(D,{status:400})}let s=a.searchParams.get("code");if(!s){let j=kt("Ошибка авторизации","⚠️ Не удалось получить код авторизации Facebook. Попробуйте начать процесс заново.",{status:"error"});return V(j,{status:400})}let o=typeof e.FB_APP_ID==="string"?e.FB_APP_ID.trim():"",i=typeof e.FB_APP_SECRET==="string"?e.FB_APP_SECRET.trim():"";if(!o||!i){let j=kt("Ошибка конфигурации","⚠️ Отсутствуют переменные FB_APP_ID и/или FB_APP_SECRET. Добавьте их в Cloudflare Workers → Variables.",{status:"error"});return V(j,{status:500})}let c=`${La(t,e)}/auth/facebook/callback`,d=Fa(e),m=new URL(`https://graph.facebook.com/${d}/oauth/access_token`);m.searchParams.set("client_id",o),m.searchParams.set("client_secret",i),m.searchParams.set("redirect_uri",c),m.searchParams.set("code",s);let f=null;try{let j=await fetch(m.toString(),{method:"GET"});if(!j.ok){let I=await j.text();throw new Error(`Token exchange failed: ${I}`)}f=await j.json()}catch(j){let I=j.message||"Неизвестная ошибка обмена токена.";await w(e,{level:"error",message:`Facebook OAuth exchange error: ${I}`,timestamp:new Date().toISOString()}),await G(e,`\uD83D\uDEA8 Ошибка обмена Meta токена: ${I}`);let D=kt("Ошибка авторизации",`\uD83D\uDEA8 Не удалось получить токен доступа. Сообщение: ${I}`,{status:"error"});return V(D,{status:500})}let p=typeof f?.access_token==="string"?f.access_token:null;if(!p){let j=kt("Ошибка авторизации","\uD83D\uDEA8 Facebook не вернул access_token. Попробуйте авторизоваться ещё раз.",{status:"error"});return V(j,{status:500})}let x=typeof f?.expires_in==="number"?f.expires_in:null,_=typeof f?.token_type==="string"?f.token_type:null,$=Date.now(),b=new Date($).toISOString(),A=null,T=null;try{let j=new URL(`https://graph.facebook.com/${d}/me`);j.searchParams.set("fields","id,name"),j.searchParams.set("access_token",p);let I=await fetch(j.toString());if(I.ok){let D=await I.json();if(D&&typeof D==="object"){if(typeof D.id==="string")A=D.id;if(typeof D.name==="string")T=D.name}}}catch(j){}await ea(e,{access_token:p,issued_at:$,refreshed_at:b,expires_at:x?$+x*1000:void 0,account_id:A,account_name:T,token_type:_}),await w(e,{level:"info",message:`Meta OAuth callback completed. Account: ${T||A||"unknown"}, expires in ${x?`${Math.round(x/60)} мин.`:"unknown"}`,timestamp:new Date().toISOString()});let N=await at(e,{notify:!0}),S=N.status,$t=ds(e),Ut=typeof e.DEFAULT_TZ==="string"&&e.DEFAULT_TZ.trim()?e.DEFAULT_TZ.trim():"Asia/Tashkent",ue=(j)=>{if(!j)return null;try{return new Intl.DateTimeFormat("ru-RU",{dateStyle:"medium",timeStyle:"short",timeZone:Ut}).format(new Date(j))}catch(I){return j}},At="Авторизация Facebook завершена",ut="✅ Токен успешно сохранён. Вернитесь в Telegram, чтобы продолжить работу.",me="",Wt="success";if(S.status==="expired")At="Токен истёк",ut="⚠️ Полученный токен уже отмечен как истекший. Попробуйте пройти авторизацию заново.",Wt="warning";else if(!S.ok)At="Ошибка проверки токена",ut="\uD83D\uDEA8 Токен сохранён, но проверка Facebook вернула ошибку.",me=S.issues&&S.issues.length?S.issues.join(`
`):"Уточните детали в админ-панели.",Wt="error";else{let j=S.expires_at||N.refresh?.expires_at||null,I=ue(j),D=[];if(T)D.push(`\uD83D\uDC64 Аккаунт: ${T}${A?` (${A})`:""}`);if(I)D.push(`⏱ Действителен до: ${I}`);if(S.should_refresh)D.push("⚠️ Рекомендуется продлить токен в ближайшее время."),Wt="warning";me=D.join("<br />")}let pe=us(e),Gt=[];if(pe)Gt.push({href:pe,label:"Открыть бота"});if($t)Gt.push({href:$t,label:"Открыть админ-панель"});if(S.status==="ok"){let j=S.expires_at||N.refresh?.expires_at||null,I=j?M(j,Ut):null,D=["✅ Facebook подключён."];if(T||A)D.push(`Аккаунт: ${T||A}`);if(I)D.push(`Действителен до: ${I}`);if(S.should_refresh)D.push("⚠️ Обновите токен в ближайшие 24 часа.");D.push("Откройте /admin для управления проектами."),await G(e,D.join(`
`))}let Ka=kt(At,ut,{details:me,status:Wt,links:Gt.length?Gt:void 0,redirect:pe||void 0});return V(Ka)};var de=()=>Y("Route not found"),ms=async(t,e,a)=>{if(a.length===2)return qe(t,e,a[1]);if(a.length===3&&a[2]==="campaigns")return Qe(t,e,a[1]);return de()},ps=async(t,e,a)=>{if(a[1]==="ping"&&t.method==="GET")return h({pong:!0,timestamp:new Date().toISOString()});if(a[1]==="meta"&&a[2]==="status"&&t.method==="GET")return Ye(e);if(a[1]==="auth"&&a.length>=4&&a[2]==="facebook"){if(a[3]==="status"&&t.method==="GET")return Me(t,e);if(a[3]==="refresh"&&(t.method==="POST"||t.method==="GET"))return De(t,e)}if(a[1]==="projects"&&t.method==="GET")return He(e);if(a[1]==="admin"){if(a.length===2){if(t.method==="GET")return ma(t,e);if(t.method==="POST")return ha(t,e)}if(a.length===3){if(a[2]==="logs"&&t.method==="GET")return wa(t,e);if(a[2]==="billing"&&t.method==="GET")return ka(t,e);if(a[2]==="accounts"&&t.method==="GET")return pa(t,e);if(a[2]==="system"){if(t.method==="GET")return $a(t,e);if(t.method==="POST")return Aa(t,e)}}if(a.length>=4&&a[2]==="account"){let n=a[3];if(a.length===5&&a[4]==="link"&&t.method==="POST")return fa(t,e,n)}if(a.length>=4&&a[2]==="project"){let n=a[3];if(a.length===4){if(t.method==="GET")return ga(t,e,n);if(t.method==="POST"||t.method==="PATCH")return ba(t,e,n)}if(a.length===5){if(a[4]==="toggle"&&t.method==="POST")return _a(t,e,n);if(a[4]==="billing"&&t.method==="POST")return ya(t,e,n);if(a[4]==="alerts"&&t.method==="POST")return xa(t,e,n)}}}if(a[1]==="project"&&a.length>=3){let n=a[2];if(a.length===3&&t.method==="GET")return Je(e,n);if(a.length===3&&t.method==="POST"){let s=new URL(t.url).searchParams.get("period")||void 0;return ke(e,n,s||void 0)}if(a.length===4&&a[3]==="refresh"){let r=new URL(t.url).searchParams.get("period")||void 0;if(t.method==="POST"||t.method==="GET")return ke(e,n,r)}}if(a[1]==="project"&&a.length>=3&&a[2]==="refresh-all"&&t.method==="POST")return ua(e);if(a[1]==="tg"&&a.length>=3&&a[2]==="alert"&&t.method==="POST")return Na(t,e);return de()},fs=async(t,e,a)=>{if(a.length>=2&&a[1]==="facebook"){if(a.length===3&&a[2]==="login"&&t.method==="GET")return va(t,e);if(a.length===3&&a[2]==="callback"&&t.method==="GET")return Ba(t,e);if(a.length===3&&a[2]==="status"&&t.method==="GET")return Me(t,e);if(a.length===3&&a[2]==="refresh"&&(t.method==="GET"||t.method==="POST"))return De(t,e)}return de()},gs=(t,e)=>da(t,e),bi={async fetch(t,e,a){let r=new URL(t.url).pathname,s=r.split("/").filter(Boolean);try{if(r==="/"&&t.method==="GET")return Oe("ok");if(r==="/health")return h({ok:!0,timestamp:new Date().toISOString()});if(s[0]==="portal")return ms(t,e,s);if(s[0]==="admin")return gs(t,e);if(s[0]==="auth")return fs(t,e,s);if(s[0]==="api")return ps(t,e,s);if(s[0]==="manage"){if(s.length>=3&&s[1]==="telegram"&&s[2]==="webhook")return ra(t,e);if(s.length>=2&&s[1]==="meta")return sa(t,e)}if((s[0]==="tg"||s[0]==="telegram"||s[0]==="webhook")&&t.method==="POST")return Oa(t,e);return de()}catch(o){return await w(e,{level:"error",message:`Unhandled error: ${o.message}`,timestamp:new Date().toISOString()}),Ht("Internal error")}},async scheduled(t,e,a){a.waitUntil((async()=>{let n=t.cron||"",r=!n||n==="*/5 * * * *"||n==="0 3 * * *",s=!n||n==="0 3 * * *";if(r)try{let i=`Scheduled refresh completed for ${(await bt(e)).refreshed.length} projects`;await w(e,{level:"info",message:i,timestamp:new Date().toISOString()}),await It(e,"projects-refresh",{ok:!0,message:i})}catch(o){let i=`Scheduled refresh failed: ${o.message}`;await w(e,{level:"error",message:i,timestamp:new Date().toISOString()}),await It(e,"projects-refresh",{ok:!1,message:i}),await G(e,`\uD83D\uDEA8 Ошибка крон-задачи проектов: ${o.message}`)}if(s)try{let o=await at(e,{notify:!0}),i=o.refresh&&o.refresh.message?` - ${o.refresh.message}`:"",l=`Meta token check status: ${o.status.status}${i}`;await w(e,{level:o.refresh&&o.refresh.ok?"info":"warn",message:l,timestamp:new Date().toISOString()}),await It(e,"meta-token",{ok:o.refresh?o.refresh.ok:o.status.ok,message:l})}catch(o){let i=`Meta token scheduled check failed: ${o.message}`;await w(e,{level:"error",message:i,timestamp:new Date().toISOString()}),await It(e,"meta-token",{ok:!1,message:i}),await G(e,`\uD83D\uDEA8 Ошибка проверки Meta токена: ${o.message}`)}})())}};export{bi as default};
