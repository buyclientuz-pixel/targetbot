# Cloudflare Manual Verification Guide

Следуйте этим шагам, чтобы убедиться, что TargetBot корректно запускается в локальном режиме `wrangler dev` и готов к ручному деплою на Cloudflare. Для краткой памятки см. [Manual Deployment Quickstart](./manual-deploy-quickstart.md). Если столкнётесь с ошибками, откройте также [Manual Deployment FAQ](./manual-deploy-faq.md).

## 1. Подготовьте переменные окружения

Перед запуском убедитесь, что файлы `.env` и `.dev.vars` содержат актуальные значения токенов и ключей. Wrangler будет автоматически подхватывать `.dev.vars` при запуске команды `wrangler dev`.

```bash
cp .env .dev.vars    # при необходимости обновите секреты перед запуском
```

## 2. Запустите воркер локально

```bash
npx wrangler dev --inspect
```

Флаг `--inspect` включает вывод логов входящих запросов и ответов, что помогает отлаживать сценарии Telegram и REST API.

## 3. Проверьте ключевые эндпоинты

Откройте новый терминал и выполните проверки:

```bash
curl http://127.0.0.1:8787/health
curl http://127.0.0.1:8787/api/health
curl "http://127.0.0.1:8787/api/leads" -H "X-Auth-Key: !Lyas123"
```

Для тестирования админ-панели откройте браузер и перейдите по адресу:

```
http://127.0.0.1:8787/admin?key=!Lyas123
```

Убедитесь, что таблицы лидов и пользователей загружаются, а кнопки синхронизации Meta и обновления вебхука отображаются без ошибок в консоли.

## 4. Имитация Telegram webhook

Чтобы проверить обработку обновлений, отправьте тестовый запрос с валидным `botId`:

```bash
curl -X POST "http://127.0.0.1:8787/telegram/8492565329" \
  -H "Content-Type: application/json" \
  -d '{"update_id":1,"message":{"message_id":10,"chat":{"id":7623982602,"type":"private"},"from":{"id":7623982602,"is_bot":false,"first_name":"Test"},"date":1710000000,"text":"/start"}}'
```

Ответ должен содержать `{ "ok": true }` или другое сообщение, сигнализирующее об успешной обработке команды.

## 5. Выполните ручной деплой

Если локальные проверки прошли успешно, выполните последовательность ручного деплоя:

```bash
npm install
npm run build
npx wrangler deploy
```

После деплоя запросите публичные эндпоинты воркера (`https://th-reports.buyclientuz.workers.dev/health`) и убедитесь, что ответы совпадают с локальными тестами.

## 6. Зафиксируйте результаты

Занесите итоги проверки в свой внутренний журнал или систему трекинга. Рекомендуется сохранять дату, commit hash и список проверенных эндпоинтов для будущих регрессий.

---

Следуя этому чек-листу, вы подтверждаете, что ручной рабочий процесс (без CI/CD) остаётся надёжным и воспроизводимым.
