# –û–ø–µ—Ä–∞—Ü–∏–æ–Ω–Ω—ã–π runbook Targetbot

–î–æ–∫—É–º–µ–Ω—Ç –ø–æ–º–æ–≥–∞–µ—Ç –¥–µ–∂—É—Ä–Ω–æ–π –∫–æ–º–∞–Ω–¥–µ —Ä–µ–∞–≥–∏—Ä–æ–≤–∞—Ç—å –Ω–∞ —Å–±–æ–∏ Cloudflare Worker-–∞, Telegram-–±–æ—Ç–∞ –∏ –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏–∏ —Å Meta (Facebook).

## 1. –ö–∞–∫ –æ–±–Ω–∞—Ä—É–∂–∏—Ç—å –ø—Ä–æ–±–ª–µ–º—É

| –°–∏–º–ø—Ç–æ–º | –ì–¥–µ –ø—Ä–æ–≤–µ—Ä—è—Ç—å | –í–æ–∑–º–æ–∂–Ω–∞—è –ø—Ä–∏—á–∏–Ω–∞ |
| --- | --- | --- |
| `/health` –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç 5xx | Cloudflare Dashboard ‚Üí Workers ‚Üí Logs | –û—à–∏–±–∫–∞ —Ä–∞–Ω—Ç–∞–π–º–∞ –∏–ª–∏ –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω KV/R2 |
| `/api/meta/status` —Å–æ–æ–±—â–∞–µ—Ç `missing/expired` | Meta OAuth –∏—Å—Ç—ë–∫ –∏–ª–∏ –Ω–µ—Ç —Ç–æ–∫–µ–Ω–∞ –≤ KV |
| `/admin` –ø—É—Å—Ç–æ–π —Å–ø–∏—Å–æ–∫ –∫–∞–±–∏–Ω–µ—Ç–æ–≤ | –û—à–∏–±–∫–∞ Graph API, –∏—Å—Ç—ë–∫ —Ç–æ–∫–µ–Ω, –Ω–µ–≤–µ—Ä–Ω—ã–µ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –æ–∫—Ä—É–∂–µ–Ω–∏—è |
| –õ–∏–¥—ã –Ω–µ –ø—Ä–∏—Ö–æ–¥—è—Ç –≤ —á–∞—Ç | –ù–µ—Ç —Ç–æ–∫–µ–Ω–∞ Telegram, –ø—Ä–æ–µ–∫—Ç –Ω–µ –ø—Ä–∏–≤—è–∑–∞–Ω –∫ —á–∞—Ç—É, –æ—à–∏–±–∫–∞ R2 |
| `/portal/:id` –ø–æ–∫–∞–∑—ã–≤–∞–µ—Ç 404 | –ü—Ä–æ–µ–∫—Ç –Ω–µ –Ω–∞–π–¥–µ–Ω –∏–ª–∏ –ø–æ–≤—Ä–µ–∂–¥—ë–Ω –∏–Ω–¥–µ–∫—Å –≤ R2 |

## 2. –ü—Ä–∏–æ—Ä–∏—Ç–µ—Ç—ã –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏—è

1. **Meta OAuth** ‚Äî –±–µ–∑ –≤–∞–ª–∏–¥–Ω–æ–≥–æ —Ç–æ–∫–µ–Ω–∞ –Ω–µ—Ç –∫–∞–±–∏–Ω–µ—Ç–æ–≤ –∏ –ª–∏–¥–æ–≤.
2. **Telegram —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è** ‚Äî –∫–ª–∏–µ–Ω—Ç—ã –Ω–µ —É–≤–∏–¥—è—Ç –Ω–æ–≤—ã–µ –∑–∞—è–≤–∫–∏.
3. **–•—Ä–∞–Ω–∏–ª–∏—â–µ –ø—Ä–æ–µ–∫—Ç–æ–≤ –∏ –ª–∏–¥–æ–≤ (R2)** ‚Äî –¥–∞–Ω–Ω—ã–µ –∫–∞—Ä—Ç–æ—á–µ–∫ –ø–æ—Ä—Ç–∞–ª–∞ –∏ –∞–¥–º–∏–Ω–∫–∏.
4. **–ê–¥–º–∏–Ω–∫–∞** ‚Äî —É–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è–º–∏ –∏ –ø—Ä–æ–µ–∫—Ç–∞–º–∏.

## 3. Meta OAuth –∏ Graph API

1. –ü—Ä–æ–≤–µ—Ä–∏—Ç—å `/api/meta/status` ‚Äî –ø–æ–ª–µ `status` –¥–æ–ª–∂–Ω–æ –±—ã—Ç—å `valid`.
2. –ï—Å–ª–∏ `missing` –∏–ª–∏ `expired`:
   - –û—Ç–∫—Ä—ã—Ç—å `/admin` –∏ –Ω–∞–∂–∞—Ç—å ¬´–û–±–Ω–æ–≤–∏—Ç—å —Ç–æ–∫–µ–Ω¬ª, –ª–∏–±–æ –≤—ã–ø–æ–ª–Ω–∏—Ç—å `/api/meta/oauth/start` –≤—Ä—É—á–Ω—É—é.
   - –ü—Ä–æ–π—Ç–∏ OAuth, —É–±–µ–¥–∏—Ç—å—Å—è, —á—Ç–æ —Ä–µ–¥–∏—Ä–µ–∫—Ç –ø–æ–ø–∞–ª –Ω–∞ `/api/meta/oauth/callback`.
   - –ü—Ä–æ–≤–µ—Ä–∏—Ç—å, —á—Ç–æ –≤ KV –ø–æ—è–≤–∏–ª—Å—è –∫–ª—é—á `meta:token` (Cloudflare Dashboard ‚Üí KV ‚Üí namespace DB).
3. –î–ª—è —Ä—É—á–Ω–æ–≥–æ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è –≤—ã–∑–≤–∞—Ç—å:
   ```bash
   curl -X POST https://<worker>/api/meta/refresh
   ```
   –û—Ç–≤–µ—Ç –¥–æ–ª–∂–µ–Ω —Å–æ–¥–µ—Ä–∂–∞—Ç—å `ok: true` –∏ –æ–±–Ω–æ–≤–ª—ë–Ω–Ω—ã–π —Å—Ç–∞—Ç—É—Å.
4. –ï—Å–ª–∏ Graph API –ø–∞–¥–∞–µ—Ç —Å 4xx/5xx ‚Äî —Å–≤–µ—Ä–∏—Ç—å `FB_APP_ID`/`FB_APP_SECRET` –∏ —É–±–µ–¥–∏—Ç—å—Å—è, —á—Ç–æ —Ç–æ–∫–µ–Ω –∏–º–µ–µ—Ç –¥–æ—Å—Ç—É–ø –∫ —Ä–µ–∫–ª–∞–º–Ω—ã–º –∫–∞–±–∏–Ω–µ—Ç–∞–º.

## 4. Telegram —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è

1. –£–±–µ–¥–∏—Ç—å—Å—è, —á—Ç–æ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ `BOT_TOKEN` –∏–ª–∏ `TELEGRAM_BOT_TOKEN` –∑–∞–¥–∞–Ω—ã (Cloudflare Dashboard ‚Üí Worker ‚Üí Settings ‚Üí Variables).
2. –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –ª–æ–≥–∏ –≤ Cloudflare Dashboard ‚Üí Workers ‚Üí Logs ‚Äî –ø—Ä–∏ –æ—Ç–ø—Ä–∞–≤–∫–µ —Å–æ–æ–±—â–µ–Ω–∏–π –≤—ã–≤–æ–¥–∏—Ç—Å—è –æ—à–∏–±–∫–∞ `Failed to send Telegram message`.
3. –£–±–µ–¥–∏—Ç—å—Å—è, —á—Ç–æ –ø—Ä–æ–µ–∫—Ç –ø—Ä–∏–≤—è–∑–∞–Ω –∫ —á–∞—Ç—É (`telegramChatId` –≤ `/api/projects` –∏ –Ω–∞ —Å—Ç—Ä–∞–Ω–∏—Ü–µ `/admin`).
4. –ü—Ä–∏ –Ω–µ–æ–±—Ö–æ–¥–∏–º–æ—Å—Ç–∏ –æ—Ç–ø—Ä–∞–≤–∏—Ç—å —Ç–µ—Å—Ç–æ–≤–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ –≤—Ä—É—á–Ω—É—é:
   ```bash
   curl -X POST https://<worker>/api/leads \
     -H 'content-type: application/json' \
     -d '{"projectId":"<id>","name":"–¢–µ—Å—Ç","phone":"+70000000000"}'
   ```
   –í —á–∞—Ç–µ –¥–æ–ª–∂–Ω–æ –ø–æ—è–≤–∏—Ç—å—Å—è —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ ¬´üì• –ù–æ–≤—ã–π –ª–∏–¥¬ª.

## 5. –ü—Ä–æ–µ–∫—Ç—ã –∏ –ø–æ—Ä—Ç–∞–ª

1. –ü–æ—Å–º–æ—Ç—Ä–µ—Ç—å —Å–ø–∏—Å–æ–∫ –ø—Ä–æ–µ–∫—Ç–æ–≤:
   ```bash
   curl https://<worker>/api/projects | jq
   ```
2. –ï—Å–ª–∏ –ø—Ä–æ–µ–∫—Ç –æ—Ç—Å—É—Ç—Å—Ç–≤—É–µ—Ç ‚Äî –¥–æ–±–∞–≤—å—Ç–µ –µ–≥–æ —á–µ—Ä–µ–∑ `/admin` –∏–ª–∏ –æ—Ç–ø—Ä–∞–≤—å—Ç–µ POST `/api/projects`.
3. –ü—Ä–∏ –ø–æ–≤—Ä–µ–∂–¥—ë–Ω–Ω—ã—Ö –¥–∞–Ω–Ω—ã—Ö –≤ R2 (–ø—É—Å—Ç—ã–µ –º–∞—Å—Å–∏–≤—ã):
   - –û—Ç–∫—Ä–æ–π—Ç–µ Cloudflare Dashboard ‚Üí R2 ‚Üí bucket `R2` ‚Üí –æ–±—ä–µ–∫—Ç—ã `projects/index.json` –∏ `leads/<projectId>.json`.
   - –í–æ—Å—Å—Ç–∞–Ω–æ–≤–∏—Ç–µ —Å–æ–¥–µ—Ä–∂–∏–º–æ–µ –∏–∑ —Ä–µ–∑–µ—Ä–≤–Ω–æ–π –∫–æ–ø–∏–∏ (–µ—Å–ª–∏ –µ—Å—Ç—å) –∏ —Å–æ—Ö—Ä–∞–Ω–∏—Ç–µ JSON –≤—Ä—É—á–Ω—É—é.
4. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –ø–æ—Ä—Ç–∞–ª –∫–ª–∏–µ–Ω—Ç–∞: `https://<worker>/portal/<projectId>` –¥–æ–ª–∂–µ–Ω –ø–æ–∫–∞–∑—ã–≤–∞—Ç—å —Å–ø–∏—Å–æ–∫ –ª–∏–¥–æ–≤.

## 6. –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏ –∏ –¥–æ—Å—Ç—É–ø—ã

1. –°–ø–∏—Å–æ–∫ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π: `curl https://<worker>/api/users`.
2. –î–ª—è —Å–º–µ–Ω—ã —Ä–æ–ª–∏:
   ```bash
   curl -X PATCH https://<worker>/api/users/<id> \
     -H 'content-type: application/json' \
     -d '{"role":"manager"}'
   ```
3. –£–¥–∞–ª–µ–Ω–∏–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è:
   ```bash
   curl -X DELETE https://<worker>/api/users/<id>
   ```
4. –û–±–Ω–æ–≤–ª–µ–Ω–∏—è –æ—Ç–æ–±—Ä–∞–∂–∞—é—Ç—Å—è –Ω–∞ `/admin/users` –ø–æ—Å–ª–µ –ø–µ—Ä–µ–∑–∞–≥—Ä—É–∑–∫–∏.

## 7. –î–µ–ø–ª–æ–π –∏ –æ—Ç–∫–∞—Ç

1. –ü–µ—Ä–µ–¥ –¥–µ–ø–ª–æ–µ–º –≤—ã–ø–æ–ª–Ω–∏—Ç—å –ª–æ–∫–∞–ª—å–Ω–æ:
   ```bash
   npm install
   npm run build
   ```
   (–í –æ—Ñ–ª–∞–π–Ω –æ–∫—Ä—É–∂–µ–Ω–∏–∏ —É–±–µ–¥–∏—Ç–µ—Å—å, —á—Ç–æ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ —É–∂–µ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω—ã.)
2. –î–µ–ø–ª–æ–π:
   ```bash
   npm run deploy
   ```
3. –ü—Ä–æ–≤–µ—Ä–∫–∞ –ø–æ—Å–ª–µ –≤—ã–∫–∞—Ç–∞ ‚Äî —Å–º. —Ä–∞–∑–¥–µ–ª ¬´–ü–æ—Å—Ç–¥–µ–ø–ª–æ–π–Ω–∞—è –ø—Ä–æ–≤–µ—Ä–∫–∞¬ª –≤ `docs/deployment.md`.
4. –î–ª—è –æ—Ç–∫–∞—Ç–∞ –∏—Å–ø–æ–ª—å–∑—É–π—Ç–µ Cloudflare Dashboard ‚Üí Workers ‚Üí Versions ‚Üí Promote –ø—Ä–µ–¥—ã–¥—É—â—É—é –≤–µ—Ä—Å–∏—é.

## 8. –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–º–∏

- **Meta**: `FB_APP_ID`, `FB_APP_SECRET`, `META_ACCESS_TOKEN`, `META_ACCESS_TOKEN_EXPIRES`, `META_AD_ACCOUNT_IDS`, `META_BUSINESS_IDS`.
- **Telegram**: `BOT_TOKEN` –∏–ª–∏ `TELEGRAM_BOT_TOKEN`.
- **–ü—Ä–æ—á–µ–µ**: `PORTAL_BASE_URL`, `WORKER_BASE_URL` (–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ).

–ò–∑–º–µ–Ω—è–π—Ç–µ –∑–Ω–∞—á–µ–Ω–∏—è —á–µ—Ä–µ–∑ Cloudflare Dashboard –∏–ª–∏ –∫–æ–º–∞–Ω–¥–æ–π:
```bash
echo "<value>" | npx wrangler secret put FB_APP_SECRET
```

## 9. –ö–æ–Ω—Ç–∞–∫—Ç—ã –∏ —ç—Å–∫–∞–ª–∞—Ü–∏—è

| –°–∏—Ç—É–∞—Ü–∏—è | –ö–æ–Ω—Ç–∞–∫—Ç |
| --- | --- |
| –ü—Ä–æ–±–ª–µ–º—ã Cloudflare | https://support.cloudflare.com/ |
| Telegram API 429/5xx | https://t.me/BotSupport |
| Meta Graph API –æ—à–∏–±–∫–∏ –¥–æ—Å—Ç—É–ø–∞ | https://developers.facebook.com/support |
| –û–ø–µ—Ä–∞—Ü–∏–æ–Ω–Ω—ã–µ –≤–æ–ø—Ä–æ—Å—ã –ø–æ –≤–æ—Ä–∫–µ—Ä—É | –¥–µ–∂—É—Ä–Ω—ã–π –º–µ–Ω–µ–¥–∂–µ—Ä –ø—Ä–æ–µ–∫—Ç–∞ (—Å–º. README Progress) |

## 10. –ü–æ—Å—Ç–º–æ—Ä—Ç–µ–º

1. –ó–∞—Ñ–∏–∫—Å–∏—Ä—É–π—Ç–µ –∏–Ω—Ü–∏–¥–µ–Ω—Ç –≤ `docs/incidents/<YYYY-MM-DD>-<slug>.md`.
2. –û–±–Ω–æ–≤–∏—Ç–µ README (—Ä–∞–∑–¥–µ–ª Progress) ‚Äî –æ–ø–∏—à–∏—Ç–µ, —á—Ç–æ —Å–¥–µ–ª–∞–Ω–æ –∏ —á—Ç–æ –æ—Å—Ç–∞–ª–æ—Å—å.
3. –°–æ–∑–¥–∞–π—Ç–µ –∑–∞–¥–∞—á—É —Å –¥–µ–π—Å—Ç–≤–∏—è–º–∏ –ø–æ –ø—Ä–µ–¥–æ—Ç–≤—Ä–∞—â–µ–Ω–∏—é –ø–æ–≤—Ç–æ—Ä–µ–Ω–∏—è.

–î–æ–∫—É–º–µ–Ω—Ç –æ–±–Ω–æ–≤–ª—è–π—Ç–µ –ø–æ—Å–ª–µ –∫–∞–∂–¥–æ–≥–æ —Ä–µ–ª–∏–∑–∞, –µ—Å–ª–∏ –ø–æ—è–≤–ª—è—é—Ç—Å—è –Ω–æ–≤—ã–µ –º–∞—Ä—à—Ä—É—Ç—ã –∏–ª–∏ –ø—Ä–æ—Ü–µ—Å—Å—ã.
