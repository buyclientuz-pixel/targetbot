# Callback schema

Стандартизированные `callback_data` Telegram-бота TargetBot. Все значения кодируются в UTF-8 и не превышают лимит 64 байта.

## Навигационные команды (`cmd:*`)

| Callback | Назначение |
| --- | --- |
| `cmd:menu` | Вернуться в главное меню. |
| `cmd:auth` | Раздел «Авторизация Facebook». |
| `cmd:projects` | Список проектов. |
| `cmd:users` | Раздел «Пользователи». |
| `cmd:meta` | Список Meta-аккаунтов. |
| `cmd:analytics` | Раздел «Аналитика». |
| `cmd:finance` | Раздел «Финансы». |
| `cmd:settings` | Раздел «Настройки». |
| `cmd:webhooks` | Обновление вебхуков Telegram. |

## Проекты (`proj:*`)

| Callback шаблон | Описание |
| --- | --- |
| `proj:new` | Старт создания нового проекта. |
| `proj:new:meta:{metaAccountId}` | Выбор рекламного аккаунта на шаге создания проекта. |
| `proj:new:chat:{chatId}` | Выбор Telegram-группы для нового проекта. |
| `proj:new:confirm` | Подтверждение создания проекта в мастере. |
| `proj:new:cancel` | Отмена мастера создания проекта. |
| `proj:view:{projectId}` | Открыть карточку проекта. |
| `proj:chat:{projectId}` | Информация о Telegram-группе проекта. |
| `proj:leads:{projectId}` | Последние лиды проекта. |
| `proj:report:{projectId}` | Быстрый переход в отчёты по проекту. |
| `proj:campaigns:{projectId}` | Просмотр рекламных кампаний Meta. |
| `proj:export:{projectId}` | Экспорт данных проекта. |
| `proj:portal:{projectId}` | Ссылка на клиентский портал. |
| `proj:billing:{projectId}` | Статус оплаты и платежей. |
| `proj:billing-status:{projectId}:{status}` | Установить статус биллинга (`active`, `pending`, `overdue`, `blocked`). |
| `proj:billing-next:{projectId}:{preset}` | Обновить дату следующего платежа (`7`, `14`, `30`, `clear`, `custom`). |
| `proj:billing-tariff:{projectId}` | Запросить обновление тарифа проекта. |
| `proj:settings:{projectId}` | Настройки проекта. |
| `proj:delete:{projectId}` | Запрос удаления проекта. |
| `proj:lead-toggle:{projectId}:{leadId}` | Переключить статус лида между «новый» и «обработан». |

## Meta-аккаунты (`meta:*`)

| Callback шаблон | Описание |
| --- | --- |
| `meta:account:{metaAccountId}` | Выбор рекламного аккаунта Meta в мастере привязки. |
| `meta:group:{chatId}` | Выбор Telegram-группы для привязки Meta-аккаунта. |
| `meta:confirm` | Подтверждение создания проекта и привязки. |
| `meta:cancel` | Отмена текущего мастера привязки. |
| `meta:project:{projectId}` | Переход к карточке проекта, связанного с Meta-аккаунтом. |

## Пользователи (`user:*`)

| Callback шаблон | Описание |
| --- | --- |
| `user:add` | Запустить мастер добавления пользователя. |
| `user:view:{userId}` | Открыть карточку пользователя. |
| `user:role:{userId}:{role}` | Назначить роль (`owner`, `manager`, `client`). |
| `user:create-role:{role}` | Выбрать роль на шаге создания нового пользователя. |
| `user:delete:{userId}` | Запросить подтверждение удаления пользователя. |
| `user:delete-confirm:{userId}` | Подтвердить удаление пользователя. |
| `user:cancel` | Отменить текущий сценарий в разделе пользователей. |

## Аналитика (`analytics:*`)

| Callback шаблон | Описание |
| --- | --- |
| `analytics:projects` | Показать разбивку лидов по проектам. |
| `analytics:export` | Запустить мастер экспорта отчёта из раздела аналитики. |
| `analytics:export:summary` | Сформировать сводный отчёт (HTML). |
| `analytics:export:auto` | Запустить расширенный автоотчёт (детальный). |
| `analytics:export:finance` | Сформировать финансовый отчёт по оплатам. |
| `analytics:export:sla` | Сформировать SLA-экспорт и выгрузить CSV. |

## Отчёты (`report:*`)

| Callback шаблон | Описание |
| --- | --- |
| `report:toggle:{sessionId}:{projectId}` | Включить/выключить проект в отчёте. |
| `report:select:{sessionId}:all` | Выбрать все проекты. |
| `report:select:{sessionId}:none` | Очистить выбор проектов. |
| `report:confirm:{sessionId}` | Сформировать отчёт и отправить сводку. |
| `report:cancel:{sessionId}` | Отменить сессию отчёта и закрыть меню. |

## Общие правила

- Первичный токен до первого двоеточия определяет пространство команд (`cmd`, `proj`, `meta`, `report`).
- Идентификаторы (`{projectId}`, `{metaAccountId}`, `{chatId}`) передаются в виде строк без дополнительных разделителей.
- Любые новые сценарии обязаны следовать этой схеме, чтобы избежать конфликтов и обеспечить обратную совместимость.

## История изменений

- 2025-02-14 — напоминания по лидам и оплатам используют существующие кнопки `proj:leads:{projectId}` и `proj:billing:{projectId}`; новых пространств не добавлялось.
- 2025-02-15 — раздел аналитики получил вложенные действия `analytics:export:*` для выбора типа экспорта (сводка, автоотчёт, финансы, SLA), добавлен мастер расписаний отчётов.
- 2025-02-13 — интеграция Meta leadgen вебхуков, уведомления используют существующий `proj:leads:{projectId}` без изменения схемы.
- 2025-02-12 — подтверждена структура колбеков после внедрения KV-реплики Telegram-групп; новые сценарии не добавлялись.
