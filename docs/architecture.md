# Архитектура TargetBot

```
┌──────────────┐      Telegram Updates      ┌──────────────┐      Insights / OAuth      ┌────────────┐
│  Telegram    │ ─────────────────────────▶ │ Cloudflare   │ ─────────────────────────▶ │ Facebook   │
│  Users/Chats │                            │ Worker       │                            │ Graph API  │
└──────────────┘ ◀────────────────────────── │  (TargetBot) │ ◀──────────────────────────└────────────┘
                           Notifications     │              │       OAuth callback             ▲
                                             │              │                                 │
                                             │              │                                 │
                                             ▼              │                                 │
                                   ┌────────────────┐       │                                 │
                                   │ KV Storage     │◀──────┘                                 │
                                   │ (Users, Leads, │                                         │
                                   │  Tokens, Logs) │                                         │
                                   └────────────────┘                                         │
                                             │                                                 │
                                             ▼                                                 │
                                   ┌────────────────┐       Admin UI / REST API                │
                                   │ R2 Reports     │ ◀────────────────────────────────────────┘
                                   │ (CSV/PDF)      │
                                   └────────────────┘
```

## Основные компоненты

- **Cloudflare Worker** — единая точка входа для Telegram webhook, REST API, админ-панели и OAuth Meta.
- **KV** — хранение пользователей, лидов, токенов Meta, логов интеграций.
- **R2** — CSV-отчёты и выгрузки по кампаниям.
- **Telegram Bot** — команды для создания заявок, запросов отчётов и проверки статуса интеграций.
- **Admin Portal** — SPA на Tailwind (через CDN), доступная по `/admin?key=!Lyas123`.
- **Meta Integration** — OAuth (`/auth/facebook`), синхронизация кампаний (`/meta/sync`), статистика (`/meta/stats`).
- **Portal Key Manager** — валидация запросов через `X-Auth-Key`, хранение ключей в `KV_META`, управление ключами из админки.

## Потоки данных

1. **Регистрация пользователя** — Telegram webhook записывает пользователя в `KV_USERS`, создаёт UUID-токен и отправляет приветственное сообщение.
2. **Создание лида** — команда `/lead` записывает заявку в `KV_LEADS`, логирует событие и делает запись в админку.
3. **Синхронизация Meta** — админ-панель вызывает `/meta/sync`, воркер получает кампании через Graph API и сохраняет снимок в `KV_META`.
4. **API ключи** — админ-панель создаёт ключи через `/api/settings`, ключи используются интеграциями в заголовке `X-Auth-Key`; каждое использование логируется в `KV_META`.
5. **Отчёты** — `/api/reports` добавляет CSV в `R2_REPORTS`, `/report` в Telegram выводит список актуальных выгрузок.
6. **Админ-панель** — фронтенд забирает данные с `/api/dashboard`, `/api/leads`, `/api/users`, `/api/settings` и обновляет метрики в реальном времени.
