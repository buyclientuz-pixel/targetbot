# TargetBot Cloudflare Refactor Plan

Эта дорожная карта описывает 10 итераций полного перехода TargetBot на новую архитектуру Cloudflare Worker с KV и R2, описанную в актуальном ТЗ. По итогам выполнения основной программы добавлена итерация 11 для операционной документации и деплой-гайдов.

## Итерация 1 — Аудит и планирование
- Проанализировать текущий репозиторий и спецификацию.
- Зафиксировать цели и артефакты перехода в публичной документации (README, docs).
- Согласовать структуру KV/R2, общие роуты Worker и новые домены ответственности модулей.

## Итерация 2 — Базовая инфраструктура Worker
- Подготовить единый entrypoint Worker (Telegram, Meta, REST, статика).
- Настроить обвязку KV/R2 (workers.d.ts, клиенты, вспомогательные функции).
- Добавить healthcheck и smoke-роуты.

## Итерация 3 — Модель данных и хранилища
- Реализовать CRUD для project, project-settings, users, portal-session.
- Настроить R2-bucket для leads, payments, campaign-stats, logs.
- Подготовить миграционные helper’ы и индексы.
- Документировать доменную схему (`docs/data-model.md`).

## Итерация 4 — Meta API + кэширование ✅
- Реализовать прокси-роуты `/api/meta/projects/:id/summary` и `/api/meta/projects/:id/campaigns` с обращением к Graph API.
- Добавить KV-кеш `meta-cache:{projectId}:{scope}` для insights/summary/campaigns (TTL 60 секунд).
- Поддержать CRUD `meta-token:{fbUserId}` и endpoint `PUT /api/meta/tokens/:facebookUserId` для хранения токенов.

## Итерация 5 — Webhook Meta → лиды в R2 ✅
- Создать endpoint /api/meta/webhook.
- Импортировать лиды в leads/{projectId}/{leadId}.json.
- Настроить отправку уведомлений в Telegram согласно project-settings.alerts.

## Итерация 6 — Telegram-бот
- ✅ Статус: реализовано. Новое webhook-ядро обрабатывает меню, карточки проектов и биллинг.
- Переписать меню: проекты, аналитика, финансы, настройки.
- Реализовать карточку проекта с показателями today/total.
- Обновить биллинг: тарифы, ручной ввод даты, генерация payments/*.

## Итерация 7 — Клиентский портал
- ✅ Статус: реализовано. `/portal/{projectId}` с прелоадером, таймаутом 9 сек, табами показателей и таблицами лидов/кампаний/оплат.
- HTML/JS-роутер на Worker, локальные скелетоны секций, обработка повторных запросов.
- API `/api/projects/:id/{summary,leads,campaigns,payments}` возвращают нормализованные данные портала.

## Итерация 8 — Автоотчёты и алерты
- ✅ Реализованы cron-триггеры Workers, автоотчёты по таймслотам и маршруты отправки (CHAT/ADMIN/BOTH/NONE).
- ✅ Добавлены состояния `report-state:*` и `alert-state:*` для дедупликации уведомлений и контроля слотов.
- ✅ Автоматическое создание темы «Таргет» и кеш статусов кампаний для budget/pause алертов.

## Итерация 9 — Очистка и миграции ✅
- ✅ Запланированное обслуживание запускается из `scheduled`-ивента: удаляет лиды старше порога retention (по умолчанию 14 дней, конфигурируется через `config:lead-retention-days`).
- ✅ Meta-кеши старше retention (по умолчанию 3 дня) удаляются через `config:meta-cache-retention-days`.
- ✅ При ревизии очищены остатки легаси-обработчиков лидов (R2 deletion fallback) и добавлен модуль `services/maintenance` для централизованного обслуживания.

## Итерация 10 — Тесты и документация ✅
- ✅ Unit: парсинг вебхука Meta, формат карточки проекта, парсинг дат (node:test + кастомный TS loader).
- ✅ Integration: лид → R2 → Telegram с моками Telegram API, проверка KV/R2.
- ✅ Portal e2e: эмуляция HTML-скрипта, скрытие прелоадера, обработка таймаута.
- ✅ README обновлён с финальным статусом и инструкцией запуска тестов.

## Итерация 11 — Операционные гайды ✅
- ✅ Подготовлен подробный деплой-гайд: настройка Wrangler, KV, R2, секретов Meta/Telegram.
- ✅ Зафиксирована процедура релизов и откатов.
- ✅ Описаны мониторинг, алерты и SLA для автоотчётов.

## Итерация 12 — Dry-run деплоя ✅
- ✅ Создан скрипт `npm run dry-run`, который запускает линт, typecheck, тесты и `wrangler deploy --dry-run`.
- ✅ Подготовлен чеклист `docs/dry-run-checklist.md` с требованиями к окружению и логированию прогонов.
- ✅ Зафиксировано требование обновлять README и runbook по результатам dry-run.

