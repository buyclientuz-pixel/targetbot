# TargetBot Cloudflare Refactor Plan

Эта дорожная карта описывает 10 итераций полного перехода TargetBot на новую архитектуру Cloudflare Worker с KV и R2, описанную в актуальном ТЗ.

## Итерация 1 — Аудит и планирование
- Проанализировать текущий репозиторий и спецификацию.
- Зафиксировать цели и артефакты перехода в публичной документации (README, docs).
- Согласовать структуру KV/R2, общие роуты Worker и новые домены ответственности модулей.

## Итерация 2 — Базовая инфраструктура Worker
- Подготовить единый entrypoint Worker (Telegram, Meta, REST, статика).
- Настроить обвязку KV/R2 (workers.d.ts, клиенты, вспомогательные функции).
- Добавить healthcheck и smoke-роуты.

## Итерация 3 — Модель данных и хранилища
- Реализовать CRUD для project, project-settings, users, portal-session.
- Настроить R2-bucket для leads, payments, campaign-stats, logs.
- Подготовить миграционные helper’ы и индексы.
- Документировать доменную схему (`docs/data-model.md`).

## Итерация 4 — Meta API + кэширование ✅
- Реализовать прокси-роуты `/api/meta/projects/:id/summary` и `/api/meta/projects/:id/campaigns` с обращением к Graph API.
- Добавить KV-кеш `meta-cache:{projectId}:{scope}` для insights/summary/campaigns (TTL 60 секунд).
- Поддержать CRUD `meta-token:{fbUserId}` и endpoint `PUT /api/meta/tokens/:facebookUserId` для хранения токенов.

## Итерация 5 — Webhook Meta → лиды в R2
- Создать endpoint /api/meta/webhook.
- Импортировать лиды в leads/{projectId}/{leadId}.json.
- Настроить отправку уведомлений в Telegram согласно project-settings.alerts.

## Итерация 6 — Telegram-бот
- Переписать меню: проекты, аналитика, финансы, настройки.
- Реализовать карточку проекта с показателями today/total.
- Обновить биллинг: тарифы, ручной ввод даты, генерация payments/*.

## Итерация 7 — Клиентский портал
- Обновить /portal/{projectId}: прелоадер, секционная загрузка, ошибки.
- Добавить вкладки «Ключевые показатели», «Лиды», «Кампании», «Оплаты».
- Подключить новые API: summary, leads, campaigns, payments.

## Итерация 8 — Автоотчёты и алерты
- Реализовать cron-триггеры, маршруты отправки (CHAT/ADMIN/BOTH/NONE).
- Ввести lastAlertAt и дедупликацию уведомлений.
- Обновить построение тем «Таргет» и кеш чатов.

## Итерация 9 — Очистка и миграции
- Добавить еженедельное удаление старых лидов из R2.
- Чистить meta-cache старше 72 часов.
- Удалить устаревшие обработчики и дублирующиеся сценарии.

## Итерация 10 — Тесты и документация
- Unit: парсинг вебхука Meta, формат карточки проекта, парсинг дат.
- Integration: лид → R2 → Telegram, оплата → R2/KV → портал.
- Portal e2e: загрузка, скрытие прелоадера, обработка таймаута.
- Обновить README (деплой, миграции, регрессии).

