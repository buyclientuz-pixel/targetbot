# Постдеплойная проверка Targetbot

Чек-лист помогает убедиться, что воркер, Telegram-бот и портал работают после выката. Выполняется вручную и фиксируется в README (раздел Progress) или в отдельном issue.

## 1. Подготовка

| Шаг | Статус | Комментарий |
| --- | --- | --- |
| Определён базовый URL воркера (`https://<worker>.workers.dev` или кастомный домен) |  |  |
| Уточнены переменные `BOT_TOKEN`, `FB_APP_ID`, `FB_APP_SECRET` |  |  |
| Известен ID тестового проекта и чат-группы |  |  |

## 2. Быстрые команды

```bash
curl -i https://<worker>/health
curl -i https://<worker>/api/meta/status
curl -i https://<worker>/api/meta/adaccounts
curl -i https://<worker>/api/projects
curl -i https://<worker>/api/users
```

Ожидается `HTTP 200` и `ok: true` в JSON-ответах (кроме списка пользователей/проектов, где может быть пустой массив).

## 3. Лиды

1. Отправьте тестовый лид:
   ```bash
   curl -X POST https://<worker>/api/leads \
     -H 'content-type: application/json' \
     -d '{"projectId":"<id>","name":"Postdeploy","phone":"+70000000000"}'
   ```
2. Проверьте, что в чат-группе появилось уведомление.
3. Откройте `/portal/<projectId>` — запись должна появиться в таблице лидов.
4. Нажмите кнопку ✔, убедитесь, что статус изменился на `done` без перезагрузки страницы (запрос PATCH `/api/leads/<leadId>`).

## 4. Проекты и пользователи

1. `/admin` должен отображать список проектов и статус Meta.
2. `/admin/users` должен показывать таблицу пользователей.
3. Выполните PATCH `/api/projects/<id>` (например, обновите `telegramLink`) и убедитесь, что изменения видны в админке.
4. Создайте временного пользователя через POST `/api/users`, затем удалите его — убедитесь, что данные синхронизируются.

## 5. Meta OAuth

1. Если токен близок к истечению, выполните `/api/meta/refresh` и убедитесь, что статус обновился.
2. При необходимости повторите OAuth-флоу (`/api/meta/oauth/start` → авторизация → `/auth/facebook/callback`, алиас `/api/meta/oauth/callback`).
3. Убедитесь, что `/api/meta/adaccounts` возвращает список без ошибок `Graph API error`.

## 6. Логи и алерты

| Проверка | Статус | Комментарий |
| --- | --- | --- |
| Cloudflare Workers → Logs — нет ошибок 5xx за последние 10 минут |  |  |
| При ошибке Telegram (если была) записан текст ответа API |  |  |
| KV/R2 доступны: объекты `projects/index.json` и `leads/<projectId>.json` читаются |  |  |

## 7. Финализация

- Обновите README (раздел Progress) с кратким описанием проверки.
- При найденных проблемах создайте задачи и приложите логи/скриншоты.
- Сохраните копию заполненного чек-листа в общем пространстве команды.

При повторных деплоях используйте этот же шаблон, чтобы фиксировать результат и замечания.
