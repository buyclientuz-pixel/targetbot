# Targetbot — этап 6: управление расписанием

Проект «CI → GitHub → Cloudflare Workers → Telegram-бот отчётов по рекламе Meta» развивается поэтапно. После каркаса,
регистрации чатов и мастера создания проектов добавлено полноценное управление карточкой клиента: статусы, расписание и период
автоотчётов теперь настраиваются прямо из Telegram.

> **Примечание.** Вся актуальная работа перенесена из временной ветки `work` в основную ветку `main`. Теперь именно `main`
содержит свежие исходники, и её следует использовать для дальнейшей разработки и автодеплоя.

## Что уже сделано
- Воркер (`src/index.js`) обрабатывает маршруты `/health`, `/`, `/tg`, `/fb_auth`, `/fb_cb`, `/fb_debug`, `/p/{code}`.
- Реализованы заглушки OAuth Meta и клиентского портала, а также проверка обязательных переменных окружения.
- В `/tg` доступны команды `/start`, `/help`, `/register`, `/admin`, `/report`, `/digest`:
  - `/start` и `/help` возвращают краткую справку.
  - `/register`, вызванный внутри нужного топика, сохраняет `chat_id` и `message_thread_id` в KV (`DB`) и подтверждает привязку.
  - `/admin` выводит панель с кнопками подключения Meta, списком чатов и разделом «Проекты» (read-only список).
  - `/report` и `/digest` отвечают заглушками, показывая, какие функции будут реализованы на следующих этапах.
- Инлайн-кнопки панели обрабатываются без зависаний: чаты и проекты подгружаются из KV с пагинацией, остальные действия пока
  сообщают о незавершённой реализации.
- Каркас данных проекта (`project:<code>`) и временных состояний (`state:<uid>`) нормализуется вспомогательными функциями.
- Добавлен мастер создания проекта: в админ-панели появилась кнопка «➕ Новый проект». Мастер по шагам просит указать код,
  выбрать чат/топик из зарегистрированных и ввести `act_` рекламного аккаунта. После завершения проект сохраняется в KV и
  отображается в списке «Проекты».
- Мастер защищён от распространённых ошибок: проверяется формат кода, дубли, отсутствие зарегистрированных чатов, корректность
  рекламного аккаунта. Любой шаг можно отменить кнопкой «Отмена».
- Список проектов получил кнопки «⚙️ код», открывающие карточку выбранного проекта. Карточка показывает аккаунт, чат,
  расписание, KPI, статусы сводника, автопаузы и алертов, а также даты оплат.
- Из карточки можно управлять состоянием проекта: включать/выключать автоотчёты, ставить биллинг на паузу, переключать сводник и
  автопаузу по KPI, а также запускать редактор расписания.
- Редактор расписания поддерживает добавление и удаление времён, быстрые кнопки популярных слотов, ввод произвольного времени,
  переключение периодов отчёта и тихих выходных. Все изменения сохраняются в KV и сразу отражаются в интерфейсе.
- Вызовы Telegram API обёрнуты в `fetchWithTimeout`, чтобы воркер не зависал при сетевых проблемах.
- В конфигурации Wrangler (`wrangler.toml`) зафиксирована рабочая привязка `DB` (боевой namespace `c55f82210ade457c93aff4fe2ba8b007`),
  настроен крон каждые 5 минут (для будущих задач) и включено подробное логирование в разделе Observability.
- Сценарии npm (`npm run dev`, `npm run deploy`) используют `npx wrangler@4.46.0`, поэтому дополнительных зависимостей
  устанавливать не требуется. GitHub Actions workflow выполняет автодеплой из ветки `main`.

## Что сделать дальше
1. При необходимости завести отдельные KV (`REPORTS_NAMESPACE`, `BILLING_NAMESPACE`, `LOGS_NAMESPACE`) и добавить их в `wrangler.toml`.
   Сейчас используется единый namespace `DB` (ID `c55f82210ade457c93aff4fe2ba8b007`), чего достаточно для текущего этапа.
2. Настроить переменные окружения в Cloudflare: `BOT_TOKEN`, `ADMIN_IDS`, `FB_APP_ID`, `FB_APP_SECRET`, `DEFAULT_TZ`, `WORKER_URL`,
   `FB_LONG_TOKEN` (опц.), `GS_WEBHOOK` (опц.).
3. Расширить мастер проекта: добавить выбор расписания, периодов, KPI и статуса биллинга сразу при создании, а также редактор
   KPI/alerts/оплат внутри карточки.
4. Реализовать Meta OAuth в `/fb_cb`: обмен кода на токены, загрузка ад-аккаунтов, сохранение в KV и отображение в админке.
5. Дописать команды `/report` и `/digest`, автоматические автоотчёты, алерты и архив (`report:<code>:<ts>`).
6. Сделать клиентский портал `/p/{code}?sig=...` с HTML-дашбордом и выдачей ссылок из админки.
7. По мере внедрения функциональности обновлять README подробными инструкциями по эксплуатации.

## Быстрый старт
```bash
# локальный предпросмотр (нужны ENV и preview KV ID)
npm run dev

# после настройки секретов деплой вызывается той же командой
npm run deploy
```

Продолжайте развивать функциональность по шагам, проверяя каждое изменение локально и через деплой.
