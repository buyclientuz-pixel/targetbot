# Targetbot — этап 2: навигация админ-панели

Проект «CI → GitHub → Cloudflare Workers → Telegram-бот отчётов по рекламе Meta» перезапущен с чистого листа.
На втором этапе мы развиваем минимальный каркас: добавляем интерактивную админ-панель, наводим порядок в
диагностике и готовим основу под Meta OAuth, проекты и отчёты.

## Что уже готово
- **HTTP-маршруты:** воркер отвечает на `GET /`, `GET /health`, `POST /tg`, а остальные URL (`/fb_auth`, `/fb_cb`, `/fb_debug`,
  `/p/{code}`) пока возвращают stub-страницы с кодом 501, фиксируя дорожную карту.
- **Парсинг окружения:** токен Telegram ищется в алиасах (`BOT_TOKEN`, `TG_API_TOKEN`, `TELEGRAM_BOT_TOKEN` и т.д.), список
  администраторов берётся из `ADMIN_IDS` или по умолчанию `7623982602, 573424022`.
- **KV-абстракция:** объявлен базовый хелпер для работы с Cloudflare KV, реестр чатов сохраняется по ключу `chat:<chat_id>:<thread_id>`,
  а логи Telegram-обновлений пишутся в `LOGS_NAMESPACE` (fallback на `DB`).
- **Обработчик Telegram:** поддерживаются команды `/start`, `/help`, `/register`, `/admin`, `/pingtest`. Командный реестр
  расширяется функциями — интерактивная админ-панель строится на inline-кнопках и коллбэках.
- **Админ-панель:** команда `/admin` открывает меню с разделами «Главное», «Чаты», «Проекты», «Диагностика».
  - «Главное» показывает числовые сводки (чаты, проекты, подключения Meta OAuth, таймзона, Worker URL).
  - «Чаты» перечисляет зарегистрированные топики (до 10 элементов) и подсказывает, как добавить новые.
  - «Проекты» выводит краткий список и шаблон структуры проекта (`project:<code>` в KV).
  - «Диагностика» показывает статус токена, количество админов и текущий webhook (`getWebhookInfo`).
- **Диагностика `/health`:** возвращает наличие токена, список админов и (по флагу `?ping=telegram`) данные `getWebhookInfo`.
  Параметр `telegram_logs=1` прикладывает последние события вебхука.
- **Проверка связки:** команда `/pingtest` отправляет десять сообщений подряд через `waitUntil` — так проще убедиться, что Cloudflare
  принимает вебхук и Telegram получает ответы.
- **CI → секреты → Cloudflare:** GitHub Actions перед деплоем автоматически синхронизирует секреты из настроек репозитория в Secrets
  воркера, поэтому однажды заданные значения (`BOT_TOKEN`, `ADMIN_IDS`, `FB_APP_*` и др.) переезжают в Cloudflare без ручных действий.

## Что предстоит сделать дальше
1. Реализовать Meta OAuth (`/fb_auth`, `/fb_cb`, `/fb_debug`) и хранение long-lived токена в KV.
2. Построить мастер проектов и полноценную карточку `/admin`, подключить расписания отчётов и алерты.
3. Добавить генерацию отчётов, CSV и клиентский портал `/p/{code}`.
4. Дополнить GitHub Actions автоматизацией деплоя (workflow уже создан — останется задействовать при расширении функционала).

## Требуемые переменные окружения
| Переменная            | Назначение                              | Обязательна | Значение по умолчанию |
|-----------------------|------------------------------------------|-------------|------------------------|
| `BOT_TOKEN` / алиасы  | Токен Telegram-бота                      | да          | —                      |
| `ADMIN_IDS`           | Список администраторов через запятую     | частично    | `7623982602,573424022` |
| `DEFAULT_TZ`          | Таймзона по умолчанию (например, `Asia/Tashkent`) | рекомендуется | — |
| `WORKER_URL`          | Публичный URL воркера (для диагностики) | рекомендуется | — |
| `FB_APP_ID`           | Идентификатор Meta приложения            | планируется | — |
| `FB_APP_SECRET`       | Секрет Meta приложения                   | планируется | — |
| `GS_WEBHOOK`          | Вебхук Google Apps Script (опционально)  | опционально | — |

> Секреты никогда не коммитятся в git. Используйте `wrangler secret put`, `.dev.vars`/`.env` в локальной разработке или GitHub Actions secrets.

## Как добавить ключи и токены

### Локальная разработка
1. Скопируйте шаблон `.dev.vars.example` в `.dev.vars` (Cloudflare читает его в режиме `wrangler dev`).
2. Пропишите строки в формате `KEY="value"`. Минимальный набор уже показан в шаблоне, но для удобства приведён ниже:
   ```env
   BOT_TOKEN="<токен_бота_из_@BotFather>"
   ADMIN_IDS="7623982602,573424022"
   DEFAULT_TZ="Asia/Tashkent"
   ```
3. Для запуска через Node.js или других инструментов можно задать те же значения в `.env`.

> `.dev.vars` и `.env` не коммитятся в репозиторий — убедитесь, что файлы перечислены в `.gitignore` (уже настроено).

### GitHub Actions → Cloudflare
1. В репозитории GitHub откройте **Settings → Secrets and variables → Actions** и задайте секреты: `BOT_TOKEN`, `ADMIN_IDS`,
   `DEFAULT_TZ`, `WORKER_URL`, `FB_APP_ID`, `FB_APP_SECRET`, `FB_LONG_TOKEN`, `GS_WEBHOOK` (по необходимости).
2. При следующем деплое workflow автоматически выполнит `wrangler secret put <KEY>` для каждого из заполненных значений и перенесёт их
   в ваш воркер Cloudflare (environment `production`).
3. После успешного шага «Sync Worker secrets from GitHub Actions» в журнале появятся сообщения `Synced secret <KEY>` для каждого ключа.

### Продуктивный воркер в Cloudflare вручную
1. Выполните `npx wrangler secret put BOT_TOKEN` и вставьте токен из @BotFather.
2. Аналогично можно добавить `ADMIN_IDS`, `DEFAULT_TZ` и другие приватные значения (`wrangler secret put <KEY>`).
3. Либо откройте Cloudflare Dashboard → Workers & Pages → нужный воркер → **Settings** → **Variables** → **Add variable/secret**.
4. После обновления секретов перезапустите деплой: `npm run deploy` или GitHub Actions.

### Проверка
1. Запустите `npm run check:config -- --ping-telegram` — скрипт найдёт токен и проверит `getMe`.
2. В браузере откройте `/health?ping=telegram` — убедитесь, что воркер видит токен и текущий webhook.
3. Отправьте в Telegram `/admin` и переключите разделы — меню обновляется через inline-кнопки.
4. Отправьте `/pingtest` — бот вернёт 10 сообщений, подтверждая доставку.

## Быстрый старт
```bash
# Установить зависимости (на проде используется npx, но локально можно сделать install)
npm install

# Проверить конфигурацию окружения (скрипт будет развиваться на следующих этапах)
npm run check:config

# Запустить dev-сервер Cloudflare Workers
npm run dev

# Деплой через Wrangler (использует wrangler.toml)
npm run deploy
```

## Проверка после деплоя
1. `GET https://<worker>/health` — убеждаемся, что `ok: true` и перечислены администраторы.
2. `GET https://<worker>/health?ping=telegram&telegram_logs=1` — видим `getWebhookInfo` и свежие события вебхука.
3. В Telegram отправляем `/start`, `/help`, `/register`, `/admin`, `/pingtest` и проверяем корректные ответы.
4. `/pingtest` должен прислать десять сообщений за десять секунд (разрешает проверить Cloudflare ↔ Telegram).

Документация будет расширяться по мере роста функциональности.
