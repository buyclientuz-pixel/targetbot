# Targetbot — этап 1: базовый каркас воркера

Проект «CI → GitHub → Cloudflare Workers → Telegram-бот отчётов по рекламе Meta» перезапущен с чистого листа.
На первом этапе мы собираем минимально работоспособный каркас, чтобы проверить связку Git → Cloudflare → Telegram
и подготовить почву для последующих модулей (OAuth Meta, админ-панель, отчёты, алерты, клиентский портал).

## Что уже готово
- **HTTP-маршруты:** воркер отвечает на `GET /`, `GET /health`, `POST /tg`, а остальные URL (`/fb_auth`, `/fb_cb`, `/fb_debug`,
  `/p/{code}`) пока возвращают stub-страницы с кодом 501.
- **Парсинг окружения:** токен Telegram ищется в алиасах (`BOT_TOKEN`, `TG_API_TOKEN`, `TELEGRAM_BOT_TOKEN` и т.д.), список
  администраторов берётся из `ADMIN_IDS` или по умолчанию `7623982602, 573424022`.
- **KV-абстракция:** объявлен базовый хелпер для работы с Cloudflare KV, реестр чатов сохраняется по ключу `chat:<chat_id>:<thread_id>`,
  а логи Telegram-обновлений пишутся в `LOGS_NAMESPACE` (fallback на `DB`).
- **Обработчик Telegram:** поддерживаются команды `/start`, `/help`, `/register`, `/admin`, `/pingtest`. Командный реестр расширяется
  функциями, поэтому следующий этап легко добавит отчёты, дайджесты и алерты.
- **Диагностика `/health`:** возвращает наличие токена, список админов и (по флагу `?ping=telegram`) данные `getWebhookInfo`.
  Параметр `telegram_logs=1` прикладывает последние события вебхука.
- **Проверка связки:** команда `/pingtest` отправляет десять сообщений подряд через `waitUntil` — так проще убедиться, что Cloudflare
  принимает вебхук и Telegram получает ответы.

## Что предстоит сделать дальше
1. Реализовать Meta OAuth (`/fb_auth`, `/fb_cb`, `/fb_debug`) и хранение long-lived токена в KV.
2. Построить мастер проектов и карточку `/admin`, подключить расписания отчётов и алерты.
3. Добавить генерацию отчётов, CSV и клиентский портал `/p/{code}`.
4. Настроить GitHub Actions для автодеплоя и продолжить обогащать документацию по эксплуатации.

## Требуемые переменные окружения
| Переменная            | Назначение                              | Обязательна | Значение по умолчанию |
|-----------------------|------------------------------------------|-------------|------------------------|
| `BOT_TOKEN` / алиасы  | Токен Telegram-бота                      | да          | —                      |
| `ADMIN_IDS`           | Список администраторов через запятую     | частично    | `7623982602,573424022` |
| `DEFAULT_TZ`          | Таймзона по умолчанию (например, `Asia/Tashkent`) | рекомендуется | — |
| `WORKER_URL`          | Публичный URL воркера (для диагностики) | рекомендуется | — |
| `FB_APP_ID`           | Идентификатор Meta приложения            | планируется | — |
| `FB_APP_SECRET`       | Секрет Meta приложения                   | планируется | — |
| `GS_WEBHOOK`          | Вебхук Google Apps Script (опционально)  | опционально | — |

> Секреты никогда не коммитятся в git. Используйте `wrangler secret put` или `.dev.vars`/`.env` в локальной разработке.

## Быстрый старт
```bash
# Установить зависимости (на проде используется npx, но локально можно сделать install)
npm install

# Проверить конфигурацию окружения (скрипт будет упрощён на следующих этапах)
npm run check:config

# Запустить dev-сервер Cloudflare Workers
npm run dev

# Деплой через Wrangler (использует wrangler.toml)
npm run deploy
```

## Проверка после деплоя
1. `GET https://<worker>/health` — убеждаемся, что `ok: true` и перечислены администраторы.
2. `GET https://<worker>/health?ping=telegram&telegram_logs=1` — видим `getWebhookInfo` и свежие события вебхука.
3. В Telegram отправляем `/start`, `/help`, `/register`, `/admin`, `/pingtest` и проверяем корректные ответы.
4. `/pingtest` должен прислать десять сообщений за десять секунд (разрешает проверить Cloudflare ↔ Telegram).

Документация будет расширяться по мере роста функциональности.
