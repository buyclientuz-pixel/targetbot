# Targetbot — этап 3: каталог проектов и управление админкой

Проект «CI → GitHub → Cloudflare Workers → Telegram-бот отчётов по рекламе Meta» развивается поэтапно. После каркаса и базовой
логики Telegram добавлен раздел «Проекты» в админ-панели и вспомогательные функции для будущего мастера настройки.

> **Примечание.** Вся актуальная работа перенесена из временной ветки `work` в основную ветку `main`. Теперь именно `main`
содержит свежие исходники, и её следует использовать для дальнейшей разработки и автодеплоя.

## Что уже сделано
- Воркер (`src/index.js`) обрабатывает маршруты `/health`, `/`, `/tg`, `/fb_auth`, `/fb_cb`, `/fb_debug`, `/p/{code}`.
- Реализованы заглушки OAuth Meta и клиентского портала, а также проверка обязательных переменных окружения.
- В `/tg` доступны команды `/start`, `/help`, `/register`, `/admin`, `/report`, `/digest`:
  - `/start` и `/help` возвращают краткую справку.
  - `/register`, вызванный внутри нужного топика, сохраняет `chat_id` и `message_thread_id` в KV (`DB`) и подтверждает привязку.
  - `/admin` выводит панель с кнопками подключения Meta, списком чатов и новым разделом «Проекты» (пока read-only список).
  - `/report` и `/digest` отвечают заглушками, показывая, какие функции будут реализованы на следующих этапах.
- Инлайн-кнопки панели обрабатываются без зависаний: чаты и проекты подгружаются из KV с пагинацией, остальные действия пока
  сообщают о незавершённой реализации.
- Каркас данных проекта (`project:<code>`) и временных состояний (`state:<uid>`) нормализуется вспомогательными функциями — это
  подготовка к мастеру настройки проекта и управлению отчётами.
- Вызовы Telegram API обёрнуты в `fetchWithTimeout`, чтобы воркер не зависал при сетевых проблемах.
- В конфигурации Wrangler (`wrangler.toml`) указаны требуемые KV-привязки, крон каждые 5 минут (для будущих задач) и настроена
  подробная Observability (логирование Cloudflare).
- Сценарии npm (`npm run dev`, `npm run deploy`) используют `npx wrangler@4.46.0`, поэтому дополнительных зависимостей
  устанавливать не требуется. GitHub Actions workflow выполняет автодеплой из ветки `main`.

## Что сделать дальше
1. Заполнить реальные Namespace ID в `wrangler.toml` для `REPORTS_NAMESPACE`, `BILLING_NAMESPACE`, `LOGS_NAMESPACE`. Привязка `DB`
   уже настроена на боевой namespace (`c55f82210ade457c93aff4fe2ba8b007`).
2. Настроить переменные окружения в Cloudflare: `BOT_TOKEN`, `ADMIN_IDS`, `FB_APP_ID`, `FB_APP_SECRET`, `DEFAULT_TZ`, `WORKER_URL`,
   `FB_LONG_TOKEN` (опц.), `GS_WEBHOOK` (опц.).
3. Реализовать мастер создания/редактирования проектов в админке: выбор аккаунта, чата, периода, расписания, сохранение в
   `project:<code>` с использованием `state:<uid>`.
4. Реализовать Meta OAuth в `/fb_cb`: обмен кода на токены, загрузка ад-аккаунтов, сохранение в KV и отображение в админке.
5. Дописать команды `/report` и `/digest`, автоматические автоотчёты, алерты и архив (`report:<code>:<ts>`).
6. Сделать клиентский портал `/p/{code}?sig=...` с HTML-дашбордом и выдачей ссылок из админки.
7. По мере внедрения функциональности обновлять README подробными инструкциями по эксплуатации.

## Быстрый старт
```bash
# локальный предпросмотр (нужны ENV и preview KV ID)
npm run dev

# после настройки секретов деплой вызывается той же командой
npm run deploy
```

Продолжайте развивать функциональность по шагам, проверяя каждое изменение локально и через деплой.
