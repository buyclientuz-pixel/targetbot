# Targetbot — этап 2: базовый Telegram-обработчик

Проект «CI → GitHub → Cloudflare Workers → Telegram-бот отчётов по рекламе Meta» пересобирается по этапам. После первоначального каркаса добавлена первая рабочая логика вебхука Telegram и сохранение данных топиков в KV.

> **Примечание.** Вся актуальная работа перенесена из временной ветки `work` в основную ветку `main`. Теперь именно `main` содержит свежие исходники, и её следует использовать для дальнейшей разработки и автодеплоя.

## Что уже сделано
- Воркер (`src/index.js`) обрабатывает маршруты `/health`, `/`, `/tg`, `/fb_auth`, `/fb_cb`, `/fb_debug`, `/p/{code}`.
- Реализованы заглушки OAuth Meta и клиентского портала, а также проверка обязательных переменных окружения.
- В `/tg` добавлены команды `/start`, `/help`, `/register`, `/admin`:
  - `/start` и `/help` возвращают краткую справку.
  - `/register`, вызванный внутри нужного топика, сохраняет `chat_id` и `message_thread_id` в KV (`DB`) и подтверждает привязку.
  - `/admin` отображает первый вариант админ-панели (кнопки для подключения Meta и просмотр списка зарегистрированных чатов).
  - Инлайн-кнопки панели обрабатываются без зависаний: список чатов берётся из KV, другие действия пока выводят заглушку.
- Вызовы Telegram API обёрнуты в `fetchWithTimeout`, чтобы воркер не зависал при сетевых проблемах.
- В конфигурации Wrangler (`wrangler.toml`) указаны требуемые KV-привязки, крон каждые 5 минут (для будущих задач) и настроена подробная Observability (логирование Cloudflare).
- Сценарии npm (`npm run dev`, `npm run deploy`) и GitHub Actions workflow продолжают служить для локального запуска и автодеплоя.

## Что сделать дальше
1. Заполнить реальные Namespace ID в `wrangler.toml` для `REPORTS_NAMESPACE`, `BILLING_NAMESPACE`, `LOGS_NAMESPACE`. Привязка `DB` уже настроена на боевой namespace (`c55f82210ade457c93aff4fe2ba8b007`).
2. Настроить переменные окружения в Cloudflare: `BOT_TOKEN`, `ADMIN_IDS`, `FB_APP_ID`, `FB_APP_SECRET`, `DEFAULT_TZ`, `WORKER_URL`, `FB_LONG_TOKEN` (опц.), `GS_WEBHOOK` (опц.).
3. Расширить обработчик Telegram: дописать функциональность админ-панели (`/admin`), реализовать команды `/report`, `/digest`, полноценную обработку callback-кнопок и хранение временных состояний.
4. Реализовать Meta OAuth в `/fb_cb`: обмен кода на токены, загрузка ад-аккаунтов, сохранение в KV.
5. Добавить управление проектами (KV `project:<code>`), автоотчёты, алерты и архив отчётов.
6. Сделать клиентский портал `/p/{code}?sig=...` с HTML-дашбордом и выдачей ссылок из админки.
7. По мере внедрения функциональности обновлять README подробными инструкциями по эксплуатации.

## Быстрый старт
```bash
npm install
npm run dev # локальный предпросмотр (нужны ENV и KV preview ID)
# после настройки секретов:
npm run deploy
```

Продолжайте развивать функциональность по шагам, проверяя каждое изменение локально и через деплой.
