# Targetbot — этап 1: базовый каркас воркера

Проект «CI → GitHub → Cloudflare Workers → Telegram-бот отчётов по рекламе Meta» перезапущен с чистого листа.
На первом этапе мы собираем минимально работоспособный каркас, чтобы проверить связку Git → Cloudflare → Telegram
и подготовить почву для последующих модулей (OAuth Meta, админ-панель, отчёты, алерты, клиентский портал).

## Что уже готово
- **HTTP-маршруты и Meta OAuth:** воркер обслуживает `GET /`, `GET /health`, `POST /tg`, клиентский портал `/p/{code}`, а также
  полноценный цикл авторизации Meta (`/fb_auth`, `/fb_cb`, `/fb_debug`). По завершении OAuth long-lived токен сохраняется в KV,
  обновляется кэш Meta и отправляется уведомление администраторам/в проектный чат.
- **Парсинг окружения:** токен Telegram ищется в алиасах (`BOT_TOKEN`, `TG_API_TOKEN`, `TELEGRAM_BOT_TOKEN` и т.д.), список
  администраторов берётся из `ADMIN_IDS` или по умолчанию `7623982602, 573424022`.
- **KV-абстракция:** объявлен базовый хелпер для работы с Cloudflare KV, реестр чатов сохраняется по ключу `chat:<chat_id>:<thread_id>`,
  а логи Telegram-обновлений пишутся в `LOGS_NAMESPACE` (fallback на `DB`).
- **Обработчик Telegram:** поддерживаются команды `/start`, `/help`, `/register`, `/admin`, `/pingtest`, `/cancel`. Командный реестр
  расширяем, теперь в нём живут формы редактирования KPI, расписаний, подключения проектов и OAuth.
- **Админ-панель:** отображает состояние подключения к Facebook/Meta, название аккаунта, перечень рекламных кабинетов с индикаторами
  задолженностей, блокировок и CPA по активным кампаниям, а также статус телеграм-вебхука, журналы и новые кнопки действий.
- **Meta управление:** `GET /manage/meta` возвращает кешированную сводку, параметр `refresh=1` форсирует обновление, а планировщик Cloudflare
  периодически синхронизирует данные.
- **Мастер проектов:** из админки запускается диалог `admin:project:connect`, который хранит черновик в KV, подсказывает доступные
  рекламные аккаунты и сохраняет готовый проект (чат, топик, код, таймзона, токен портала, заметки по KPI).
- **OAuth из админки:** кнопка «Авторизоваться в Facebook» создаёт защищённую сессию, выдаёт ссылку на `/fb_auth` и по завершении
  присылает подтверждение в чат и администраторам.
- **Управление вебхуком Telegram:** воркер автоматически проверяет webhook при загрузке панели и позволяет перезапустить его из инлайн-кнопки.
- **Карточки проектов:** из панели можно открыть детальный обзор проекта (финансы, кампании, KPI, расписание, алерты), сформировать экспресс-отчёт по периодам и получить подсказки по оплатам.
- **Редактор KPI и расписаний:** администратор может из Telegram настраивать цели проекта, дневной бюджет и график отправки отчётов, изменения сохраняются в KV и сразу отражаются в карточке проекта.
- **Автоотчёты и пресеты:** кнопки «Сегодня/Вчера/7 дней/Месяц» формируют живые выгрузки Meta, поддерживаются произвольные диапазоны, а планировщик Cloudflare рассылает отчёты в клиентский чат и ЛС администратора по расписанию.
- **Алерты и рекомендации:** планировщик отслеживает нулевой расход, платёжные проблемы, аномалии кампаний, усталость креативов и превышение KPI, а бот отправляет уведомления с подсказками по дальнейшим действиям.
- **Клиентский портал:** защищённая ссылка `/p/{code}?sig=...` показывает агрегаты «Сегодня/Вчера/7 дней/МТД», дату следующей оплаты, топ-кампании,
  поддерживает экспорт CSV по каждому периоду и форму обратной связи («Написать менеджеру») с доставкой сообщений в Telegram.
- **Диагностика `/health`:** возвращает наличие токена, список админов и (по флагу `?ping=telegram`) данные `getWebhookInfo`.
  Параметр `telegram_logs=1` прикладывает последние события вебхука.
- **Проверка связки:** команда `/pingtest` отправляет десять сообщений подряд через `waitUntil` — так проще убедиться, что Cloudflare принимает вебхук и Telegram получает ответы.
- **CI → секреты → Cloudflare:** GitHub Actions перед деплоем автоматически синхронизирует секреты из настроек репозитория в Secrets воркера, поэтому однажды заданные значения (`BOT_TOKEN`, `ADMIN_IDS`, `FB_APP_*` и др.) переезжают в Cloudflare без ручных действий.

## Что предстоит сделать дальше
1. Завершить мастер проектов: добавить выбор чатовых пресетов, проверку прав доступа, автозаполнение KPI и привязку расписаний при сохранении.
2. Расширить управление аккаунтами Meta: сохранять диагностическую информацию по каждому рекламному кабинету и обновлять список проектов при повторной авторизации.
3. Подготовить интеграционные проверки для OAuth, клиентского портала и форм админки (хотя бы скрипты ручного прогона или коллекцию Postman).
4. Согласовать деплой: включить автодеплой через GitHub Actions и задокументировать процедуру обновления секретов/переменных.

## План текущего этапа

1. ~~**Редактор KPI и расписаний** — добавить интерфейс редактирования целей и отправки расписаний прямо из Telegram с сохранением в KV.~~ (готово)
2. ~~**Автоматизация отчётов** — связать быстрые пресеты с реальными запросами к Meta, подготовить CSV и рассылку по выбранным чатам.~~ (готово: живые выгрузки, произвольные диапазоны, автоматическая рассылка по расписанию)
3. ~~**Алерты и рекомендации** — включить проверки нулевого расхода, платежей, аномалий и усталости креативов с журналированием действий админов.~~ (готово: уведомления отправляются в проекты и администраторам, фиксируются в KV)
4. ~~**Подготовка клиентского портала** — собрать агрегированные метрики (Сегодня/Вчера/7 дней/МТД) и кнопку «Написать менеджеру», описать подключение в документации.~~ (готово: страница с агрегатами, топ-кампании и кнопка связи)
5. ~~**Расширение клиентского портала** — добавить пояснения, экспорт в CSV и форму обратной связи для клиентов.~~ (готово: CSV-экспорт, insight-блок и форма «Написать менеджеру» с доставкой сообщений)
6. **Мастер подключения проектов** — довести диалог `admin:project:connect`: валидация, автозаполнение KPI/расписаний, проверка дубликатов, уведомления.

## Требуемые переменные окружения
| Переменная            | Назначение                              | Обязательна | Значение по умолчанию |
|-----------------------|------------------------------------------|-------------|------------------------|
| `BOT_TOKEN` / алиасы  | Токен Telegram-бота                      | да          | —                      |
| `ADMIN_IDS`           | Список администраторов через запятую     | частично    | `7623982602,573424022` |
| `DEFAULT_TZ`          | Таймзона по умолчанию (например, `Asia/Tashkent`) | рекомендуется | — |
| `WORKER_URL`          | Публичный URL воркера (для диагностики) | рекомендуется | — |
| `FB_APP_ID`           | Идентификатор Meta приложения            | планируется | — |
| `FB_APP_SECRET`       | Секрет Meta приложения                   | планируется | — |
| `META_LONG_TOKEN` / `META_ACCESS_TOKEN` | Long-lived токен пользователя/системы Meta для чтения рекламных аккаунтов | рекомендуется | — |
| `FB_GRAPH_VERSION` / `META_GRAPH_VERSION` | Версия Graph API для запросов к Meta | опционально | `v18.0` |
| `GS_WEBHOOK`          | Вебхук Google Apps Script (опционально)  | опционально | — |
| `META_MANAGE_TOKEN`   | Токен доступа к `/manage/meta`            | рекомендуется | — |
| `PORTAL_TOKEN` / `PORTAL_SIGNING_SECRET` | Общий секрет для генерации ссылок `/p/{code}?sig=...` | опционально | — |

> Секреты никогда не коммитятся в git. Используйте `wrangler secret put`, `.dev.vars`/`.env` в локальной разработке или GitHub Actions secrets.

## Как добавить ключи и токены

### Локальная разработка
1. Скопируйте шаблон `.dev.vars.example` в `.dev.vars` (Cloudflare читает его в режиме `wrangler dev`).
2. Пропишите строки в формате `KEY="value"`. Минимальный набор уже показан в шаблоне, но для удобства приведён ниже:
   ```env
   BOT_TOKEN="<токен_бота_из_@BotFather>"
   ADMIN_IDS="7623982602,573424022"
   DEFAULT_TZ="Asia/Tashkent"
   ```
3. Для запуска через Node.js или других инструментов можно задать те же значения в `.env`.

> `.dev.vars` и `.env` не коммитятся в репозиторий — убедитесь, что файлы перечислены в `.gitignore` (уже настроено).

### GitHub Actions → Cloudflare
1. В репозитории GitHub откройте **Settings → Secrets and variables → Actions** и задайте секреты: `BOT_TOKEN`, `ADMIN_IDS`,
   `DEFAULT_TZ`, `WORKER_URL`, `FB_APP_ID`, `FB_APP_SECRET`, `FB_LONG_TOKEN`/`META_LONG_TOKEN`, `GS_WEBHOOK` (по необходимости).
2. При следующем деплое workflow автоматически выполнит `wrangler secret put <KEY>` для каждого из заполненных значений и перенесёт их
   в ваш воркер Cloudflare (environment `production`).
3. После успешного шага «Sync Worker secrets from GitHub Actions» в журнале появятся сообщения `Synced secret <KEY>` для каждого ключа.

### Продуктивный воркер в Cloudflare вручную
1. Выполните `npx wrangler secret put BOT_TOKEN` и вставьте токен из @BotFather.
2. Аналогично можно добавить `ADMIN_IDS`, `DEFAULT_TZ` и другие приватные значения (`wrangler secret put <KEY>`).
3. Либо откройте Cloudflare Dashboard → Workers & Pages → нужный воркер → **Settings** → **Variables** → **Add variable/secret**.
4. После обновления секретов перезапустите деплой: `npm run deploy` или GitHub Actions.

### Проверка
1. Запустите `npm run check:config -- --ping-telegram` — скрипт найдёт токен и проверит `getMe`.
2. В браузере откройте `/health?ping=telegram` — убедитесь, что воркер видит токен и текущий webhook.
3. Отправьте в Telegram `/pingtest` — бот вернёт 10 сообщений, подтверждая доставку.

## Клиентский портал

1. Для каждого проекта задайте токен доступа в KV (например, поле `portal.token` или `client.portal.secret`). Разрешаются массивы и вложенные объекты — воркер ищет строки с ключами `token`/`secret`/`sig` и принимает их как допустимые подписи.
2. Ссылка имеет вид `https://<worker>/p/<code>?sig=<значение>`: можно использовать как сам токен, так и хеш `sha256(<code>:<token>)`. Второй вариант удобно выдавать клиентам, не раскрывая исходный секрет.
3. Дополнительно можно задать глобальный секрет через переменную окружения `PORTAL_TOKEN`/`PORTAL_SIGNING_SECRET` — он подойдёт для экспресс-доступа или отладки.
4. Параметр `refresh=1` принудительно обновит Meta-данные до рендера страницы. Остальные настройки (фильтр кампаний, таймзона) подтягиваются из проекта.

## Быстрый старт
```bash
# Установить зависимости (на проде используется npx, но локально можно сделать install)
npm install

# Проверить конфигурацию окружения (скрипт будет упрощён на следующих этапах)
npm run check:config

# Запустить dev-сервер Cloudflare Workers
npm run dev

# Деплой через Wrangler (использует wrangler.toml)
npm run deploy
```

## Проверка после деплоя
1. `GET https://<worker>/health` — убеждаемся, что `ok: true` и перечислены администраторы.
2. `GET https://<worker>/health?ping=telegram&telegram_logs=1` — видим `getWebhookInfo` и свежие события вебхука.
3. В Telegram отправляем `/start`, `/help`, `/register`, `/admin`, `/pingtest` и проверяем корректные ответы.
4. `/pingtest` должен прислать десять сообщений за десять секунд (разрешает проверить Cloudflare ↔ Telegram).

Документация будет расширяться по мере роста функциональности.
