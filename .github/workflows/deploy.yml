name: Deploy Worker

on:
  push:
    branches:
      - main
  workflow_dispatch:

jobs:
  deploy:
    runs-on: ubuntu-latest
    permissions:
      contents: read
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Install dependencies
        run: npm install

      - name: Sync Worker secrets from GitHub Actions
        env:
          BOT_TOKEN: ${{ secrets.BOT_TOKEN }}
          ADMIN_IDS: ${{ secrets.ADMIN_IDS }}
          DEFAULT_TZ: ${{ secrets.DEFAULT_TZ }}
          WORKER_URL: ${{ secrets.WORKER_URL }}
          FB_APP_ID: ${{ secrets.FB_APP_ID }}
          FB_APP_SECRET: ${{ secrets.FB_APP_SECRET }}
          FB_LONG_TOKEN: ${{ secrets.FB_LONG_TOKEN }}
          GS_WEBHOOK: ${{ secrets.GS_WEBHOOK }}
        run: |
          set -euo pipefail

          sync_secret() {
            local key="$1"
            local value="$2"
            if [ -z "$value" ]; then
              echo "Skipping $key (not provided)."
              return
            fi
            printf '%s' "$value" | npx wrangler@4.46.0 secret put "$key" --env production --config wrangler.toml >/dev/null
            echo "Synced secret $key."
          }

          sync_secret BOT_TOKEN "$BOT_TOKEN"
          sync_secret ADMIN_IDS "$ADMIN_IDS"
          sync_secret DEFAULT_TZ "$DEFAULT_TZ"
          sync_secret WORKER_URL "$WORKER_URL"
          sync_secret FB_APP_ID "$FB_APP_ID"
          sync_secret FB_APP_SECRET "$FB_APP_SECRET"
          sync_secret FB_LONG_TOKEN "$FB_LONG_TOKEN"
          sync_secret GS_WEBHOOK "$GS_WEBHOOK"

      - name: Deploy with Wrangler
        run: npm run deploy -- --env production
        env:
          CLOUDFLARE_API_TOKEN: ${{ secrets.CF_API_TOKEN }}
          CLOUDFLARE_ACCOUNT_ID: ${{ secrets.CF_ACCOUNT_ID }}
