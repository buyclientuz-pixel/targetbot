name: Deploy Worker

on:
  push:
    branches:
      - main
  workflow_dispatch:

jobs:
  deploy:
    runs-on: ubuntu-latest
    permissions:
      contents: read
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Install dependencies
        run: npm install

      - name: Sync Worker secrets from GitHub Actions
        env:
          BOT_TOKEN: ${{ secrets.BOT_TOKEN }}
          TG_API_TOKEN: ${{ secrets.TG_API_TOKEN }}
          TELEGRAM_BOT_TOKEN: ${{ secrets.TELEGRAM_BOT_TOKEN }}
          ADMIN_IDS: ${{ secrets.ADMIN_IDS }}
          DEFAULT_TZ: ${{ secrets.DEFAULT_TZ }}
          WORKER_URL: ${{ secrets.WORKER_URL }}
          FB_APP_ID: ${{ secrets.FB_APP_ID }}
          FB_APP_SECRET: ${{ secrets.FB_APP_SECRET }}
          FB_LONG_TOKEN: ${{ secrets.FB_LONG_TOKEN }}
          META_LONG_TOKEN: ${{ secrets.META_LONG_TOKEN }}
          META_MANAGE_TOKEN: ${{ secrets.META_MANAGE_TOKEN }}
          FB_MANAGE_TOKEN: ${{ secrets.FB_MANAGE_TOKEN }}
          PORTAL_TOKEN: ${{ secrets.PORTAL_TOKEN }}
          PORTAL_SIGNING_SECRET: ${{ secrets.PORTAL_SIGNING_SECRET }}
          GS_WEBHOOK: ${{ secrets.GS_WEBHOOK }}
          PROJECT_MANAGER_IDS: ${{ secrets.PROJECT_MANAGER_IDS }}
          PROJECT_MANAGERS: ${{ secrets.PROJECT_MANAGERS }}
          PROJECT_ACCOUNT_ACCESS: ${{ secrets.PROJECT_ACCOUNT_ACCESS }}
          PROJECT_ACCOUNT_ALLOWLIST: ${{ secrets.PROJECT_ACCOUNT_ALLOWLIST }}
          PROJECT_CHAT_PRESETS: ${{ secrets.PROJECT_CHAT_PRESETS }}
          PROJECT_CHAT_TEMPLATES: ${{ secrets.PROJECT_CHAT_TEMPLATES }}
          CHAT_PRESETS: ${{ secrets.CHAT_PRESETS }}
        run: npm run sync:secrets -- --env production

      - name: Deploy with Wrangler
        run: npm run deploy -- --env production
        env:
          CLOUDFLARE_API_TOKEN: ${{ secrets.CF_API_TOKEN }}
          CLOUDFLARE_ACCOUNT_ID: ${{ secrets.CF_ACCOUNT_ID }}
