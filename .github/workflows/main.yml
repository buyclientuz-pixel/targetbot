name: Deploy Worker

on:
  push:
    branches: [ main ]

jobs:
  deploy:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-node@v4
        with:
          node-version: '22'

      - name: Install
        run: npm ci

      - name: Check config
        run: npm run check:config
        env:
          BOT_TOKEN:             ${{ secrets.BOT_TOKEN }}
          ADMIN_IDS:             ${{ secrets.ADMIN_IDS }}
          DEFAULT_TZ:            ${{ secrets.DEFAULT_TZ }}
          FB_APP_ID:             ${{ secrets.FB_APP_ID }}
          FB_APP_SECRET:         ${{ secrets.FB_APP_SECRET }}
          FB_LONG_TOKEN:         ${{ secrets.FB_LONG_TOKEN }}
          WORKER_URL:            ${{ secrets.WORKER_URL }}
          CLOUDFLARE_API_TOKEN:  ${{ secrets.CF_API_TOKEN }}
          CLOUDFLARE_ACCOUNT_ID: ${{ secrets.CF_ACCOUNT_ID }}

      - name: Deploy (wrangler versions upload)
        run: npx wrangler versions upload
        env:
          CLOUDFLARE_API_TOKEN:  ${{ secrets.CF_API_TOKEN }}
          CLOUDFLARE_ACCOUNT_ID: ${{ secrets.CF_ACCOUNT_ID }}
          # если скрипт тоже читает их — оставь те же ENV, что выше
          BOT_TOKEN:             ${{ secrets.BOT_TOKEN }}
          ADMIN_IDS:             ${{ secrets.ADMIN_IDS }}
          DEFAULT_TZ:            ${{ secrets.DEFAULT_TZ }}
          FB_APP_ID:             ${{ secrets.FB_APP_ID }}
          FB_APP_SECRET:         ${{ secrets.FB_APP_SECRET }}
          FB_LONG_TOKEN:         ${{ secrets.FB_LONG_TOKEN }}
          WORKER_URL:            ${{ secrets.WORKER_URL }}
